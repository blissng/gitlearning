/*

This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.
*/
var joint={version:"0.9.3",dia:{},ui:{},layout:{},shapes:{},format:{},connectors:{},routers:{},util:{hashCode:function(k){var l=0;if(0==k.length)return l;for(var m=0;m<k.length;m++)var n=k.charCodeAt(m),l=(l<<5)-l+n,l=l&l;return l},getByPath:function(k,l,m){for(l=l.split(m||".");l.length;)if(m=l.shift(),Object(k)===k&&m in k)k=k[m];else return;return k},setByPath:function(k,l,m,n){n=n||".";var p=l.split(n),q=k,r=0;if(-1<l.indexOf(n)){for(l=p.length;r<l-1;r++)q=q[p[r]]||(q[p[r]]={});q[p[l-1]]=m}else k[l]=
m;return k},unsetByPath:function(k,l,m){m=m||".";var n=l.lastIndexOf(m);-1<n?(m=joint.util.getByPath(k,l.substr(0,n),m))&&delete m[l.slice(n+1)]:delete k[l];return k},flattenObject:function(k,l,m){l=l||".";var n={},p;for(p in k)if(k.hasOwnProperty(p)){var q="object"===typeof k[p];q&&(m&&m(k[p]))&&(q=!1);if(q){var q=this.flattenObject(k[p],l,m),r;for(r in q)q.hasOwnProperty(r)&&(n[p+l+r]=q[r])}else n[p]=k[p]}return n},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(k){var l=
16*Math.random()|0;return("x"==k?l:l&3|8).toString(16)})},guid:function(k){this.guid.id=this.guid.id||1;k.id=void 0===k.id?"j_"+this.guid.id++:k.id;return k.id},mixin:function(){for(var k=arguments[0],l=1,m=arguments.length;l<m;l++){var n=arguments[l];Object(n)!==n&&!_.isFunction(n)&&(null===n||void 0===n)||_.each(n,function(l,m){if(this.mixin.deep&&Object(l)===l)k[m]||(k[m]=_.isArray(l)?[]:{}),this.mixin(k[m],l);else if(k[m]!==l&&(!this.mixin.supplement||!k.hasOwnProperty(m)))k[m]=l},this)}return k},
supplement:function(){this.mixin.supplement=!0;var k=this.mixin.apply(this,arguments);this.mixin.supplement=!1;return k},deepMixin:function(){this.mixin.deep=!0;var k=this.mixin.apply(this,arguments);this.mixin.deep=!1;return k},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=!0;var k=this.mixin.apply(this,arguments);this.mixin.deep=this.mixin.supplement=!1;return k},normalizeEvent:function(k){return k.originalEvent&&k.originalEvent.changedTouches&&k.originalEvent.changedTouches.length?
k.originalEvent.changedTouches[0]:k},nextFrame:function(){var k,l="undefined"!=typeof window;l&&(k=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame);if(!k){var m=0;k=function(k){var l=(new Date).getTime(),q=Math.max(0,16-(l-m)),r=setTimeout(function(){k(l+q)},q);m=l+q;return r}}return l?_.bind(k,window):k}(),cancelFrame:function(){var k,l="undefined"!=typeof window;l&&(k=window.cancelAnimationFrame||
window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame);k=k||clearTimeout;return l?_.bind(k,window):k}(),shapePerimeterConnectionPoint:function(k,l,m,n){var p;if(!m){var q=l.$(".scalable")[0],r=l.$(".rotatable")[0],s=l.$(".body")[0],t=l.$(".connection")[0];q&&q.firstChild?
m=q.firstChild:r&&r.firstChild?m=r.firstChild:s?m=s:t&&(m=t)}m?(l=V(m).findIntersection(n,k.paper.viewport))||(p=g.rect(V(m).bbox(!1,k.paper.viewport))):(p=l.model.getBBox(),l=p.intersectionWithLineFromCenterToPoint(n));return l||p.center()},breakText:function(k,l,m,n){n=n||{};var p=l.width;l=l.height;var q=n.svgDocument||V("svg").node;m=V("<text><tspan></tspan></text>").attr(m||{}).node;var r=m.firstChild,s=document.createTextNode("");r.appendChild(s);q.appendChild(m);n.svgDocument||document.body.appendChild(q);
k=k.split(" ");for(var t=[],z=[],v,u=0,w=0,A=k.length;u<A;u++){var D=k[u];s.data=z[w]?z[w]+" "+D:D;if(r.getComputedTextLength()<=p)z[w]=s.data,v&&(t[w++]=!0,v=0);else{if(!z[w]||v){var B=!!v;v=D.length-1;if(B||!v){if(!v){if(!z[w]){z=[];break}k.splice(u,2,D+k[u+1]);A--;t[w++]=!0;u--;continue}k[u]=D.substring(0,v);k[u+1]=D.substring(v)+k[u+1]}else k.splice(u,1,D.substring(0,v),D.substring(v)),A++,w&&!t[w-1]&&w--;u--;continue}w++;u--}if("undefined"!==typeof l){var F=F||1.25*m.getBBox().height;if(F*z.length>
l){z.splice(Math.floor(l/F));break}}}n.svgDocument?q.removeChild(m):document.body.removeChild(q);return z.join("\n")},imageToDataUri:function(k,l){if(!k||"data:"===k.substr(0,5))return setTimeout(function(){l(null,k)},0);var m=document.createElement("canvas"),n=document.createElement("img");n.onload=function(){var p=m.getContext("2d");m.width=n.width;m.height=n.height;p.drawImage(n,0,0);try{var q=k.split(".").pop()||"png",r=m.toDataURL("image/"+("jpg"===q)?"jpeg":q)}catch(s){if(/\.svg$/.test(k))return p=
window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),p.open("GET",k,!1),p.send(null),l(null,"data:image/svg+xml,"+encodeURIComponent(p.responseText));console.error(n.src,"fails to convert",s)}l(null,r)};n.ononerror=function(){l(Error("Failed to load image."))};n.src=k},timing:{linear:function(k){return k},quad:function(k){return k*k},cubic:function(k){return k*k*k},inout:function(k){if(0>=k)return 0;if(1<=k)return 1;var l=k*k,m=l*k;return 4*(0.5>k?m:3*(k-l)+m-0.75)},exponential:function(k){return Math.pow(2,
10*(k-1))},bounce:function(k){for(var l=0,m=1;;l+=m,m/=2)if(k>=(7-4*l)/11)return k=(11-6*l-11*k)/4,-k*k+m*m},reverse:function(k){return function(l){return 1-k(1-l)}},reflect:function(k){return function(l){return 0.5*(0.5>l?k(2*l):2-k(2-2*l))}},clamp:function(k,l,m){l=l||0;m=m||1;return function(n){n=k(n);return n<l?l:n>m?m:n}},back:function(k){k||(k=1.70158);return function(l){return l*l*((k+1)*l-k)}},elastic:function(k){k||(k=1.5);return function(l){return Math.pow(2,10*(l-1))*Math.cos(20*Math.PI*
k/3*l)}}},interpolate:{number:function(k,l){var m=l-k;return function(l){return k+m*l}},object:function(k,l){var m=_.keys(k);return function(n){var p,q,r={};for(p=m.length-1;-1!=p;p--)q=m[p],r[q]=k[q]+(l[q]-k[q])*n;return r}},hexColor:function(k,l){var m=parseInt(k.slice(1),16),n=parseInt(l.slice(1),16),p=m&255,q=(n&255)-p,r=m&65280,s=(n&65280)-r,t=m&16711680,z=(n&16711680)-t;return function(k){return"#"+(16777216|p+q*k&255|r+s*k&65280|t+z*k&16711680).toString(16).slice(1)}},unit:function(k,l){var m=
/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/,n=m.exec(k),m=m.exec(l),p=m[1].indexOf("."),q=0<p?m[1].length-p-1:0;k=+n[1];var r=+m[1]-k,s=n[2];return function(l){return(k+r*l).toFixed(q)+s}}},filter:{blur:function(k){var l=_.isFinite(k.x)?k.x:2;return joint.templates.blurFilter({stdDeviation:_.isFinite(k.y)?[l,k.y]:l})},dropShadow:function(k){return("SVGFEDropShadowElement"in window?joint.templates.dropShadow:joint.templates.guassianDropShadow)({dx:k.dx||0,dy:k.dy||0,opacity:_.isFinite(k.opacity)?k.opacity:
1,color:k.color||"black",blur:_.isFinite(k.blur)?k.blur:4})},grayscale:function(k){k=_.isFinite(k.amount)?k.amount:1;return joint.templates.grayScale({a:0.2126+0.7874*(1-k),b:0.7152-0.7152*(1-k),c:0.0722-0.0722*(1-k),d:0.2126-0.2126*(1-k),e:0.7152+0.2848*(1-k),f:0.0722-0.0722*(1-k),g:0.2126-0.2126*(1-k),h:0.0722+0.9278*(1-k)})},sepia:function(k){k=_.isFinite(k.amount)?k.amount:1;return joint.templates.sepia({a:0.393+0.607*(1-k),b:0.769-0.769*(1-k),c:0.189-0.189*(1-k),d:0.349-0.349*(1-k),e:0.686+0.314*
(1-k),f:0.168-0.168*(1-k),g:0.272-0.272*(1-k),h:0.534-0.534*(1-k),i:0.131+0.869*(1-k)})},saturate:function(k){k=_.isFinite(k.amount)?k.amount:1;return joint.templates.saturate({amount:1-k})},hueRotate:function(k){return joint.templates.hueRotate({angle:k.angle||0})},invert:function(k){k=_.isFinite(k.amount)?k.amount:1;return joint.templates.invert({amount:k,amount2:1-k})},brightness:function(k){return joint.templates.brightness({amount:_.isFinite(k.amount)?k.amount:1})},contrast:function(k){k=_.isFinite(k.amount)?
k.amount:1;return joint.templates.contrast({amount:k,amount2:0.5-k/2})}},format:{number:function(k,l,m){function n(k){for(var l=k.length,n=[],p=0,q=m.grouping[0];0<l&&0<q;)n.push(k.substring(l-=q,l+q)),q=m.grouping[p=(p+1)%m.grouping.length];return n.reverse().join(m.thousands)}m=m||{currency:["$",""],decimal:".",thousands:",",grouping:[3]};var p=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i.exec(k),q=p[1]||" ";k=p[2]||">";var r=p[3]||"",s=p[4]||"",t=p[5],z=+p[6],v=p[7],
u=p[8],w=p[9],A=1,D=p="",B=!1;u&&(u=+u.substring(1));if(t||"0"===q&&"="===k)t=q="0",k="=",v&&(z-=Math.floor((z-1)/4));switch(w){case "n":v=!0;w="g";break;case "%":A=100;D="%";w="f";break;case "p":A=100;D="%";w="r";break;case "b":case "o":case "x":case "X":"#"===s&&(p="0"+w.toLowerCase());case "c":case "d":B=!0;u=0;break;case "s":A=-1,w="r"}"$"===s&&(p=m.currency[0],D=m.currency[1]);"r"==w&&!u&&(w="g");if(null!=u)if("g"==w)u=Math.max(1,Math.min(21,u));else if("e"==w||"f"==w)u=Math.max(0,Math.min(20,
u));s=t&&v;if(B&&l%1)return"";r=0>l||0===l&&0>1/l?(l=-l,"-"):r;B=D;0>A?(B=this.prefix(l,u),l=B.scale(l),B=B.symbol+D):l*=A;l=this.convert(w,l,u);w=l.lastIndexOf(".");u=0>w?l:l.substring(0,w);l=0>w?"":m.decimal+l.substring(w+1);!t&&(v&&m.grouping)&&(u=n(u));t=p.length+u.length+l.length+(s?0:r.length);q=t<z?Array(t=z-t+1).join(q):"";s&&(u=n(q+u));r+=p;l=u+l;return("<"===k?r+l+q:">"===k?q+r+l:"^"===k?q.substring(0,t>>=1)+r+l+q.substring(t):r+(s?l:q+l))+B},string:function(k,l){var m;m="{";for(var n=!1,
p=[];-1!==(m=k.indexOf(m));){var q,r,s;q=k.slice(0,m);if(n){r=q.split(":");s=r.shift().split(".");q=l;for(var t=0;t<s.length;t++)q=q[s[t]];r.length&&(q=this.number(r,q))}p.push(q);k=k.slice(m+1);m=(n=!n)?"}":"{"}p.push(k);return p.join("")},convert:function(k,l,m){switch(k){case "b":return l.toString(2);case "c":return String.fromCharCode(l);case "o":return l.toString(8);case "x":return l.toString(16);case "X":return l.toString(16).toUpperCase();case "g":return l.toPrecision(m);case "e":return l.toExponential(m);
case "f":return l.toFixed(m);case "r":return(l=this.round(l,this.precision(l,m))).toFixed(Math.max(0,Math.min(20,this.precision(l*(1+1E-15),m))));default:return l+""}},round:function(k,l){return l?Math.round(k*(l=Math.pow(10,l)))/l:Math.round(k)},precision:function(k,l){return l-(k?Math.ceil(Math.log(k)/Math.LN10):1)},prefix:function(k,l){var m=_.map("y z a f p n \u00b5 m  k M G T P E Z Y".split(" "),function(k,l){var m=Math.pow(10,3*abs(8-l));return{scale:8<l?function(k){return k/m}:function(k){return k*
m},symbol:k}}),n=0;k&&(0>k&&(k*=-1),l&&(k=this.round(k,this.precision(k,l))),n=1+Math.floor(1E-12+Math.log(k)/Math.LN10),n=Math.max(-24,Math.min(24,3*Math.floor((0>=n?n+1:n-1)/3))));return m[8+n/3]}}}};this.joint=this.joint||{};this.joint.templates=this.joint.templates||{};
this.joint.templates.arrowheadMarkup=function(k){k||(k={});var l;with(k)k=""+('<g class="marker-arrowhead-group marker-arrowhead-group-'+(null==(l=end)?"":l)+'"><path class="marker-arrowhead" end="'+(null==(l=end)?"":l)+'" d="M 26 0 L 0 13 L 26 26 z" /></g>');return k};this.joint.templates.blurFilter=function(k){k||(k={});var l;with(k)k=""+('<filter><feGaussianBlur stdDeviation="'+(null==(l=stdDeviation)?"":l)+'"/></filter>');return k};
this.joint.templates.brightness=function(k){k||(k={});var l;with(k)k=""+('<filter><feComponentTransfer><feFuncR type="table" tableValues="'+(null==(l=amount)?"":l)+" "+(null==(l=amount2)?"":l)+'"/><feFuncG type="table" tableValues="'+(null==(l=amount)?"":l)+" "+(null==(l=amount2)?"":l)+'"/><feFuncB type="table" tableValues="'+(null==(l=amount)?"":l)+" "+(null==(l=amount2)?"":l)+'"/></feComponentTransfer></filter>');return k};
this.joint.templates.contrast=function(k){k||(k={});var l;with(k)k=""+('<filter><feComponentTransfer><feFuncR type="linear" slope="'+(null==(l=amount)?"":l)+'" intercept="'+(null==(l=amount2)?"":l)+'"/><feFuncG type="linear" slope="'+(null==(l=amount)?"":l)+'" intercept="'+(null==(l=amount2)?"":l)+'"/><feFuncB type="linear" slope="'+(null==(l=amount)?"":l)+'" intercept="'+(null==(l=amount2)?"":l)+'"/></feComponentTransfer></filter>');return k};
this.joint.templates.dropShadow=function(k){k||(k={});var l;with(k)k=""+('<filter><feDropShadow stdDeviation="'+(null==(l=blur)?"":l)+'" dx="'+(null==(l=dx)?"":l)+'" dy="'+(null==(l=dy)?"":l)+'" flood-color="'+(null==(l=color)?"":l)+'" flood-opacity="'+(null==(l=opacity)?"":l)+'"/></filter>');return k};
this.joint.templates.grayScale=function(k){k||(k={});var l;with(k)k=""+('<filter><feColorMatrix type="matrix" values="'+(null==(l=a)?"":l)+" "+(null==(l=b)?"":l)+" "+(null==(l=c)?"":l)+" 0 0 "+(null==(l=d)?"":l)+" "+(null==(l=e)?"":l)+" "+(null==(l=f)?"":l)+" 0 0 "+(null==(l=g)?"":l)+" "+(null==(l=b)?"":l)+" "+(null==(l=h)?"":l)+' 0 0 0 0 0 1 0"/></filter>');return k};
this.joint.templates.guassianDropShadow=function(k){k||(k={});var l;with(k)k=""+('<filter><feGaussianBlur in="SourceAlpha" stdDeviation="'+(null==(l=blur)?"":l)+'"/><feOffset dx="'+(null==(l=dx)?"":l)+'" dy="'+(null==(l=dy)?"":l)+'" result="offsetblur"/><feFlood flood-color="'+(null==(l=color)?"":l)+'"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="'+(null==(l=opacity)?"":l)+'"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>');
return k};this.joint.templates.hueRotate=function(k){k||(k={});var l;with(k)k=""+('<filter><feColorMatrix type="matrix" values="'+(null==(l=a)?"":l)+" "+(null==(l=b)?"":l)+" "+(null==(l=c)?"":l)+" 0 0 "+(null==(l=d)?"":l)+" "+(null==(l=e)?"":l)+" "+(null==(l=f)?"":l)+" 0 0 "+(null==(l=g)?"":l)+" "+(null==(l=h)?"":l)+" "+(null==(l=i)?"":l)+' 0 0 0 0 0 1 0"/></filter>');return k};
this.joint.templates.invert=function(k){k||(k={});var l;with(k)k=""+('<filter><feComponentTransfer><feFuncR type="table" tableValues="'+(null==(l=amount)?"":l)+" "+(null==(l=amount2)?"":l)+'"/><feFuncG type="table" tableValues="'+(null==(l=amount)?"":l)+" "+(null==(l=amount2)?"":l)+'"/><feFuncB type="table" tableValues="'+(null==(l=amount)?"":l)+" "+(null==(l=amount2)?"":l)+'"/></feComponentTransfer></filter>');return k};this.joint.templates.labelMarkup=function(k){k||(k={});with(k);return'<g class="label"><rect /><text /></g>'};
this.joint.templates.markup=function(k){k||(k={});with(k);return'<path class="connection" stroke="black"/><path class="marker-source" fill="black" stroke="black" /><path class="marker-target" fill="black" stroke="black" /><path class="connection-wrap"/><g class="labels"/><g class="marker-vertices"/><g class="marker-arrowheads"/><g class="link-tools"/>'};
this.joint.templates.saturate=function(k){k||(k={});var l;with(k)k=""+('<filter><feColorMatrix type="matrix" values="'+(null==(l=a)?"":l)+" "+(null==(l=b)?"":l)+" "+(null==(l=c)?"":l)+" 0 0 "+(null==(l=d)?"":l)+" "+(null==(l=e)?"":l)+" "+(null==(l=f)?"":l)+" 0 0 "+(null==(l=g)?"":l)+" "+(null==(l=h)?"":l)+" "+(null==(l=i)?"":l)+' 0 0 0 0 0 1 0"/></filter>');return k};
this.joint.templates.sepia=function(k){k||(k={});var l;with(k)k=""+('<filter><feColorMatrix type="matrix" values="'+(null==(l=a)?"":l)+" "+(null==(l=b)?"":l)+" "+(null==(l=c)?"":l)+" 0 0 "+(null==(l=d)?"":l)+" "+(null==(l=e)?"":l)+" "+(null==(l=f)?"":l)+" 0 0 "+(null==(l=g)?"":l)+" "+(null==(l=h)?"":l)+" "+(null==(l=i)?"":l)+' 0 0 0 0 0 1 0"/></filter>');return k};this.joint.templates.toolMarkup=function(k){k||(k={});with(k);return'<g class="link-tool"><g class="tool-remove" event="link:confirmremove"><circle r="11" /><path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/><title>Remove link.</title></g><g class="tool-options" event="link:options"><circle r="11" transform="translate(25)"/><path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/><title>Link options.</title></g></g>'};
this.joint.templates.vertextMarkup=function(k){k||(k={});var l;with(k)k=""+('<g class="marker-vertex-group" transform="translate('+(null==(l=x)?"":l)+", "+(null==(l=y)?"":l)+')"><circle class="marker-vertex" idx="'+(null==(l=idx)?"":l)+'" r="10" /><path class="marker-vertex-remove-area" idx="'+(null==(l=idx)?"":l)+'" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/><path class="marker-vertex-remove" idx="'+
(null==(l=idx)?"":l)+'" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"><title>Remove vertex.</title></path></g>');return k};
joint.dia.GraphCells=Backbone.Collection.extend({initialize:function(){this.on("change:z",this.sort,this)},model:function(k,l){if("link"===k.type)return new joint.dia.Link(k,l);var m=k.type.split(".")[0],n=k.type.split(".")[1];return joint.shapes[m]&&joint.shapes[m][n]?new joint.shapes[m][n](k,l):new joint.dia.Element(k,l)},comparator:function(k){return k.get("z")||0},getConnectedLinks:function(k,l){l=l||{};_.isUndefined(l.inbound)&&_.isUndefined(l.outbound)&&(l.inbound=l.outbound=!0);var m=this.filter(function(m){var n=
m.get("source");m=m.get("target");return n&&n.id===k.id&&l.outbound||m&&m.id===k.id&&l.inbound});if(l.deep){var n=k.getEmbeddedCells({deep:!0});_.each(this.difference(m,n),function(k){if(l.outbound){var q=k.get("source");if(q&&q.id&&_.find(n,{id:q.id})){m.push(k);return}}l.inbound&&(q=k.get("target"))&&(q.id&&_.find(n,{id:q.id}))&&m.push(k)})}return m},getCommonAncestor:function(){var k=_.map(arguments,function(k){var l=[k.id];for(k=k.get("parent");k;)l.push(k),k=this.get(k).get("parent");return l},
this),k=_.sortBy(k,"length"),l=_.find(k.shift(),function(l){return _.every(k,function(k){return _.contains(k,l)})});return this.get(l)}});
joint.dia.Graph=Backbone.Model.extend({initialize:function(k,l){this.set("cells",new joint.dia.GraphCells([],{model:l&&l.cellModel}));this.get("cells").on("all",this.trigger,this);this.get("cells").on("remove",this.removeCell,this)},toJSON:function(){var k=Backbone.Model.prototype.toJSON.apply(this,arguments);k.cells=this.get("cells").toJSON();return k},fromJSON:function(k,l){if(!k.cells)throw Error("Graph JSON must contain cells array.");this.set(_.omit(k,"cells"),l);this.resetCells(k.cells,l)},
clear:function(k){this.trigger("batch:start");this.get("cells").remove(this.get("cells").models,k);this.trigger("batch:stop")},_prepareCell:function(k){k instanceof Backbone.Model&&_.isUndefined(k.get("z"))?k.set("z",this.maxZIndex()+1,{silent:!0}):_.isUndefined(k.z)&&(k.z=this.maxZIndex()+1);return k},maxZIndex:function(){var k=this.get("cells").last();return k?k.get("z")||0:0},addCell:function(k,l){if(_.isArray(k))return this.addCells(k,l);this.get("cells").add(this._prepareCell(k),l||{});return this},
addCells:function(k,l){l=l||{};l.position=k.length;_.each(k,function(k){l.position--;this.addCell(k,l)},this);return this},resetCells:function(k,l){this.get("cells").reset(_.map(k,this._prepareCell,this),l);return this},removeCell:function(k,l,m){m&&m.disconnectLinks?this.disconnectLinks(k,m):this.removeLinks(k,m);this.get("cells").remove(k,{silent:!0})},getCell:function(k){return this.get("cells").get(k)},getElements:function(){return this.get("cells").filter(function(k){return k instanceof joint.dia.Element})},
getLinks:function(){return this.get("cells").filter(function(k){return k instanceof joint.dia.Link})},getConnectedLinks:function(k,l){return this.get("cells").getConnectedLinks(k,l)},getNeighbors:function(k){var l=this.getConnectedLinks(k),m=[],n=this.get("cells");_.each(l,function(l){var q=l.get("source");l=l.get("target");q.x||(q=n.get(q.id),q!==k&&m.push(q));l.x||(q=n.get(l.id),q!==k&&m.push(q))});return m},disconnectLinks:function(k,l){_.each(this.getConnectedLinks(k),function(m){m.set(m.get("source").id===
k.id?"source":"target",g.point(0,0),l)})},removeLinks:function(k,l){_.invoke(this.getConnectedLinks(k),"remove",l)},findModelsFromPoint:function(k){return _.filter(this.getElements(),function(l){return l.getBBox().containsPoint(k)})},findModelsInArea:function(k){return _.filter(this.getElements(),function(l){return l.getBBox().intersect(k)})},getBBox:function(k){var l=Infinity,m=Infinity,n=0,p=0;_.each(k,function(k){k=k.getBBox();l=Math.min(l,k.x);m=Math.min(m,k.y);n=Math.max(n,k.x+k.width);p=Math.max(p,
k.y+k.height)});return g.rect(l,m,n-l,p-m)},getCommonAncestor:function(){var k=this.get("cells");return k.getCommonAncestor.apply(k,arguments)}});
joint.dia.Cell=Backbone.Model.extend({constructor:function(k,l){var m,n=k||{};this.cid=_.uniqueId("c");this.attributes={};l&&l.collection&&(this.collection=l.collection);l&&l.parse&&(n=this.parse(n,l)||{});if(m=_.result(this,"defaults"))n=_.merge({},m,n);this.set(n,l);this.changed={};this.initialize.apply(this,arguments)},toJSON:function(){var k=this.constructor.prototype.defaults.attrs||{},l={};_.each(this.attributes.attrs,function(m,p){var q=k[p];_.each(m,function(k,m){if(_.isObject(k)&&!_.isArray(k))_.each(k,
function(k,n){if(!q||!q[m]||!_.isEqual(q[m][n],k))l[p]=l[p]||{},(l[p][m]||(l[p][m]={}))[n]=k});else if(!q||!_.isEqual(q[m],k))l[p]=l[p]||{},l[p][m]=k})});var m=_.cloneDeep(_.omit(this.attributes,"attrs"));m.attrs=l;return m},initialize:function(k){(!k||!k.id)&&this.set("id",joint.util.uuid(),{silent:!0});this._transitionIds={};this.processPorts();this.on("change:attrs",this.processPorts,this)},processPorts:function(){var k=this.ports,l={};_.each(this.get("attrs"),function(k,m){k&&k.port&&(_.isUndefined(k.port.id)?
l[k.port]={id:k.port}:l[k.port.id]=k.port)});var m={};_.each(k,function(k,p){l[p]||(m[p]=!0)});this.collection&&!_.isEmpty(m)&&(k=this.collection.getConnectedLinks(this,{inbound:!0}),_.each(k,function(k){m[k.get("target").port]&&k.remove()}),k=this.collection.getConnectedLinks(this,{outbound:!0}),_.each(k,function(k){m[k.get("source").port]&&k.remove()}));this.ports=l},remove:function(k){k=k||{};var l=this.collection;l&&l.trigger("batch:start",{batchName:"remove"});var m=this.get("parent");m&&(this.collection&&
this.collection.get(m)).unembed(this);_.invoke(this.getEmbeddedCells(),"remove",k);this.trigger("remove",this,this.collection,k);l&&l.trigger("batch:stop",{batchName:"remove"});return this},toFront:function(k){if(this.collection){k=k||{};var l=(this.collection.last().get("z")||0)+1;this.trigger("batch:start",{batchName:"to-front"}).set("z",l,k);if(k.deep){var m=this.getEmbeddedCells({deep:!0,breadthFirst:!0});_.each(m,function(m){m.set("z",++l,k)})}this.trigger("batch:stop",{batchName:"to-front"})}return this},
toBack:function(k){if(this.collection){k=k||{};var l=(this.collection.first().get("z")||0)-1;this.trigger("batch:start",{batchName:"to-back"});if(k.deep){var m=this.getEmbeddedCells({deep:!0,breadthFirst:!0});_.eachRight(m,function(m){m.set("z",l--,k)})}this.set("z",l,k).trigger("batch:stop",{batchName:"to-back"})}return this},embed:function(k,l){if(this==k||this.isEmbeddedIn(k))throw Error("Recursive embedding not allowed.");this.trigger("batch:start",{batchName:"embed"});var m=_.clone(this.get("embeds")||
[]);m[k.isLink()?"unshift":"push"](k.id);k.set("parent",this.id,l);this.set("embeds",_.uniq(m),l);this.trigger("batch:stop",{batchName:"embed"});return this},unembed:function(k,l){this.trigger("batch:start",{batchName:"unembed"});k.unset("parent",l);this.set("embeds",_.without(this.get("embeds"),k.id),l);this.trigger("batch:stop",{batchName:"unembed"});return this},getAncestors:function(){var k=[],l=this.get("parent");if(void 0===this.collection)return k;for(;void 0!==l;)if(l=this.collection.get(l),
void 0!==l)k.push(l),l=l.get("parent");else break;return k},getEmbeddedCells:function(k){k=k||{};if(this.collection){var l;if(k.deep)if(k.breadthFirst){l=[];for(var m=this.getEmbeddedCells();0<m.length;){var n=m.shift();l.push(n);m.push.apply(m,n.getEmbeddedCells())}}else l=this.getEmbeddedCells(),_.each(l,function(m){l.push.apply(l,m.getEmbeddedCells(k))});else l=_.map(this.get("embeds"),this.collection.get,this.collection);return l}return[]},isEmbeddedIn:function(k,l){var m=_.isString(k)?k:k.id,
n=this.get("parent");l=_.defaults({deep:!0},l);if(this.collection&&l.deep){for(;n;){if(n==m)return!0;n=this.collection.get(n).get("parent")}return!1}return n==m},clone:function(k){k=k||{};var l=Backbone.Model.prototype.clone.apply(this,arguments);l.set("id",joint.util.uuid(),{silent:!0});l.set("embeds","");if(!k.deep)return l;var m=_.sortBy(this.getEmbeddedCells(),function(k){return k instanceof joint.dia.Element}),n=[l],p={};_.each(m,function(k){var m=k.clone({deep:!0});l.embed(m[0]);_.each(m,function(m){if(m instanceof
joint.dia.Link)m.get("source").id==this.id&&m.prop("source",{id:l.id}),m.get("target").id==this.id&&m.prop("target",{id:l.id}),p[k.id]=m;else{n.push(m);var r=this.collection.getConnectedLinks(k,{inbound:!0});_.each(r,function(k){var l=p[k.id]||k.clone();p[k.id]=l;l.prop("target",{id:m.id})});r=this.collection.getConnectedLinks(k,{outbound:!0});_.each(r,function(k){var l=p[k.id]||k.clone();p[k.id]=l;l.prop("source",{id:m.id})})}},this)},this);return n=n.concat(_.values(p))},prop:function(k,l,m){if(_.isString(k)){if(1<
arguments.length){var n=k.split("/"),p=n[0];m=m||{};m.propertyPath=k;m.propertyValue=l;if(1==n.length)return this.set(p,l,m);var q={},r=q,s=p;_.each(_.rest(n),function(k){r=r[s]=_.isFinite(Number(k))?[]:{};s=k});q=joint.util.setByPath(q,k,l,"/");n=_.merge({},this.attributes);m.rewrite&&joint.util.unsetByPath(n,k,"/");q=_.merge(n,q);return this.set(p,q[p],m)}return joint.util.getByPath(this.attributes,k,"/")}return this.set(_.merge({},this.attributes,k),l)},removeProp:function(k,l){l=l||{};l.dirty=
!0;var m=k.split("/");if(1===m.length)return this.unset(k,l);var n=m[0],m=m.slice(1).join("/"),p=_.merge({},this.get(n));joint.util.unsetByPath(p,m,"/");return this.set(n,p,l)},attr:function(k,l,m){var n=Array.prototype.slice.call(arguments);_.isString(k)?n[0]="attrs/"+k:n[0]={attrs:k};return this.prop.apply(this,n)},removeAttr:function(k,l){return _.isArray(k)?(_.each(k,function(k){this.removeAttr(k,l)},this),this):this.removeProp("attrs/"+k,l)},transition:function(k,l,m,n){n=n||"/";m=_.extend({duration:100,
delay:10,timingFunction:joint.util.timing.linear,valueFunction:joint.util.interpolate.number},m);var p=0,q,r=_.bind(function(l){var n;p=p||l;l-=p;l/=m.duration;1>l?this._transitionIds[k]=n=joint.util.nextFrame(r):(l=1,delete this._transitionIds[k]);l=q(m.timingFunction(l));m.transitionId=n;this.prop(k,l,m);n||this.trigger("transition:end",this,k)},this),s=_.bind(function(p){this.stopTransitions(k);q=m.valueFunction(joint.util.getByPath(this.attributes,k,n),l);this._transitionIds[k]=joint.util.nextFrame(p);
this.trigger("transition:start",this,k)},this);return _.delay(s,m.delay,r)},getTransitions:function(){return _.keys(this._transitionIds)},stopTransitions:function(k,l){l=l||"/";var m=k&&k.split(l);_(this._transitionIds).keys().filter(m&&function(k){return _.isEqual(m,k.split(l).slice(0,m.length))}).each(function(k){joint.util.cancelFrame(this._transitionIds[k]);delete this._transitionIds[k];this.trigger("transition:end",this,k)},this);return this},addTo:function(k,l){k.addCell(this,l);return this},
findView:function(k){return k.findViewByModel(this)},isLink:function(){return!1}});
joint.dia.CellView=Backbone.View.extend({tagName:"g",attributes:function(){return{"model-id":this.model.id}},constructor:function(k){this._configure(k);Backbone.View.apply(this,arguments)},_configure:function(k){this.options&&(k=_.extend({},_.result(this,"options"),k));this.options=k;this.options.id=this.options.id||joint.util.guid(this)},initialize:function(){_.bindAll(this,"remove","update");this.$el.data("view",this);this.listenTo(this.model,"remove",this.remove);this.listenTo(this.model,"change:attrs",
this.onChangeAttrs)},onChangeAttrs:function(k,l,m){return m.dirty?this.render():this.update()},_ensureElement:function(){var k;this.el?k=_.result(this,"el"):(k=_.extend({id:this.id},_.result(this,"attributes")),this.className&&(k["class"]=_.result(this,"className")),k=V(_.result(this,"tagName"),k).node);this.setElement(k,!1)},findBySelector:function(k){var l=this.$el;"."!==k&&(l=this.$el.find(k),l.selector=k);return l},notify:function(k){if(this.paper){var l=Array.prototype.slice.call(arguments,1);
this.trigger.apply(this,[k].concat(l));this.paper.trigger.apply(this.paper,[k,this].concat(l))}},getStrokeBBox:function(k){var l=!!k;k=k||this.el;var m=V(k).bbox(!1,this.paper.viewport);k=l?V(k).attr("stroke-width"):this.model.attr("rect/stroke-width")||this.model.attr("circle/stroke-width")||this.model.attr("ellipse/stroke-width")||this.model.attr("path/stroke-width");k=parseFloat(k)||0;return g.rect(m).moveAndExpand({x:-k/2,y:-k/2,width:k,height:k})},getBBox:function(){return V(this.el).bbox()},
highlight:function(k,l){k=!k?this.el:this.$(k)[0]||this.el;l=l||{};l.partial=k!=this.el;this.notify("cell:highlight",k,l);return this},unhighlight:function(k,l){k=!k?this.el:this.$(k)[0]||this.el;l=l||{};l.partial=k!=this.el;this.notify("cell:unhighlight",k,l);return this},findMagnet:function(k){k=this.$(k);return 0===k.length||k[0]===this.el?(k=this.model.get("attrs")||{},k["."]&&!1===k["."].magnet?void 0:this.el):k.attr("magnet")?k[0]:this.findMagnet(k.parent())},applyFilter:function(k,l){var m=
this.findBySelector(k),n=l.name+this.paper.svg.id+joint.util.hashCode(JSON.stringify(l));if(!this.paper.svg.getElementById(n)){var p=joint.util.filter[l.name]&&joint.util.filter[l.name](l.args||{});if(!p)throw Error("Non-existing filter "+l.name);p=V(p);p.attr({filterUnits:"objectBoundingBox",x:-1,y:-1,width:3,height:3});l.attrs&&p.attr(l.attrs);p.node.id=n;V(this.paper.svg).defs().append(p)}m.each(function(){V(this).attr("filter","url(#"+n+")")})},applyGradient:function(k,l,m){k=this.findBySelector(k);
var n=m.type+this.paper.svg.id+joint.util.hashCode(JSON.stringify(m));if(!this.paper.svg.getElementById(n)){var p=["<"+m.type+">",_.map(m.stops,function(k){return'<stop offset="'+k.offset+'" stop-color="'+k.color+'" stop-opacity="'+(_.isFinite(k.opacity)?k.opacity:1)+'" />'}).join(""),"</"+m.type+">"].join(""),p=V(p);m.attrs&&p.attr(m.attrs);p.node.id=n;V(this.paper.svg).defs().append(p)}k.each(function(){V(this).attr(l,"url(#"+n+")")})},getSelector:function(k,l){if(k===this.el)return l;var m=$(k).index();
l=k.tagName+":nth-child("+(m+1)+") "+(l||"");return this.getSelector($(k).parent()[0],l+" ")},pointerdblclick:function(k,l,m){this.notify("cell:pointerdblclick",k,l,m)},pointerclick:function(k,l,m){this.notify("cell:pointerclick",k,l,m)},pointerdown:function(k,l,m){this.model.collection&&(this.model.trigger("batch:start",{batchName:"pointer"}),this._collection=this.model.collection);this.notify("cell:pointerdown",k,l,m)},pointermove:function(k,l,m){this.notify("cell:pointermove",k,l,m)},pointerup:function(k,
l,m){this.notify("cell:pointerup",k,l,m);this._collection&&(this._collection.trigger("batch:stop",{batchName:"pointer"}),delete this._collection)},mouseover:function(k){this.notify("cell:mouseover",k)},mouseout:function(k){this.notify("cell:mouseout",k)}});
joint.dia.Element=joint.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},position:function(k,l,m){var n=_.isNumber(l);m=(n?m:k)||{};if(m.parentRelative){if(!this.collection)throw Error("Element must be part of a collection.");var p=this.collection.get(this.get("parent")),p=p&&!p.isLink()?p.get("position"):{x:0,y:0}}if(n)return m.parentRelative&&(k+=p.x,l+=p.y),this.set("position",{x:k,y:l},m);k=g.point(this.get("position"));return m.parentRelative?k.difference(p):k},
translate:function(k,l,m){l=l||0;if(0===k&&0===l)return this;m=m||{};m.translateBy=m.translateBy||this.id;m.tx=k;m.ty=l;var n=this.get("position")||{x:0,y:0},n={x:n.x+k||0,y:n.y+l||0};m.transition?(_.isObject(m.transition)||(m.transition={}),this.transition("position",n,_.extend({},m.transition,{valueFunction:joint.util.interpolate.object}))):(this.set("position",n,m),_.invoke(this.getEmbeddedCells(),"translate",k,l,m));return this},resize:function(k,l){this.trigger("batch:start",{batchName:"resize"});
this.set("size",{width:k,height:l});this.trigger("batch:stop",{batchName:"resize"});return this},rotate:function(k,l,m){if(m){var n=this.getBBox().center(),p=this.get("size"),q=this.get("position");n.rotate(m,this.get("angle")-k);m=n.x-p.width/2-q.x;n=n.y-p.height/2-q.y;this.trigger("batch:start",{batchName:"rotate"});this.translate(m,n);this.rotate(k,l);this.trigger("batch:stop",{batchName:"rotate"})}else this.set("angle",l?k:(this.get("angle")+k)%360);return this},getBBox:function(){var k=this.get("position"),
l=this.get("size");return g.rect(k.x,k.y,l.width,l.height)}});
joint.dia.ElementView=joint.dia.CellView.extend({className:function(){return"element "+this.model.get("type").split(".").join(" ")},initialize:function(){_.bindAll(this,"translate","resize","rotate");joint.dia.CellView.prototype.initialize.apply(this,arguments);this.listenTo(this.model,"change:position",this.translate);this.listenTo(this.model,"change:size",this.resize);this.listenTo(this.model,"change:angle",this.rotate)},update:function(k,l){var m=this.model.get("attrs"),n=V(this.$(".rotatable")[0]);
if(n){var p=n.attr("transform");n.attr("transform","")}var q=[];_.each(l||m,function(k,l){var m=this.findBySelector(l);if(0!==m.length){var n="style text html ref-x ref-y ref-dx ref-dy ref-width ref-height ref x-alignment y-alignment port".split(" ");_.isObject(k.filter)&&(n.push("filter"),this.applyFilter(l,k.filter));_.isObject(k.fill)&&(n.push("fill"),this.applyGradient(l,"fill",k.fill));_.isObject(k.stroke)&&(n.push("stroke"),this.applyGradient(l,"stroke",k.stroke));_.isUndefined(k.text)||(m.each(function(){V(this).text(k.text+
"",{lineHeight:k.lineHeight,textPath:k.textPath})}),n.push("lineHeight","textPath"));var p=_.omit(k,n);m.each(function(){V(this).attr(p)});k.port&&m.attr("port",_.isUndefined(k.port.id)?k.port:k.port.id);k.style&&m.css(k.style);_.isUndefined(k.html)||m.each(function(){$(this).html(k.html+"")});(!_.isUndefined(k["ref-x"])||!_.isUndefined(k["ref-y"])||!_.isUndefined(k["ref-dx"])||!_.isUndefined(k["ref-dy"])||!_.isUndefined(k["x-alignment"])||!_.isUndefined(k["y-alignment"])||!_.isUndefined(k["ref-width"])||
!_.isUndefined(k["ref-height"]))&&_.each(m,function(k,l,m){k=$(k);k.selector=m.selector;q.push(k)})}},this);var r=this.el.getBBox();l=l||{};_.each(q,function(k){var n=l[k.selector],n=n?_.merge({},m[k.selector],n):m[k.selector];this.positionRelative(k,r,n)},this);n&&n.attr("transform",p||"")},positionRelative:function(k,l,m){function n(k){return _.isNumber(k)&&!_.isNaN(k)}var p=m.ref,q=parseFloat(m["ref-x"]),r=parseFloat(m["ref-y"]),s=parseFloat(m["ref-dx"]),t=parseFloat(m["ref-dy"]),z=m["y-alignment"],
v=m["x-alignment"],u=parseFloat(m["ref-width"]),w=parseFloat(m["ref-height"]);m=_.contains(_.pluck(_.pluck(k.parents("g"),"className"),"baseVal"),"scalable");p&&(l=V(this.findBySelector(p)[0]).bbox(!1,this.el));k=V(k[0]);k.attr("transform")&&k.attr("transform",k.attr("transform").replace(/translate\([^)]*\)/g,"").trim()||"");var A=p=0;n(u)&&(0<=u&&1>=u?k.attr("width",u*l.width):k.attr("width",Math.max(u+l.width,0)));n(w)&&(0<=w&&1>=w?k.attr("height",w*l.height):k.attr("height",Math.max(w+l.height,
0)));n(s)&&(m?(u=V(this.$(".scalable")[0]).scale(),p=l.x+l.width+s/u.sx):p=l.x+l.width+s);n(t)&&(m?(u=V(this.$(".scalable")[0]).scale(),A=l.y+l.height+t/u.sy):A=l.y+l.height+t);n(q)&&(0<q&&1>q?p=l.x+l.width*q:m?(u=V(this.$(".scalable")[0]).scale(),p=l.x+q/u.sx):p=l.x+q);n(r)&&(0<r&&1>r?A=l.y+l.height*r:m?(u=V(this.$(".scalable")[0]).scale(),A=l.y+r/u.sy):A=l.y+r);l=k.bbox(!1,this.paper.viewport);"middle"===z?A-=l.height/2:n(z)&&(A+=-1<z&&1>z?l.height*z:z);"middle"===v?p-=l.width/2:n(v)&&(p+=-1<v&&
1>v?l.width*v:v);k.translate(p,A)},renderMarkup:function(){var k=this.model.markup||this.model.get("markup");if(k)k=V(k),V(this.el).append(k);else throw Error("properties.markup is missing while the default render() implementation is used.");},render:function(){this.$el.empty();this.renderMarkup();this.update();this.resize();this.rotate();this.translate();return this},scale:function(k,l){V(this.el).scale(k,l)},resize:function(){var k=this.model.get("size")||{width:1,height:1},l=this.model.get("angle")||
0,m=V(this.$(".scalable")[0]);if(m){var n=m.bbox(!0);m.attr("transform","scale("+k.width/(n.width||1)+","+k.height/(n.height||1)+")");var p=(n=V(this.$(".rotatable")[0]))&&n.attr("transform");p&&"null"!==p&&(n.attr("transform",p+" rotate("+-l+","+k.width/2+","+k.height/2+")"),k=m.bbox(!1,this.paper.viewport),this.model.set("position",{x:k.x,y:k.y}),this.rotate());this.update()}},translate:function(k,l,m){k=this.model.get("position")||{x:0,y:0};V(this.el).attr("transform","translate("+k.x+","+k.y+
")")},rotate:function(){var k=V(this.$(".rotatable")[0]);if(k){var l=this.model.get("angle")||0,m=this.model.get("size")||{width:1,height:1};k.attr("transform","rotate("+l+","+m.width/2+","+m.height/2+")")}},getBBox:function(k){if(k&&k.useModelGeometry){var l=this.model.getBBox().bbox(this.model.get("angle")),m=this.paper.viewport.getCTM();return V.transformRect(l,m)}return joint.dia.CellView.prototype.getBBox.apply(this,arguments)},findParentsByKey:function(k){var l=this.model.getBBox();return"bbox"==
k?this.paper.model.findModelsInArea(l):this.paper.model.findModelsFromPoint(l[k]())},prepareEmbedding:function(){this.model.toFront({deep:!0,ui:!0});_.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"toFront",{ui:!0});var k=this.model.get("parent");k&&this.paper.model.getCell(k).unembed(this.model,{ui:!0})},processEmbedding:function(k){k=k||this.paper.options;var l=this.findParentsByKey(k.findParentBy),l=_.reject(l,function(k){return this.model.id==k.id||k.isEmbeddedIn(this.model)},
this);k.frontParentOnly&&(l=l.slice(-1));for(var m=null,n=this._candidateEmbedView,p=l.length-1;0<=p;p--){var q=l[p];if(n&&n.model.id==q.id){m=n;break}else if(q=q.findView(this.paper),k.validateEmbedding.call(this.paper,this,q)){m=q;break}}m&&m!=n&&(n&&n.unhighlight(null,{embedding:!0}),this._candidateEmbedView=m.highlight(null,{embedding:!0}));!m&&n&&(n.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView)},finalizeEmbedding:function(){var k=this._candidateEmbedView;k&&(k.model.embed(this.model,
{ui:!0}),k.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView);_.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"reparent",{ui:!0})},pointerdown:function(k,l,m){if(k.target.getAttribute("magnet")&&this.paper.options.validateMagnet.call(this.paper,this,k.target)){this.model.trigger("batch:start",{batchName:"add-link"});var n=this.paper.getDefaultLink(this,k.target);n.set({source:{id:this.model.id,selector:this.getSelector(k.target),port:$(k.target).attr("port")},target:{x:l,
y:m}});this.paper.model.addCell(n);this._linkView=this.paper.findViewByModel(n);this._linkView.pointerdown(k,l,m);this._linkView.startArrowheadMove("target")}else this._dx=l,this._dy=m,joint.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("element:pointerdown",k,l,m)},pointermove:function(k,l,m){if(this._linkView)this._linkView.pointermove(k,l,m);else{var n=this.paper.options.gridSize;if(!1!==(_.isFunction(this.options.interactive)?this.options.interactive(this,"pointermove"):
this.options.interactive)){var p=this.model.get("position");this.model.translate(g.snapToGrid(p.x,n)-p.x+g.snapToGrid(l-this._dx,n),g.snapToGrid(p.y,n)-p.y+g.snapToGrid(m-this._dy,n));this.paper.options.embeddingMode&&(this._inProcessOfEmbedding||(this.prepareEmbedding(),this._inProcessOfEmbedding=!0),this.processEmbedding())}this._dx=g.snapToGrid(l,n);this._dy=g.snapToGrid(m,n);joint.dia.CellView.prototype.pointermove.apply(this,arguments);this.notify("element:pointermove",k,l,m)}},pointerup:function(k,
l,m){this._linkView?(this._linkView.pointerup(k,l,m),delete this._linkView,this.model.trigger("batch:stop",{batchName:"add-link"})):(this._inProcessOfEmbedding&&(this.finalizeEmbedding(),this._inProcessOfEmbedding=!1),this.notify("element:pointerup",k,l,m),joint.dia.CellView.prototype.pointerup.apply(this,arguments))}});
joint.dia.Link=joint.dia.Cell.extend({markup:joint.templates.markup,labelMarkup:joint.templates.labelMarkup,toolMarkup:joint.templates.toolMarkup,vertexMarkup:joint.templates.vertexMarkup,arrowheadMarkup:joint.templates.arrowheadMarkup,defaults:{type:"link",source:{},target:{}},disconnect:function(){return this.set({source:g.point(0,0),target:g.point(0,0)})},label:function(k,l){k=k||0;var m=this.get("labels")||[];if(0===arguments.length||1===arguments.length)return m[k];var n=_.merge({},m[k],l),m=
m.slice();m[k]=n;return this.set({labels:m})},translate:function(k,l,m){var n={},p=this.get("source"),q=this.get("target"),r=this.get("vertices");p.id||(n.source={x:p.x+k,y:p.y+l});q.id||(n.target={x:q.x+k,y:q.y+l});r&&r.length&&(n.vertices=_.map(r,function(m){return{x:m.x+k,y:m.y+l}}));return this.set(n,m)},reparent:function(k){var l;if(this.collection){var m=this.collection.get(this.get("source").id),n=this.collection.get(this.get("target").id),p=this.collection.get(this.get("parent"));m&&n&&(l=
this.collection.getCommonAncestor(m,n));p&&(!l||l.id!=p.id)&&p.unembed(this,k);l&&l.embed(this,k)}return l},isLink:function(){return!0},hasLoop:function(){var k=this.get("source").id,l=this.get("target").id;return k&&l&&k==l}});
joint.dia.LinkView=joint.dia.CellView.extend({className:function(){return _.unique(this.model.get("type").split(".").concat("link")).join(" ")},options:{shortLinkLength:100,doubleLinkTools:!1,longLinkLength:160,linkToolsOffset:40,doubleLinkToolsOffset:60,sampleInterval:50},initialize:function(k){joint.dia.CellView.prototype.initialize.apply(this,arguments);"function"!==typeof this.constructor.prototype.watchSource&&(this.constructor.prototype.watchSource=this.createWatcher("source"),this.constructor.prototype.watchTarget=
this.createWatcher("target"));this._labelCache={};this._markerCache={};this.startListening()},startListening:function(){this.listenTo(this.model,"change:markup",this.render);this.listenTo(this.model,"change:smooth change:manhattan change:router change:connector",this.update);this.listenTo(this.model,"change:toolMarkup",function(){this.renderTools().updateToolsPosition()});this.listenTo(this.model,"change:labels change:labelMarkup",function(){this.renderLabels().updateLabelPositions()});this.listenTo(this.model,
"change:vertices change:vertexMarkup",function(k,l,m){this.renderVertexMarkers();(!m.translateBy||m.translateBy==this.model.id||this.model.hasLoop())&&this.update()});this.listenTo(this.model,"change:source",function(k,l){this.watchSource(k,l).update()});this.listenTo(this.model,"change:target",function(k,l){this.watchTarget(k,l).update()})},render:function(){this.$el.empty();var k=this.model.get("markup")||this.model.markup,k=V(k());_.isArray(k)||(k=[k]);this._V={};_.each(k,function(k){var m=k.attr("class");
m&&(this._V[$.camelCase(m)]=k)},this);if(!this._V.connection)throw Error("link: no connection path in the markup");this.renderTools();this.renderVertexMarkers();this.renderArrowheadMarkers();V(this.el).append(k);this.renderLabels();this.watchSource(this.model,this.model.get("source")).watchTarget(this.model,this.model.get("target")).update();return this},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var k=$(this._V.labels.node).empty(),l=this.model.get("labels")||[];if(!l.length)return this;
var m=this.model.get("labelMarkup")||this.model.labelMarkup,n=V(m()),p=this.can("labelMove");_.each(l,function(l,m){var s=n.clone().node;V(s).attr("label-idx",m);p&&V(s).attr("cursor","move");this._labelCache[m]=V(s);var t=$(s).find("text"),z=$(s).find("rect"),v=_.extend({"text-anchor":"middle","font-size":14},joint.util.getByPath(l,"attrs/text","/"));t.attr(_.omit(v,"text"));_.isUndefined(v.text)||V(t[0]).text(v.text+"");k.append(s);s=V(t[0]).bbox(!0,k[0]);V(t[0]).translate(0,-s.height/2);t=_.extend({fill:"white",
rx:3,ry:3},joint.util.getByPath(l,"attrs/rect","/"));z.attr(_.extend(t,{x:s.x,y:s.y-s.height/2,width:s.width,height:s.height}))},this);return this},renderTools:function(){if(!this._V.linkTools)return this;var k=$(this._V.linkTools.node).empty(),l=this.model.get("toolMarkup")||this.model.toolMarkup,l=V(l());k.append(l.node);this._toolCache=l;this.options.doubleLinkTools&&(l=l.clone(),k.append(l.node),this._tool2Cache=l);return this},renderVertexMarkers:function(){if(!this._V.markerVertices)return this;
var k=$(this._V.markerVertices.node).empty(),l=this.model.get("vertexMarkup")||this.model.vertexMarkup;_.each(this.model.get("vertices"),function(m,n){k.append(V(l(_.extend({idx:n},m))).node)});return this},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;var k=$(this._V.markerArrowheads.node);k.empty();var l=this.model.get("arrowheadMarkup")||this.model.arrowheadMarkup;this._V.sourceArrowhead=V(l({end:"source"}));this._V.targetArrowhead=V(l({end:"target"}));k.append(this._V.sourceArrowhead.node,
this._V.targetArrowhead.node);return this},update:function(){_.each(this.model.get("attrs"),function(k,m){var n=[];_.isObject(k.fill)&&(this.applyGradient(m,"fill",k.fill),n.push("fill"));_.isObject(k.stroke)&&(this.applyGradient(m,"stroke",k.stroke),n.push("stroke"));_.isObject(k.filter)&&(this.applyFilter(m,k.filter),n.push("filter"));0<n.length&&(n.unshift(k),k=_.omit.apply(_,n));this.findBySelector(m).attr(k)},this);var k=this.route=this.findRoute(this.model.get("vertices")||[]);this._findConnectionPoints(k);
k=this.getPathData(k);if(void 0===this.path||this.path!==k)this.path=k,this.model.trigger("reroute",this.model,{}),this._V.connection.attr("d",k),this._V.connectionWrap&&this._V.connectionWrap.attr("d",k);this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget);this.updateLabelPositions();this.updateToolsPosition();this.updateArrowheadMarkers();delete this.options.perpendicular;this.updatePostponed=!1;return this},_findConnectionPoints:function(k){var l,m,n,p=_.first(k);l=this.getConnectionPoint("source",
this.model.get("source"),p||this.model.get("target")).round();var q=_.last(k);k=this.getConnectionPoint("target",this.model.get("target"),q||l).round();var r=this._markerCache;this._V.markerSource&&(r.sourceBBox=r.sourceBBox||this._V.markerSource.bbox(!0),m=g.point(l).move(p||k,-1*r.sourceBBox.width*this._V.markerSource.scale().sx).round());this._V.markerTarget&&(r.targetBBox=r.targetBBox||this._V.markerTarget.bbox(!0),n=g.point(k).move(q||l,-1*r.targetBBox.width*this._V.markerTarget.scale().sx).round());
r.sourcePoint=m||l;r.targetPoint=n||k;this.sourcePoint=l;this.targetPoint=k},updateLabelPositions:function(){if(!this._V.labels)return this;var k=this.model.get("labels")||[];if(!k.length)return this;var l=this._V.connection.node,m=l.getTotalLength();if(!_.isNaN(m)){var n;_.each(k,function(k,q){var r=k.position,s=_.isObject(r)?r.distance:r,r=_.isObject(r)?r.offset:{x:0,y:0},s=s>m?m:s,s=0>s?m+s:s,s=1<s?s:m*s,s=l.getPointAtLength(s);if(_.isObject(r))s=g.point(s).offset(r.x,r.y);else if(_.isNumber(r)){n||
(n=this._samples||this._V.connection.sample(this.options.sampleInterval));for(var t=Infinity,z,v,u=0,w=n.length;u<w;u++)v=n[u],v=g.line(v,s).squaredLength(),v<t&&(t=v,z=u);t=n[z-1];z=n[z+1];u=0;z?u=g.point(s).theta(z):t&&(u=g.point(t).theta(s));s=g.point(s).offset(r).rotate(s,u-90)}this._labelCache[q].attr("transform","translate("+s.x+", "+s.y+")")},this)}return this},updateToolsPosition:function(){if(!this._V.linkTools)return this;var k="",l=this.options.linkToolsOffset,m=this.getConnectionLength();
if(!_.isNaN(m)){m<this.options.shortLinkLength&&(k="scale(.5)",l/=2);var n=this.getPointAtLength(l);this._toolCache.attr("transform","translate("+n.x+", "+n.y+") "+k);this.options.doubleLinkTools&&m>=this.options.longLinkLength?(n=this.getPointAtLength(m-(this.options.doubleLinkToolsOffset||l)),this._tool2Cache.attr("transform","translate("+n.x+", "+n.y+") "+k),this._tool2Cache.attr("visibility","visible")):this.options.doubleLinkTools&&this._tool2Cache.attr("visibility","hidden")}return this},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads||
"none"===$.css(this._V.markerArrowheads.node,"display"))return this;var k=this.getConnectionLength()<this.options.shortLinkLength?0.5:1;this._V.sourceArrowhead.scale(k);this._V.targetArrowhead.scale(k);this._translateAndAutoOrientArrows(this._V.sourceArrowhead,this._V.targetArrowhead);return this},createWatcher:function(k){var l=_.partial(this.onEndModelChange,k);return function(m,n){n=n||{};var p=null,q=m.previous(k)||{};q.id&&this.stopListening(this.paper.getModelById(q.id),"change reroute",l);
n.id&&(p=this.paper.getModelById(n.id),this.listenTo(p,"change reroute",l));l.call(this,p,{cacheOnly:!0});return this}},onEndModelChange:function(k,l,m){var n=!m.cacheOnly,p=this.model.get(k)||{};if(l){var q=this.constructor.makeSelector(p),r="source"==k?"target":"source",s=this.model.get(r)||{},t=s.id&&this.constructor.makeSelector(s);m.isLoop&&q==t?(this[k+"BBox"]=this[r+"BBox"],this[k+"View"]=this[r+"View"],this[k+"Magnet"]=this[r+"Magnet"]):m.translateBy?(q=this[k+"BBox"],q.x+=m.tx,q.y+=m.ty):
(r=this.paper.findViewByModel(p.id),q=r.el.querySelector(q),this[k+"BBox"]=r.getStrokeBBox(q),this[k+"View"]=r,this[k+"Magnet"]=q);m.isLoop&&(m.translateBy&&this.model.isEmbeddedIn(l)&&!_.isEmpty(this.model.get("vertices")))&&(n=!1);if(!this.updatePostponed&&s.id&&(l=this.paper.getModelById(s.id),m.isLoop=p.id==s.id,m.isLoop||m.translateBy&&l.isEmbeddedIn(m.translateBy)))this.updatePostponed=!0,n=!1}else this[k+"BBox"]=g.rect(p.x||0,p.y||0,1,1),this[k+"View"]=this[k+"Magnet"]=null;this.lastEndChange=
k;n&&this.update()},_translateAndAutoOrientArrows:function(k,l){k&&k.translateAndAutoOrient(this.sourcePoint,_.first(this.route)||this.targetPoint,this.paper.viewport);l&&l.translateAndAutoOrient(this.targetPoint,_.last(this.route)||this.sourcePoint,this.paper.viewport)},removeVertex:function(k){var l=_.clone(this.model.get("vertices"));l&&l.length&&(l.splice(k,1),this.model.set("vertices",l,{ui:!0}));return this},addVertex:function(k){for(var l=(this.model.get("vertices")||[]).slice(),m=l.slice(),
n=this._V.connection.node.cloneNode(!1),p=n.getTotalLength(),q,r=l.length+1;r--;)if(l.splice(r,0,k),V(n).attr("d",this.getPathData(this.findRoute(l))),q=n.getTotalLength(),20<q-p)l=m.slice();else break;-1===r&&(r=0,l.splice(r,0,k));this.model.set("vertices",l,{ui:!0});return r},sendToken:function(k,l,m){l=l||1E3;V(this.paper.viewport).append(k);V(k).animateAlongPath({dur:l+"ms",repeatCount:1},this._V.connection.node);_.delay(function(){V(k).remove();m&&m()},l)},findRoute:function(k){var l=this.model.get("router");
if(!l)if(this.model.get("manhattan"))l={name:"orthogonal"};else return k;var m=joint.routers[l.name];if(!_.isFunction(m))throw"unknown router: "+l.name;return m.call(this,k||[],l.args||{},this)},getPathData:function(k){var l=this.model.get("connector");l||(l=this.model.get("smooth")?{name:"smooth"}:{name:"normal"});if(!_.isFunction(joint.connectors[l.name]))throw"unknown connector: "+l.name;return joint.connectors[l.name].call(this,this._markerCache.sourcePoint,this._markerCache.targetPoint,k||this.model.get("vertices")||
{},l.args||{},this)},getConnectionPoint:function(k,l,m){_.isEmpty(l)&&(l={x:0,y:0});_.isEmpty(m)&&(m={x:0,y:0});if(l.id){l="source"===k?this.sourceBBox:this.targetBBox;if(m.id){var n="source"===k?this.targetBBox:this.sourceBBox;m=(m=g.rect(n).intersectionWithLineFromCenterToPoint(g.rect(l).center()))||g.rect(n).center()}else m=g.point(m);if(this.paper.options.perpendicularLinks||this.options.perpendicular)if(k=g.rect(0,m.y,this.paper.options.width,1),n=g.rect(m.x,0,1,this.paper.options.height),k.intersect(g.rect(l)))switch(k=
g.rect(l).sideNearestToPoint(m),k){case "left":m=g.point(l.x,m.y);break;case "right":m=g.point(l.x+l.width,m.y);break;default:m=g.rect(l).center()}else if(n.intersect(g.rect(l)))switch(k=g.rect(l).sideNearestToPoint(m),k){case "top":m=g.point(m.x,l.y);break;case "bottom":m=g.point(m.x,l.y+l.height);break;default:m=g.rect(l).center()}else m=(m=g.rect(l).intersectionWithLineFromCenterToPoint(m))||g.rect(l).center();else m=this.paper.options.linkConnectionPoint?this.paper.options.linkConnectionPoint(this,
"target"===k?this.targetView:this.sourceView,"target"===k?this.targetMagnet:this.sourceMagnet,m):(m=g.rect(l).intersectionWithLineFromCenterToPoint(m))||g.rect(l).center()}else m=g.point(l);return m},getConnectionLength:function(){return this._V.connection.node.getTotalLength()},getPointAtLength:function(k){return this._V.connection.node.getPointAtLength(k)},_beforeArrowheadMove:function(){this._z=this.model.get("z");this.model.toFront();this.el.style.pointerEvents="none";this.paper.options.markAvailable&&
this._markAvailableMagnets()},_afterArrowheadMove:function(){this._z&&(this.model.set("z",this._z,{ui:!0}),delete this._z);this.el.style.pointerEvents="visiblePainted";this.paper.options.markAvailable&&this._unmarkAvailableMagnets()},_createValidateConnectionArgs:function(k){var l=[];l[4]=k;l[5]=this;var m=0,n=0;"source"===k?(m=2,k="target"):(n=2,k="source");k=this.model.get(k);k.id&&(l[m]=this.paper.findViewByModel(k.id),l[m+1]=k.selector&&l[m].el.querySelector(k.selector));return function(k,m){l[n]=
k;l[n+1]=k.el===m?void 0:m;return l}},_markAvailableMagnets:function(){var k=this.paper.model.get("cells").models,l=this.paper.options.validateConnection,k=_.map(k,this.paper.findViewByModel,this.paper);_.forEach(k,function(k){var n="false"!==k.el.getAttribute("magnet")&&l.apply(this.paper,this._validateConnectionArgs(k,null)),p=_.filter(k.el.querySelectorAll("[magnet]"),function(n){return l.apply(this.paper,this._validateConnectionArgs(k,n))},this);n&&V(k.el).addClass("available-magnet");_.each(p,
function(k){V(k).addClass("available-magnet")});(n||p.length)&&V(k.el).addClass("available-cell")},this)},_unmarkAvailableMagnets:function(){_.each(this.paper.el.querySelectorAll(".available-cell, .available-magnet"),function(k){V(k).removeClass("available-magnet").removeClass("available-cell")})},startArrowheadMove:function(k){this._action="arrowhead-move";this._arrowhead=k;this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead);this._beforeArrowheadMove()},can:function(k){var l=
_.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;return!_.isObject(l)||!1!==l[k]?!0:!1},pointerdown:function(k,l,m){joint.dia.CellView.prototype.pointerdown.apply(this,arguments);this.notify("link:pointerdown",k,l,m);this._dx=l;this._dy=m;if(null==k.target.getAttribute("magnet")&&!1!==(_.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive)){var n=k.target.getAttribute("class"),p=k.target.parentNode.getAttribute("class");
"label"===p?(n=p,p=k.target.parentNode):p=k.target;switch(n){case "marker-vertex":this.can("vertexMove")&&(this._action="vertex-move",this._vertexIdx=k.target.getAttribute("idx"));break;case "marker-vertex-remove":case "marker-vertex-remove-area":this.can("vertexRemove")&&this.removeVertex(k.target.getAttribute("idx"));break;case "marker-arrowhead":this.can("arrowheadMove")&&this.startArrowheadMove(k.target.getAttribute("end"));break;case "label":this.can("labelMove")&&(this._action="label-move",
this._labelIdx=parseInt(V(p).attr("label-idx"),10),this._samples=this._V.connection.sample(1),this._linkLength=this._V.connection.node.getTotalLength());break;default:(n=k.target.parentNode.getAttribute("event"))?"remove"===n?this.model.remove():"link:confirmremove"!==n&&this.paper.trigger(n,k,this,l,m):this.can("vertexAdd")&&(this._vertexIdx=this.addVertex({x:l,y:m}),this._action="vertex-move")}}},pointerclick:function(k,l,m){var n=k.target.parentNode.getAttribute("event");"link:confirmremove"===
n&&this.paper.trigger(n,k,this,l,m)},pointermove:function(k,l,m){switch(this._action){case "vertex-move":var n=_.clone(this.model.get("vertices"));n[this._vertexIdx]={x:l,y:m};this.model.set("vertices",n,{ui:!0});break;case "label-move":n={x:l,y:m};this.model.get("labels");for(var p=this._samples,q=Infinity,r,s,t,z,v=0,u=p.length;v<u;v++)t=p[v],z=g.line(t,n).squaredLength(),z<q&&(q=z,r=t,s=v);q=p[s-1];p=p[s+1];g.point(r).distance(n);s=0;q&&p?s=g.line(q,p).pointOffset(n):q?s=g.line(q,r).pointOffset(n):
p&&(s=g.line(r,p).pointOffset(n));this.model.label(this._labelIdx,{position:{distance:r.distance/this._linkLength,offset:s}});break;case "arrowhead-move":if(this.paper.options.snapLinks){var w=this.paper.options.snapLinks.radius||50,n=this.paper.findViewsInArea({x:l-w,y:m-w,width:2*w,height:2*w});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0});this._closestView=this._closestEnd=null;var A,D=Number.MAX_VALUE,B=g.point(l,m);_.each(n,function(k){"false"!==
k.el.getAttribute("magnet")&&(A=k.model.getBBox().center().distance(B),A<w&&A<D&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(k,null))&&(D=A,this._closestView=k,this._closestEnd={id:k.model.id}));k.$("[magnet]").each(_.bind(function(l,m){var n=V(m).bbox(!1,this.paper.viewport);A=B.distance({x:n.x+n.width/2,y:n.y+n.height/2});A<w&&A<D&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(k,m))&&(D=A,this._closestView=k,this._closestEnd=
{id:k.model.id,selector:k.getSelector(m),port:m.getAttribute("port")})},this))},this);this._closestView&&this._closestView.highlight(this._closestEnd.selector,{connecting:!0,snapping:!0});this.model.set(this._arrowhead,this._closestEnd||{x:l,y:m},{ui:!0})}else n="mousemove"===k.type?k.target:document.elementFromPoint(k.clientX,k.clientY),this._targetEvent!==n&&(this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),(this._viewUnderPointer=this.paper.findView(n))?
(this._magnetUnderPointer=this._viewUnderPointer.findMagnet(n))&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))?this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer,{connecting:!0}):this._magnetUnderPointer=null:this._magnetUnderPointer=null),this._targetEvent=n,this.model.set(this._arrowhead,{x:l,y:m},{ui:!0})}this._dx=l;this._dy=m;joint.dia.CellView.prototype.pointermove.apply(this,
arguments);this.notify("link:pointermove",k,l,m)},pointerup:function(k,l,m){"label-move"===this._action?this._samples=null:"arrowhead-move"===this._action&&(this.paper.options.snapLinks?(this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null):(this._magnetUnderPointer&&(this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this.model.set(this._arrowhead,{id:this._viewUnderPointer.model.id,
selector:this._viewUnderPointer.getSelector(this._magnetUnderPointer),port:$(this._magnetUnderPointer).attr("port")},{ui:!0})),delete this._viewUnderPointer,delete this._magnetUnderPointer),this.paper.options.embeddingMode&&this.model.reparent()&&delete this._z,this._afterArrowheadMove());delete this._action;this.notify("link:pointerup",k,l,m);joint.dia.CellView.prototype.pointerup.apply(this,arguments)}},{makeSelector:function(k){var l='[model-id="'+k.id+'"]';k.port?l+=' [port="'+k.port+'"]':k.selector&&
(l+=" "+k.selector);return l}});
joint.dia.Paper=Backbone.View.extend({className:"paper",options:{width:800,height:600,origin:{x:0,y:0},gridSize:50,perpendicularLinks:!1,elementView:joint.dia.ElementView,linkView:joint.dia.LinkView,snapLinks:!1,markAvailable:!1,defaultLink:new joint.dia.Link,validateMagnet:function(k,l){return"passive"!==l.getAttribute("magnet")},validateConnection:function(k,l,m,n,p,q){return("target"===p?m:k)instanceof joint.dia.ElementView},embeddingMode:!1,validateEmbedding:function(k,l){return!0},findParentBy:"bbox",
frontParentOnly:!0,interactive:{labelMove:!1},clickThreshold:0},events:{mousedown:"pointerdown",dblclick:"mousedblclick",click:"mouseclick",touchstart:"pointerdown",mousemove:"pointermove",touchmove:"pointermove","mouseover .element":"cellMouseover","mouseover .link":"cellMouseover","mouseout .element":"cellMouseout","mouseout .link":"cellMouseout"},constructor:function(k){this._configure(k);Backbone.View.apply(this,arguments)},_configure:function(k){this.options&&(k=_.extend({},_.result(this,"options"),
k));this.options=k},initialize:function(){_.bindAll(this,"addCell","sortCells","resetCells","pointerup","asyncRenderCells");this.svg=V("svg").node;this.viewport=V("g").addClass("viewport").node;this.defs=V("defs").node;V(this.svg).append([this.viewport,this.defs]);this.$el.append(this.svg);this.setOrigin();this.setDimensions();this.listenTo(this.model,"add",this.onAddCell);this.listenTo(this.model,"reset",this.resetCells);this.listenTo(this.model,"sort",this.sortCells);$(document).on("mouseup touchend",
this.pointerup);this._mousemoved=0;this.on({"cell:highlight":this.onCellHighlight,"cell:unhighlight":this.onCellUnhighlight})},remove:function(){this.removeCells();$(document).off("mouseup touchend",this.pointerup);Backbone.View.prototype.remove.call(this)},setDimensions:function(k,l){k=this.options.width=k||this.options.width;l=this.options.height=l||this.options.height;V(this.svg).attr({width:k,height:l});this.trigger("resize",k,l)},setOrigin:function(k,l){this.options.origin.x=k||0;this.options.origin.y=
l||0;V(this.viewport).translate(k,l,{absolute:!0});this.trigger("translate",k,l)},fitToContent:function(k,l,m,n){_.isObject(k)?(n=k,k=n.gridWidth||1,l=n.gridHeight||1,m=n.padding||0):(n=n||{},k=k||1,l=l||1,m=m||0);m=_.isNumber(m)?{left:m,right:m,top:m,bottom:m}:{left:m.left||0,right:m.right||0,top:m.top||0,bottom:m.bottom||0};var p=V(this.viewport).bbox(!0,this.svg),q=V(this.viewport).scale();p.x*=q.sx;p.y*=q.sy;p.width*=q.sx;p.height*=q.sy;var q=Math.max(Math.ceil((p.width+p.x)/k),1)*k,r=Math.max(Math.ceil((p.height+
p.y)/l),1)*l,s=0,t=0;if("negative"==n.allowNewOrigin&&0>p.x||"positive"==n.allowNewOrigin&&0<=p.x||"any"==n.allowNewOrigin)s=Math.ceil(-p.x/k)*k,s+=m.left,q+=s;if("negative"==n.allowNewOrigin&&0>p.y||"positive"==n.allowNewOrigin&&0<=p.y||"any"==n.allowNewOrigin)t=Math.ceil(-p.y/l)*l,t+=m.top,r+=t;q+=m.right;r+=m.bottom;q=Math.max(q,n.minWidth||0);r=Math.max(r,n.minHeight||0);k=q!=this.options.width||r!=this.options.height;(s!=this.options.origin.x||t!=this.options.origin.y)&&this.setOrigin(s,t);k&&
this.setDimensions(q,r)},scaleContentToFit:function(k){var l=this.getContentBBox();if(l.width&&l.height){k=k||{};_.defaults(k,{padding:0,preserveAspectRatio:!0,scaleGrid:null,minScale:0,maxScale:Number.MAX_VALUE});var m=k.padding,n=k.minScaleX||k.minScale,p=k.maxScaleX||k.maxScale,q=k.minScaleY||k.minScale,r=k.maxScaleY||k.maxScale,s=k.fittingBBox||{x:this.options.origin.x,y:this.options.origin.y,width:this.options.width,height:this.options.height},s=g.rect(s).moveAndExpand({x:m,y:m,width:-2*m,height:-2*
m}),t=V(this.viewport).scale(),m=s.width/l.width*t.sx,l=s.height/l.height*t.sy;k.preserveAspectRatio&&(m=l=Math.min(m,l));k.scaleGrid&&(k=k.scaleGrid,m=k*Math.floor(m/k),l=k*Math.floor(l/k));m=Math.min(p,Math.max(n,m));l=Math.min(r,Math.max(q,l));this.scale(m,l);n=this.getContentBBox();this.setOrigin(s.x-n.x,s.y-n.y)}},getContentBBox:function(){var k=this.viewport.getBoundingClientRect(),l=this.viewport.getScreenCTM(),m=this.viewport.getCTM();return g.rect({x:k.left-l.e+m.e,y:k.top-l.f+m.f,width:k.width,
height:k.height})},createViewForModel:function(k){var l=k.get("type"),m=l.split(".")[0],l=l.split(".")[1];return joint.shapes[m]&&joint.shapes[m][l+"View"]?new joint.shapes[m][l+"View"]({model:k,interactive:this.options.interactive}):k instanceof joint.dia.Element?new this.options.elementView({model:k,interactive:this.options.interactive}):new this.options.linkView({model:k,interactive:this.options.interactive})},onAddCell:function(k,l,m){if(this.options.async&&!1!==m.async&&_.isNumber(m.position)){if(this._asyncCells=
this._asyncCells||[],this._asyncCells.push(k),0==m.position){if(this._frameId)throw"another asynchronous rendering in progress";this.asyncRenderCells(this._asyncCells);delete this._asyncCells}}else this.addCell(k)},addCell:function(k){k=this.createViewForModel(k);V(this.viewport).append(k.el);k.paper=this;k.render();$(k.el).find("image").on("dragstart",function(){return!1})},beforeRenderCells:function(k){k.sort(function(k,m){return k instanceof joint.dia.Link?1:-1});return k},afterRenderCells:function(){this.sortCells()},
resetCells:function(k,l){$(this.viewport).empty();var m=k.models.slice(),m=this.beforeRenderCells(m,l);this._frameId&&(joint.util.cancelFrame(this._frameId),delete this._frameId);this.options.async?this.asyncRenderCells(m,l):(_.each(m,this.addCell,this),this.sortCells())},removeCells:function(){this.model.get("cells").each(function(k){(k=this.findViewByModel(k))&&k.remove()},this)},asyncBatchAdded:_.identity,asyncRenderCells:function(k,l){var m=!1;this._frameId&&(_.each(_.range(this.options.async&&
this.options.async.batchSize||50),function(){var l=k.shift();(m=!l)||this.addCell(l)},this),this.asyncBatchAdded());m?(delete this._frameId,this.afterRenderCells(l),this.trigger("render:done",l)):this._frameId=joint.util.nextFrame(_.bind(function(){this.asyncRenderCells(k,l)},this))},sortCells:function(){var k=$(this.viewport).children("[model-id]"),l=this.model.get("cells");this.sortElements(k,function(k,n){var p=l.get($(k).attr("model-id")),q=l.get($(n).attr("model-id"));return(p.get("z")||0)>(q.get("z")||
0)?1:-1})},sortElements:function(k,l){var m=$(k),n=m.map(function(){var k=this.parentNode,l=k.insertBefore(document.createTextNode(""),this.nextSibling);return function(){if(k===this)throw Error("You can't sort elements if any one is a descendant of another.");k.insertBefore(this,l);k.removeChild(l)}});return Array.prototype.sort.call(m,l).each(function(k){n[k].call(this)})},scale:function(k,l,m,n){l=l||k;_.isUndefined(m)&&(n=m=0);V(this.viewport).attr("transform","");var p=this.options.origin.x,
q=this.options.origin.y;(m||n||p||q)&&this.setOrigin(p-m*(k-1),q-n*(l-1));V(this.viewport).scale(k,l);this.trigger("scale",k,l,m,n);return this},rotate:function(k,l,m){_.isUndefined(l)&&(m=this.viewport.getBBox(),l=m.width/2,m=m.height/2);V(this.viewport).rotate(k,l,m)},findView:function(k){k=this.$(k);return 0===k.length||k[0]===this.el?void 0:k.data("view")||this.findView(k.parent())},findViewByModel:function(k){k=_.isString(k)?k:k.id;k=this.$('[model-id="'+k+'"]');return k.length?k.data("view"):
void 0},findViewsFromPoint:function(k){k=g.point(k);var l=_.map(this.model.getElements(),this.findViewByModel);return _.filter(l,function(l){return l&&g.rect(V(l.el).bbox(!1,this.viewport)).containsPoint(k)},this)},findViewsInArea:function(k){k=g.rect(k);var l=_.map(this.model.getElements(),this.findViewByModel);return _.filter(l,function(l){return l&&k.intersect(g.rect(V(l.el).bbox(!1,this.viewport)))},this)},getModelById:function(k){return this.model.getCell(k)},snapToGrid:function(k){k=V(this.viewport).toLocalPoint(k.x,
k.y);return{x:g.snapToGrid(k.x,this.options.gridSize),y:g.snapToGrid(k.y,this.options.gridSize)}},clientToLocalPoint:function(k){var l=this.svg.createSVGPoint();l.x=k.x;l.y=k.y;var m=V("rect",{width:this.options.width,height:this.options.height,x:0,y:0,opacity:0});V(this.svg).prepend(m);k=$(this.svg).offset();m.remove();m=document.body.scrollTop||document.documentElement.scrollTop;l.x+=(document.body.scrollLeft||document.documentElement.scrollLeft)-k.left;l.y+=m-k.top;return l.matrixTransform(this.viewport.getCTM().inverse())},
getDefaultLink:function(k,l){return _.isFunction(this.options.defaultLink)?this.options.defaultLink.call(this,k,l):this.options.defaultLink.clone()},onCellHighlight:function(k,l){V(l).addClass("highlighted")},onCellUnhighlight:function(k,l){V(l).removeClass("highlighted")},mousedblclick:function(k){k.preventDefault();k=joint.util.normalizeEvent(k);var l=this.findView(k.target),m=this.snapToGrid({x:k.clientX,y:k.clientY});l?l.pointerdblclick(k,m.x,m.y):this.trigger("blank:pointerdblclick",k,m.x,m.y)},
mouseclick:function(k){if(this._mousemoved<=this.options.clickThreshold){k=joint.util.normalizeEvent(k);var l=this.findView(k.target),m=this.snapToGrid({x:k.clientX,y:k.clientY});l?l.pointerclick(k,m.x,m.y):this.trigger("blank:pointerclick",k,m.x,m.y)}},pointerdown:function(k){k=joint.util.normalizeEvent(k);var l=this.findView(k.target);this._mousemoved=0;var m=this.snapToGrid({x:k.clientX,y:k.clientY});l?(this.sourceView=l,l.pointerdown(k,m.x,m.y)):this.trigger("blank:pointerdown",k,m.x,m.y)},pointermove:function(k){k.preventDefault();
k=joint.util.normalizeEvent(k);if(this.sourceView){this._mousemoved++;var l=this.snapToGrid({x:k.clientX,y:k.clientY});this.sourceView.pointermove(k,l.x,l.y)}},pointerup:function(k){k=joint.util.normalizeEvent(k);var l=this.snapToGrid({x:k.clientX,y:k.clientY});this.sourceView?(this.sourceView.pointerup(k,l.x,l.y),this.sourceView=null):this.trigger("blank:pointerup",k,l.x,l.y)},cellMouseover:function(k){k=joint.util.normalizeEvent(k);var l=this.findView(k.target);l&&l.mouseover(k)},cellMouseout:function(k){k=
joint.util.normalizeEvent(k);var l=this.findView(k.target);l&&l.mouseout(k)}});joint.shapes.basic={};joint.shapes.basic.Generic=joint.dia.Element.extend({defaults:joint.util.deepSupplement({type:"basic.Generic",attrs:{".":{fill:"#FFFFFF",stroke:"none"}}},joint.dia.Element.prototype.defaults)});
joint.shapes.basic.Rect=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Rect",attrs:{rect:{fill:"#FFFFFF",stroke:"black",width:100,height:60},text:{"font-size":14,text:"","ref-x":0.5,"ref-y":0.5,ref:"rect","y-alignment":"middle","x-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.TextView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments);this.listenTo(this.model,"change:attrs",this.resize)}});joint.shapes.basic.Text=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:joint.util.deepSupplement({type:"basic.Text",attrs:{text:{"font-size":18,fill:"black"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Circle=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Circle",size:{width:60,height:60},attrs:{circle:{fill:"#FFFFFF",stroke:"black",r:30,transform:"translate(30, 30)"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-y":0.5,ref:"circle","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Ellipse=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><ellipse/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Ellipse",size:{width:60,height:40},attrs:{ellipse:{fill:"#FFFFFF",stroke:"black",rx:30,ry:20,transform:"translate(30, 20)"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-y":0.5,ref:"ellipse","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Polygon=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polygon/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Polygon",size:{width:60,height:40},attrs:{polygon:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"polygon","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Polyline=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polyline/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Polyline",size:{width:60,height:40},attrs:{polyline:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"polyline","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Image=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Image",attrs:{text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"image","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Path=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Path",size:{width:60,height:60},attrs:{path:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"path","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)});
joint.shapes.basic.Rhombus=joint.shapes.basic.Path.extend({defaults:joint.util.deepSupplement({type:"basic.Rhombus",attrs:{path:{d:"M 30 0 L 60 30 30 60 0 30 z"},text:{"ref-y":0.5}}},joint.shapes.basic.Path.prototype.defaults)});
joint.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs();this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this);this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(k){var l=this.get("attrs");_.each(this._portSelectors,function(k){l[k]&&delete l[k]});this._portSelectors=[];var m={};_.each(this.get("inPorts"),function(k,l,q){k=this.getPortAttrs(k,l,q.length,".inPorts","in");this._portSelectors=this._portSelectors.concat(_.keys(k));
_.extend(m,k)},this);_.each(this.get("outPorts"),function(k,l,q){k=this.getPortAttrs(k,l,q.length,".outPorts","out");this._portSelectors=this._portSelectors.concat(_.keys(k));_.extend(m,k)},this);this.attr(m,{silent:!0});this.processPorts();this.trigger("process:ports")},getPortSelector:function(k){var l=".inPorts",m=this.get("inPorts").indexOf(k);if(0>m&&(l=".outPorts",m=this.get("outPorts").indexOf(k),0>m))throw Error("getPortSelector(): Port doesn't exist.");return l+">g:nth-child("+(m+1)+")>circle"}};
joint.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,"process:ports",this.update);joint.dia.ElementView.prototype.initialize.apply(this,arguments)},update:function(){this.renderPorts();joint.dia.ElementView.prototype.update.apply(this,arguments)},renderPorts:function(){var k=this.$(".inPorts").empty(),l=this.$(".outPorts").empty(),m=this.model.portMarkup;_.each(_.filter(this.model.ports,function(k){return"in"===k.type}),function(l,p){k.append(V(m({id:p,port:l})).node)});
_.each(_.filter(this.model.ports,function(k){return"out"===k.type}),function(k,p){l.append(V(m({id:p,port:k})).node)})}};
joint.shapes.basic.TextBlock=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><switch><foreignObject requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" class="fobj"><body xmlns="http://www.w3.org/1999/xhtml"><div/></body></foreignObject><text class="content"/></switch></g>',defaults:joint.util.deepSupplement({type:"basic.TextBlock",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:80,height:100},text:{fill:"#000000","font-size":14,"font-family":"Arial, helvetica, sans-serif"},
".content":{text:"",ref:"rect","ref-x":0.5,"ref-y":0.5,"y-alignment":"middle","x-alignment":"middle"}},content:""},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){"undefined"!==typeof SVGForeignObjectElement&&(this.setForeignObjectSize(this,this.get("size")),this.setDivContent(this,this.get("content")),this.listenTo(this,"change:size",this.setForeignObjectSize),this.listenTo(this,"change:content",this.setDivContent));joint.shapes.basic.Generic.prototype.initialize.apply(this,
arguments)},setForeignObjectSize:function(k,l){k.attr({".fobj":_.clone(l),div:{style:_.clone(l)}})},setDivContent:function(k,l){k.attr({div:{html:l}})}});
joint.shapes.basic.TextBlockView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments);"undefined"===typeof SVGForeignObjectElement&&(this.noSVGForeignObjectElement=!0,this.listenTo(this.model,"change:content",function(k){this.updateContent(k)}))},update:function(k,l){if(this.noSVGForeignObjectElement){var m=this.model,n=_.omit(l||m.get("attrs"),".content");joint.dia.ElementView.prototype.update.call(this,m,n);(!l||_.has(l,".content"))&&
this.updateContent(m,l)}else joint.dia.ElementView.prototype.update.call(this,m,l)},updateContent:function(k,l){var m=_.merge({},(l||k.get("attrs"))[".content"]);delete m.text;var n=joint.util.breakText(k.get("content"),k.get("size"),m,{svgDocument:this.paper.svg}),m=joint.util.setByPath({},".content",m,"/");m[".content"].text=n;joint.dia.ElementView.prototype.update.call(this,k,m)}});
joint.routers.orthogonal=function(){function k(k,l){return k.x==l.x?k.y>l.y?"N":"S":k.y==l.y?k.x>l.x?"W":"E":null}function l(k,l){return k["W"==l||"E"==l?"width":"height"]}function m(k,l){return g.rect(k).moveAndExpand({x:-l,y:-l,width:2*l,height:2*l})}function n(k,l,m){var n=g.point(k.x,l.y);m.containsPoint(n)&&(n=g.point(l.x,k.y));return n}function p(l,m,n){var p=g.point(l.x,m.y),q=g.point(m.x,l.y),r=k(l,p);l=k(l,q);var s=t[n];n=r==n||r!=s&&(l==s||l!=n)?p:q;return{points:[n],direction:k(n,m)}}function q(l,
m,p){l=n(l,m,p);return{points:[l],direction:k(l,m)}}function r(m,p,q,r){var s={},t=[g.point(m.x,p.y),g.point(p.x,m.y)],z=_.filter(t,function(k){return!q.containsPoint(k)}),E=_.filter(z,function(l){return k(l,m)!=r});0<E.length?(t=(t=_.filter(E,function(l){return k(m,l)==r}).pop())||E[0],s.points=[t],s.direction=k(t,p)):(t=_.difference(t,z)[0],E=g.point(p).move(t,-l(q,r)/2),t=n(E,m,q),s.points=[t,E],s.direction=k(E,p));return s}function s(l,p,q,r,s){var t={},F;F=Math.min(q.x,r.x);var E=Math.min(q.y,
r.y),C=Math.max(q.x+q.width,r.x+r.width);q=Math.max(q.y+q.height,r.y+r.height);F=g.rect(F,E,C-F,q-E);E=m(F,1);C=(F=E.center().distance(p)>E.center().distance(l))?p:l;l=F?l:p;s?(s=g.point.fromPolar(E.width+E.height,z[s],C),s=E.pointNearestToPoint(s).move(s,-1)):s=E.pointNearestToPoint(C).move(C,1);q=n(s,l,E);s.round().equals(q.round())?(q=g.point.fromPolar(E.width+E.height,g.toRad(s.theta(C))+Math.PI/2,l),q=E.pointNearestToPoint(q).move(l,1).round(),l=n(s,q,E),t.points=F?[q,l,s]:[s,l,q]):t.points=
F?[q,s]:[s,q];t.direction=F?k(s,p):k(q,p);return t}var t={N:"S",S:"N",E:"W",W:"E"},z={N:3*(-Math.PI/2),S:-Math.PI/2,E:0,W:Math.PI};return function(n,t,w){t=t.elementPadding||20;var z=[],D=m(w.sourceBBox,t);w=m(w.targetBBox,t);n=_.map(n,g.point);n.unshift(D.center());n.push(w.center());for(var B,F=0,E=n.length-1;F<E;F++){var C=null,G=n[F],H=n[F+1],I=!!k(G,H);if(0==F)if(F+1==E)if(D.intersect(m(w,1)))C=s(G,H,D,w);else{if(!I){var I=G,C=H,L=D,J=w;B=q(C,I,J);var M=B.points[0];if(L.containsPoint(M)){B=q(I,
C,L);var N=B.points[0];J.containsPoint(N)&&(N=g.point(I).move(N,-l(L,k(I,N))/2),J=g.point(C).move(M,-l(J,k(C,M))/2),J=g.line(N,J).midpoint(),I=q(I,J,L),C=p(J,C,I.direction),B.points=[I.points[0],C.points[0]],B.direction=C.direction)}C=B}}else D.containsPoint(H)?C=s(G,H,D,m(g.rect(H.x,H.y,0,0),t)):I||(C=q(G,H,D));else F+1==E?(L=I&&k(H,G)==B,w.containsPoint(G)||L?C=s(G,H,m(g.rect(G.x,G.y,0,0),t),w,B):I||(C=r(G,H,w,B))):I||(C=p(G,H,B));C?(Array.prototype.push.apply(z,C.points),B=C.direction):B=k(G,H);
F+1<E&&z.push(H)}return z}}();
joint.routers.manhattan=function(){function k(k,l){for(var m=[],n={x:0,y:0},p=l,v;v=k[p];){var u=v.difference(p);u.equals(n)||(m.unshift(p),n=u);p=v}m.unshift(p);return m}function l(k,l,m){var n=m.step,p=k.center();return _.chain(m.directionMap).pick(l).map(function(l){var m=l.x*k.width/2,r=l.y*k.height/2,m=g.point(p).offset(m,r).snapToGrid(n);k.containsPoint(m)&&m.offset(l.x*n,l.y*n);return m}).value()}function m(m,n,p,t){var z=t.reversed?t.endDirections:t.startDirections,v=t.reversed?t.startDirections:
t.endDirections,u=m instanceof g.rect?l(m,z,t):[m],v=n instanceof g.rect?l(n,v,t):[n],w=1<u.length?m.center():u[0];m=1<v.length?n.center():v[0];v=_.filter(v,function(k){var l=g.point(k).snapToGrid(t.mapGridSize).toString();return _.every(p[l],function(l){return!l.containsPoint(k)})});if(v.length){var A=t.step;n=t.penalties;for(var D=_.chain(v).invoke("snapToGrid",A).min(function(k){return t.estimateCost(w,k)}).value(),v={},B={},F={},z=t.directions,E=z.length,C=E/2,G=t.previousDirIndexes||{},H={},
I={},u=_.chain(u).invoke("snapToGrid",A).each(function(k){var l=k.toString();B[l]=0;F[l]=t.estimateCost(k,D);var m;if(!(m=G[l]))m=360/E,k=Math.floor(w.theta(k)/m),m=E-k;G[l]=m;I[l]=!0}).map(function(k){return k.toString()}).sortBy(function(k){return F[k]}).value(),A=t.maximumLoops,L=t.maxAllowedDirectionChange;u.length&&A--;){var J=u[0],M=g.point(J);if(D.equals(M))return t.previousDirIndexes=_.pick(G,J),k(v,M);u.splice(0,1);I[K]=null;H[K]=!0;for(var N=G[J],J=B[J],Q=0;Q<E;Q++){var O=Math.abs(Q-N);
O>C&&(O=E-O);if(!(O>L)){var P=z[Q],R=g.point(M).offset(P.offsetX,P.offsetY),K=R.toString();if(!H[K]){var S=g.point(R).snapToGrid(t.mapGridSize).toString();if(_.every(p[S],function(k){return!k.containsPoint(R)})&&(S=_.has(I,K),P=J+P.cost,!S||P<B[K]))v[K]=M,G[K]=Q,B[K]=P,F[K]=P+t.estimateCost(R,D)+n[O],S||(O=_.sortedIndex(u,K,function(k){return F[k]}),u.splice(O,0,K),I[K]=!0)}}}}}return t.fallbackRoute(w,m,t)}function n(k,l){l.directions=_.result(l,"directions");l.penalties=_.result(l,"penalties");
l.paddingBox=_.result(l,"paddingBox");this.options.perpendicular=!!l.perpendicular;var n=l.reversed="source"===this.lastEndChange,p=n?g.rect(this.targetBBox):g.rect(this.sourceBBox),z=n?g.rect(this.sourceBBox):g.rect(this.targetBBox);p.moveAndExpand(l.paddingBox);z.moveAndExpand(l.paddingBox);var v=this.model,u=this.paper.model,w=_.chain(l.excludeEnds).map(v.get,v).pluck("id").map(u.getCell,u).value(),A=l.mapGridSize,D=[],B=v.get("source").id;void 0!==B&&(B=u.getCell(B),void 0!==B&&(D=_.union(D,_.map(B.getAncestors(),
"id"))));v=v.get("target").id;void 0!==v&&(v=u.getCell(v),void 0!==v&&(D=_.union(D,_.map(v.getAncestors(),"id"))));for(var u=_.chain(u.getElements()).difference(w).reject(function(k){return _.contains(l.excludeTypes,k.get("type"))||_.contains(D,k.id)}).invoke("getBBox").invoke("moveAndExpand",l.paddingBox).foldl(function(k,l){for(var m=l.origin().snapToGrid(A),n=l.corner().snapToGrid(A),p=m.x;p<=n.x;p+=A)for(var q=m.y;q<=n.y;q+=A){var r=p+"@"+q;k[r]=k[r]||[];k[r].push(l)}return k},{}).value(),w=[],
v=_.map(k,g.point),B=p.center(),F=0,E=v.length;F<=E;F++){var C=null,G=H||p,H=v[F];if(!H&&(H=z,(!this.model.get("source").id||!this.model.get("target").id)&&_.isFunction(l.draggingRoute)))C=G instanceof g.rect?G.center():G,C=l.draggingRoute(C,H.origin(),l);C=C||m(G,H,u,l);(G=_.first(C))&&G.equals(B)&&C.shift();B=_.last(C)||B;w=w.concat(C)}return n?w.reverse():w}var p={step:10,perpendicular:!0,mapGridSize:100,excludeEnds:[],excludeTypes:["basic.Text"],maximumLoops:500,startDirections:["left","right",
"top","bottom"],endDirections:["left","right","top","bottom"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:1,paddingBox:function(){var k=this.step;return{x:-k,y:-k,width:2*k,height:2*k}},directions:function(){var k=this.step;return[{offsetX:k,offsetY:0,cost:k},{offsetX:0,offsetY:k,cost:k},{offsetX:-k,offsetY:0,cost:k},{offsetX:0,offsetY:-k,cost:k}]},penalties:function(){return[0,this.step/2,this.step]},estimateCost:function(k,l){return k.manhattanDistance(l)},
fallbackRoute:function(k,l,m){return[((m.prevDirIndexes||{})[k]||0)%2?g.point(k.x,l.y):g.point(l.x,k.y),l]},draggingRoute:null};return function(k,l,m){return n.call(m,k,_.extend({},p,l))}}();
joint.routers.metro=function(){if(!_.isFunction(joint.routers.manhattan))throw"Metro requires the manhattan router.";var k={diagonalCost:null,directions:function(){var k=this.step,m=this.diagonalCost||Math.ceil(Math.sqrt(k*k<<1));return[{offsetX:k,offsetY:0,cost:k},{offsetX:k,offsetY:k,cost:m},{offsetX:0,offsetY:k,cost:k},{offsetX:-k,offsetY:k,cost:m},{offsetX:-k,offsetY:0,cost:k},{offsetX:-k,offsetY:-k,cost:m},{offsetX:0,offsetY:-k,cost:k},{offsetX:k,offsetY:-k,cost:m}]},fallbackRoute:function(k,
m,n){n=k.theta(m);var p={x:m.x,y:k.y},q={x:k.x,y:m.y};if(90<n%180)var r=p,p=q,q=r;p=45>n%90?p:q;k=g.line(k,p);n=90*Math.ceil(n/90);n=g.point.fromPolar(k.squaredLength(),g.toRad(n+135),p);n=g.line(m,n);return(k=k.intersection(n))?[k.round(),m]:[m]}};return function(l,m,n){return joint.routers.manhattan(l,_.extend({},k,m),n)}}();joint.connectors.normal=function(k,l,m){var n=["M",k.x,k.y];_.each(m,function(k){n.push(k.x,k.y)});n.push(l.x,l.y);return n.join(" ")};
joint.connectors.rounded=function(k,l,m,n){var p=n.radius||10,q,r,s,t,z,v,u=["M",k.x,k.y];_.each(m,function(n,A){z=m[A-1]||k;v=m[A+1]||l;s=t||g.point(n).distance(z)/2;t=g.point(n).distance(v)/2;q=g.point(n).move(z,-Math.min(p,s)).round();r=g.point(n).move(v,-Math.min(p,t)).round();u.push(q.x,q.y,"S",n.x,n.y,r.x,r.y,"L")});u.push(l.x,l.y);return u.join(" ")};
joint.connectors.smooth=function(k,l,m){m.length?k=g.bezier.curveThroughPoints([k].concat(m).concat([l])):(m=k.x<l.x?l.x-(l.x-k.x)/2:k.x-(k.x-l.x)/2,k=["M",k.x,k.y,"C",m,k.y,m,l.y,l.x,l.y]);return k.join(" ")};
