function fetchResourceSpecification(e){$.getJSON(resourceSpecPath).fail(function(){e||fetchResourceSpecification(!0)}).done(handleResourceSpec)}function fetchRelationshipMap(e){$.getJSON(relationshipSpecPath).fail(function(){e||fetchRelationshipMap(!0)}).done(handleRelationshipMap)}function handleResourceSpec(e){resourceSpecification=e,fetchRelationshipMap()}function handleRelationshipMap(e){relationshipTypesMap=e,executeRequireJSCode()}function executeRequireJSCode(){require(["views/Composer","services/LocalizationService","plugins/topic"],function(e,t){try{SVGElement.prototype.getTransformToElement=SVGElement.prototype.getTransformToElement||function(e){return e.getScreenCTM().inverse().multiply(this.getScreenCTM())}}catch(n){console.error("Error setting getTransformToElement",n)}var r=new e({el:"#main-content"});$(document).prop("title",t.processString("AWS CloudFormation Designer")),r.render(),window&&window.AWSC&&(window.AWSC.Clog.setPageId("designer"),window.AWSC.Timer&&window.AWSC.Timer.customerReady()),$("#loadingMessage").hide(),window.onbeforeunload=function(){if(!window.hideRedirectWarning)return"Leaving page will result in loss of unsaved data."},$(function(){$(window).trigger("resize"),$.widget.bridge("uibutton",$.ui.button),$.widget.bridge("uitooltip",$.ui.tooltip),$.fn.button.noConflict&&($.fn.bootstrapBtn=$.fn.button.noConflict())});var i="";document&&document.body&&document.body.getAttribute&&(i=document.body.getAttribute("data-aws-proxy-region")),window.AWSConsoleProxyRegion=window.__amznUtmPagePostfix=i,window.__amznUtmhnOverride="console.aws.amazon.com",window.clientReporting=new window.amzn.sm.ClientReporter("designerInlineStartTimer","/cloudformation/designer/service/reporting")})}(function(e,t){typeof define=="function"&&define.amd?define("Constants",[],function(){return e.Constants=t()}):e.Constants=t()})(this,function(){return{ComposerKey:"AWS::CloudFormation::Designer",ComposerMetaKey:"Metadata['AWS::CloudFormation::Designer']",ComposerMaxFileSize:1048576,ScalingConstant:3,DefaultImageFileName:"cloudformation-designer-diagram.png",ExportImageBackgroundColor:"#ffffff",BlockModel:{JointTypePrefix:"Composer.",AwsReflink:"aws-reflink",AwsDependencyLink:"aws-dependencylink",AwsRelatedToLink:"aws-relatedtolink",AwsContainedInsideLink:"aws-containedinsidelink"},EditorMode:{JSON:"json",YAML:"yaml"},ResourceTypes:{AWS_KMS_KEY:"AWS::KMS::Key",AWS_LOGS_DESTINATION:"AWS::Logs::Destination",AWS_LOGS_METRICFILTER:"AWS::Logs::MetricFilter",AWS_LOGS_LOGGROUP:"AWS::Logs::LogGroup",AWS_LOGS_LOGSTREAM:"AWS::Logs::LogStream",AWS_LOGS_SUBSCRIPTIONFILTER:"AWS::Logs::SubscriptionFilter",AWS_REDSHIFT_CLUSTERSECURITYGROUPINGRESS:"AWS::Redshift::ClusterSecurityGroupIngress",AWS_REDSHIFT_CLUSTERSUBNETGROUP:"AWS::Redshift::ClusterSubnetGroup",AWS_REDSHIFT_CLUSTERSECURITYGROUP:"AWS::Redshift::ClusterSecurityGroup",AWS_REDSHIFT_CLUSTERPARAMETERGROUP:"AWS::Redshift::ClusterParameterGroup",AWS_REDSHIFT_CLUSTER:"AWS::Redshift::Cluster",AWS_OPSWORKS_STACK:"AWS::OpsWorks::Stack",AWS_OPSWORKS_LAYER:"AWS::OpsWorks::Layer",AWS_OPSWORKS_INSTANCE:"AWS::OpsWorks::Instance",AWS_OPSWORKS_ELASTICLOADBALANCERATTACHMENT:"AWS::OpsWorks::ElasticLoadBalancerAttachment",AWS_OPSWORKS_APP:"AWS::OpsWorks::App",AWS_KINESIS_STREAM:"AWS::Kinesis::Stream",AWS_KINESIS_FIREHOSE_DELIVERY_STREAM:"AWS::KinesisFirehose::DeliveryStream",AWS_LAMBDA_FUNCTION:"AWS::Lambda::Function",AWS_LAMBDA_PERMISSION:"AWS::Lambda::Permission",AWS_LAMBDA_EVENTSOURCEMAPPING:"AWS::Lambda::EventSourceMapping",AWS_LAMBDA_VERSION:"AWS::Lambda::Version",AWS_LAMBDA_ALIAS:"AWS::Lambda::Alias",AWS_CLOUDTRAIL_TRAIL:"AWS::CloudTrail::Trail",AWS_DIRECTORYSERVICE_SIMPLEAD:"AWS::DirectoryService::SimpleAD",AWS_DIRECTORYSERVICE_MICROSOFTAD:"AWS::DirectoryService::MicrosoftAD",AWS_DYNAMODB_TABLE:"AWS::DynamoDB::Table",AWS_AUTOSCALING_AUTOSCALINGGROUP:"AWS::AutoScaling::AutoScalingGroup",AWS_AUTOSCALING_LAUNCHCONFIGURATION:"AWS::AutoScaling::LaunchConfiguration",AWS_AUTOSCALING_SCALINGPOLICY:"AWS::AutoScaling::ScalingPolicy",AWS_AUTOSCALING_SCHEDULEDACTION:"AWS::AutoScaling::ScheduledAction",AWS_AUTOSCALING_LIFECYCLEHOOK:"AWS::AutoScaling::LifecycleHook",AWS_CLOUDFORMATION_AUTHENTICATION:"AWS::CloudFormation::Authentication",AWS_CLOUDFORMATION_CUSTOMRESOURCE:"AWS::CloudFormation::CustomResource",AWS_CLOUDFORMATION_INIT:"AWS::CloudFormation::Init",AWS_CLOUDFORMATION_STACK:"AWS::CloudFormation::Stack",AWS_CLOUDFORMATION_WAITCONDITION:"AWS::CloudFormation::WaitCondition",AWS_CLOUDFORMATION_WAITCONDITIONHANDLE:"AWS::CloudFormation::WaitConditionHandle",AWS_CODEBUILD_PROJECT:"AWS::CodeBuild::Project",AWS_CODEDEPLOY_APPLICATION:"AWS::CodeDeploy::Application",AWS_CODEDEPLOY_DEPLOYMENTCONFIG:"AWS::CodeDeploy::DeploymentConfig",AWS_CODEDEPLOY_DEPLOYMENTGROUP:"AWS::CodeDeploy::DeploymentGroup",AWS_CODEPIPELINE_CUSTOMACTIONTYPE:"AWS::CodePipeline::CustomActionType",AWS_CODEPIPELINE_PIPELINE:"AWS::CodePipeline::Pipeline",AWS_CONFIG_CONFIGRULE:"AWS::Config::ConfigRule",AWS_CONFIG_CONFIGURATIONRECORDER:"AWS::Config::ConfigurationRecorder",AWS_CONFIG_DELIVERYCHANNEL:"AWS::Config::DeliveryChannel",AWS_CLOUDFRONT_DISTRIBUTION:"AWS::CloudFront::Distribution",AWS_CLOUDWATCH_ALARM:"AWS::CloudWatch::Alarm",AWS_EC2_AVAILABILITYZONE:"AWS::EC2::AvailabilityZone",AWS_EC2_CUSTOMERGATEWAY:"AWS::EC2::CustomerGateway",AWS_EC2_DHCPOPTIONS:"AWS::EC2::DHCPOptions",AWS_EC2_EIP:"AWS::EC2::EIP",AWS_EC2_EIPASSOCIATION:"AWS::EC2::EIPAssociation",AWS_EC2_FLOW_LOG:"AWS::EC2::FlowLog",AWS_EC2_HOST:"AWS::EC2::Host",AWS_EC2_INSTANCE:"AWS::EC2::Instance",AWS_EC2_INTERNETGATEWAY:"AWS::EC2::InternetGateway",AWS_EC2_NATGATEWAY:"AWS::EC2::NatGateway",AWS_EC2_NETWORKACL:"AWS::EC2::NetworkAcl",AWS_EC2_NETWORKACLENTRY:"AWS::EC2::NetworkAclEntry",AWS_EC2_NETWORKINTERFACE:"AWS::EC2::NetworkInterface",AWS_EC2_NETWORKINTERFACEATTACHMENT:"AWS::EC2::NetworkInterfaceAttachment",AWS_EC2_PLACEMENTGROUP:"AWS::EC2::PlacementGroup",AWS_EC2_ROUTE:"AWS::EC2::Route",AWS_EC2_ROUTETABLE:"AWS::EC2::RouteTable",AWS_EC2_SECURITYGROUP:"AWS::EC2::SecurityGroup",AWS_EC2_SECURITYGROUPINGRESS:"AWS::EC2::SecurityGroupIngress",AWS_EC2_SECURITYGROUPEGRESS:"AWS::EC2::SecurityGroupEgress",AWS_EC2_SPOTFLEET:"AWS::EC2::SpotFleet",AWS_EC2_SUBNET:"AWS::EC2::Subnet",AWS_EC2_SUBNETNETWORKACLASSOCIATION:"AWS::EC2::SubnetNetworkAclAssociation",AWS_EC2_SUBNETROUTETABLEASSOCIATION:"AWS::EC2::SubnetRouteTableAssociation",AWS_EC2_VOLUME:"AWS::EC2::Volume",AWS_EC2_VOLUMEATTACHMENT:"AWS::EC2::VolumeAttachment",AWS_EC2_VPC:"AWS::EC2::VPC",AWS_EC2_VPCDHCPOPTIONSASSOCIATION:"AWS::EC2::VPCDHCPOptionsAssociation",AWS_EC2_VPCGATEWAYATTACHMENT:"AWS::EC2::VPCGatewayAttachment",AWS_EC2_VPNCONNECTION:"AWS::EC2::VPNConnection",AWS_EC2_VPCPEERINGCONNECTION:"AWS::EC2::VPCPeeringConnection",AWS_EC2_VPNCONNECTIONROUTE:"AWS::EC2::VPNConnectionRoute",AWS_EC2_VPCENDPOINT:"AWS::EC2::VPCEndpoint",AWS_EC2_VPNGATEWAYROUTEPROPAGATION:"AWS::EC2::VPNGatewayRoutePropagation",AWS_EC2_VPNGATEWAY:"AWS::EC2::VPNGateway",AWS_ECS_CLUSTER:"AWS::ECS::Cluster",AWS_ECS_SERVICE:"AWS::ECS::Service",AWS_ECS_TASKDEFINITION:"AWS::ECS::TaskDefinition",AWS_EFS_FILESYSTEM:"AWS::EFS::FileSystem",AWS_EFS_MOUNTTARGET:"AWS::EFS::MountTarget",AWS_ELASTICACHE_CACHECLUSTER:"AWS::ElastiCache::CacheCluster",AWS_ELASTICACHE_PARAMETERGROUP:"AWS::ElastiCache::ParameterGroup",AWS_ELASTICACHE_SUBNETGROUP:"AWS::ElastiCache::SubnetGroup",AWS_ELASTICACHE_SECURITYGROUP:"AWS::ElastiCache::SecurityGroup",AWS_ELASTICACHE_SECURITYGROUPINGRESS:"AWS::ElastiCache::SecurityGroupIngress",AWS_ELASTICBEANSTALK_APPLICATION:"AWS::ElasticBeanstalk::Application",AWS_ELASTICBEANSTALK_ENVIRONMENT:"AWS::ElasticBeanstalk::Environment",AWS_ELASTICBEANSTALK_APPLICATIONVERSION:"AWS::ElasticBeanstalk::ApplicationVersion",AWS_ELASTICBEANSTALK_CONFIGURATIONTEMPLATE:"AWS::ElasticBeanstalk::ConfigurationTemplate",AWS_ELASTICLOADBALANCING_LOADBALANCER:"AWS::ElasticLoadBalancing::LoadBalancer",AWS_ELASTICLOADBALANCINGV2_LISTENER:"AWS::ElasticLoadBalancingV2::Listener",AWS_ELASTICLOADBALANCINGV2_LISTENERRULE:"AWS::ElasticLoadBalancingV2::ListenerRule",AWS_ELASTICLOADBALANCINGV2_LOADBALANCER:"AWS::ElasticLoadBalancingV2::LoadBalancer",AWS_ELASTICLOADBALANCINGV2_TARGETGROUP:"AWS::ElasticLoadBalancingV2::TargetGroup",AWS_EMR_CLUSTER:"AWS::EMR::Cluster",AWS_EMR_INSTANCE_GROUP_CONFIG:"AWS::EMR::InstanceGroupConfig",AWS_EMR_STEP:"AWS::EMR::Step",AWS_EVENTS_RULE:"AWS::Events::Rule",AWS_GAMELIFT_BUILD:"AWS::GameLift::Build",AWS_GAMELIFT_FLEET:"AWS::GameLift::Fleet",AWS_GAMELIFT_ALIAS:"AWS::GameLift::Alias",AWS_IAM_ACCESSKEY:"AWS::IAM::AccessKey",AWS_IAM_GROUP:"AWS::IAM::Group",AWS_IAM_INSTANCEPROFILE:"AWS::IAM::InstanceProfile",AWS_IAM_POLICY:"AWS::IAM::Policy",AWS_IAM_ROLE:"AWS::IAM::Role",AWS_IAM_USER:"AWS::IAM::User",AWS_IAM_USERTOGROUPADDITION:"AWS::IAM::UserToGroupAddition",AWS_IOT_CERTIFICATE:"AWS::IoT::Certificate",AWS_IOT_THING:"AWS::IoT::Thing",AWS_IOT_THING_PRINCIPAL_ATTACHMENT:"AWS::IoT::ThingPrincipalAttachment",AWS_IOT_TOPIC_RULE:"AWS::IoT::TopicRule",AWS_IOT_POLICY:"AWS::IoT::Policy",AWS_IOT_POLICY_PRINCIPAL_ATTACHMENT:"AWS::IoT::PolicyPrincipalAttachment",AWS_RDS_DBINSTANCE:"AWS::RDS::DBInstance",AWS_RDS_DBPARAMETERGROUP:"AWS::RDS::DBParameterGroup",AWS_RDS_DBSUBNETGROUP:"AWS::RDS::DBSubnetGroup",AWS_RDS_DBSECURITYGROUP:"AWS::RDS::DBSecurityGroup",AWS_RDS_DBSECURITYGROUPINGRESS:"AWS::RDS::DBSecurityGroupIngress",AWS_RDS_OPTIONGROUP:"AWS::RDS::OptionGroup",AWS_RDS_EVENTSUBSCRIPTION:"AWS::RDS::EventSubscription",AWS_RDS_DBCLUSTER:"AWS::RDS::DBCluster",AWS_RDS_DBCLUSTER_PARAMETERGROUP:"AWS::RDS::DBClusterParameterGroup",AWS_ROUTE53_RECORDSET:"AWS::Route53::RecordSet",AWS_ROUTE53_RECORDSETGROUP:"AWS::Route53::RecordSetGroup",AWS_ROUTE53_HOSTEDZONE:"AWS::Route53::HostedZone",AWS_ROUTE53_HEALTHCHECK:"AWS::Route53::HealthCheck",AWS_S3_BUCKET:"AWS::S3::Bucket",AWS_S3_BUCKETPOLICY:"AWS::S3::BucketPolicy",AWS_SDB_DOMAIN:"AWS::SDB::Domain",AWS_SNS_TOPICPOLICY:"AWS::SNS::TopicPolicy",AWS_SNS_TOPIC:"AWS::SNS::Topic",AWS_SQS_QUEUE:"AWS::SQS::Queue",AWS_SQS_QUEUEPOLICY:"AWS::SQS::QueuePolicy",AWS_SSM_ASSOCIATION:"AWS::SSM::Association",AWS_SSM_DOCUMENT:"AWS::SSM::Document",AWS_WORKSPACES_WORKSPACE:"AWS::WorkSpaces::Workspace",AWS_WAF_BYTEMATCHSET:"AWS::WAF::ByteMatchSet",AWS_WAF_IPSET:"AWS::WAF::IPSet",AWS_WAF_RULE:"AWS::WAF::Rule",AWS_WAF_SIZECONSTRAINTSET:"AWS::WAF::SizeConstraintSet",AWS_WAF_SQLINJECTIONMATCHSET:"AWS::WAF::SqlInjectionMatchSet",AWS_WAF_WEBACL:"AWS::WAF::WebACL",AWS_WAF_XSSMATCHSET:"AWS::WAF::XssMatchSet",AWS_APIGATEWAY_ACCOUNT:"AWS::ApiGateway::Account",AWS_APIGATEWAY_CLIENTCERTIFICATE:"AWS::ApiGateway::ClientCertificate",AWS_APIGATEWAY_RESTAPI:"AWS::ApiGateway::RestApi",AWS_APIGATEWAY_DEPLOYMENT:"AWS::ApiGateway::Deployment",AWS_APIGATEWAY_STAGE:"AWS::ApiGateway::Stage",AWS_APIGATEWAY_RESOURCE:"AWS::ApiGateway::Resource",AWS_APIGATEWAY_METHOD:"AWS::ApiGateway::Method",AWS_APIGATEWAY_MODEL:"AWS::ApiGateway::Model",AWS_APIGATEWAY_APIKEY:"AWS::ApiGateway::ApiKey",AWS_APIGATEWAY_BASEPATHMAPPING:"AWS::ApiGateway::BasePathMapping",AWS_APIGATEWAY_AUTHORIZER:"AWS::ApiGateway::Authorizer"},PseudoParameters:{AWS_ACCOUNTID:"AWS::AccountId",AWS_NOTIFICATIONARNS:"AWS::NotificationARNs",AWS_NOVALUE:"AWS::NoValue",AWS_REGION:"AWS::Region",AWS_STACKID:"AWS::StackId",AWS_STACKNAME:"AWS::StackName"},LinkTypes:{Vpc:"VPC",Subnet:"Subnet",AvailabilityZone:"AZ",SecurityGroup:"SecurityGroup",ElasticLoadBalancer:"ELB",Beanstalk:"Beanstalk",DependsOn:"DependsOn"},RelationshipTypes:{IsAssociatedWith:"IsAssociatedWith",IsContainedInside:"IsContainedInside",References:"References",DependsOn:"DependsOn"},DefaultNodeNames:{Vpc:"Default VPC",Subnet:"Default Subnet",AvailabilityZone:"Default AZ",Region:"Default Region"},Beanstalk:{Namespaces:{Vpc:"aws:ec2:vpc",LaunchConfig:"aws:autoscaling:launchconfiguration"},OptionNames:{Subnet:"Subnets",ElbSubnet:"ELBSubnets",SecurityGroup:"SecurityGroups"}},Resolver:{Fn:"Fn::",FnEquals:"Fn::Equals",FnFindInMap:"Fn::FindInMap",FnIf:"Fn::If",FnNot:"Fn::Not",FnOr:"Fn::Or",FnAnd:"Fn::And",FnJoin:"Fn::Join",FnSplit:"Fn::Split",FnBase64:"Fn::Base64",FnSelect:"Fn::Select",FnGetAZs:"Fn::GetAZs",FnGetAtt:"Fn::GetAtt",FnSub:"Fn::Sub",FnImportValue:"Fn::ImportValue",Ref:"Ref",References:"References",ContainedIn:"IsContainedInside",Condition:"Condition",ParameterNoDefault:"DefaultUndefined",YamlTags:{Ref:"Ref",Condition:"Condition",Equals:"Equals",FindInMap:"FindInMap",If:"If",Not:"Not",Or:"Or",And:"And",Join:"Join",Split:"Split",Base64:"Base64",Select:"Select",GetAZs:"GetAZs",GetAtt:"GetAtt",Sub:"Sub",ImportValue:"ImportValue"}},Topics:{Composer:{ClearCurrent:"Topics.Composer.ClearCurrent",ClearEvents:"Topics.Composer.ClearEvents",LoadFileAndVis:"Topics.Composer.LoadFileAndVis",Busy:"Topics.Composer.Busy",Ready:"Topics.Composer.Ready",Events:{Error:"Topics.Composer.Events.Error",Success:"Topics.Composer.Events.Positive",Warning:"Topics.Composer.Events.Warning"},Message:"Topics.Composer.Message",ExportImage:"Topics.Composer.ExportImage",DirtyFlag:{Toggle:"Topics.Composer.DirtyFlag.Toggle"},CFT:{Launch:"Topics.Composer.CFT.Launch",Validate:"Topics.Composer.CFT.Validate",IsChanging:"Topics.Composer.CFT.IsChanging",IsChangingProps:"Topics.Composer.CFT.IsChangingProps"},Menu:{ResetState:"Topics.Composer.Menu.ResetState",Help:"Topics.Composer.Menu.Help"},File:{Open:"Topics.Composer.File.Open",Loading:"Topics.Composer.File.Loading",New:"Topics.Composer.File.New",Save:"Topics.Composer.File.Save",SampleTemplates:"Topics.Composer.File.SampleTemplates",UpdateFileName:"Topics.Composer.File.UpdateFileName"},Vis:{CanvasChanging:"Topics.Composer.Vis.CanvasChanging",Delete:"Topics.Composer.Vis.Delete",Duplicate:"Topics.Composer.Vis.Duplicate",EditProperties:"Topics.Composer.Vis.EditProperties",NodeRemoved:"Topics.Composer.Vis.NodeRemoved",NodeSelected:"Topics.Composer.Vis.NodeSelected",Redo:"Topics.Composer.Vis.Redo",Refresh:"Topics.Composer.Vis.Refresh",ResourceDropped:"Topics.Composer.Vis.ResourceDropped",RewindUndo:"Topics.Composer.Vis.RewindUndo",ShowList:"Topics.Composer.Vis.ShowList",TemplateChanged:"Topics.Composer.Vis.TemplateChanged",TemplateSelected:"Topics.Composer.Vis.TemplateSelected",Undo:"Topics.Composer.Vis.Undo",UpdateEditor:"Constants.Topics.Composer.Vis.UpdateEditor",UpdateLogicalName:"Constants.Topics.Composer.Vis.UpdateLogicalName",UpdateResourceLogicalName:"Constants.Topics.Composer.Vis.UpdateResourceLogicalName",Zoomed:"Topics.Composer.Vis.Zoomed"},Designer:{OnUndoRedo:"Topics.Composer.Designer.OnUndoRedo",UndoRedoReset:"Topics.Composer.Designer.UndoRedoReset"},Editor:{Clear:"Topics.Composer.Editor.Clear",ClearAnnotations:"Topics.Composer.Editor.ClearAnnotations",FileLoaded:"Topics.Composer.Editor.FileLoaded",GoToError:"Topics.Composer.Editor.GoToError",ConvertTemplate:"Topics.Composer.Editor.ConvertTemplate",SetLanguage:"Topics.Composer.Editor.SetLanguage"},Splitter:{Resize:"Topics.Composer.Splitter.Resize"}}},Events:{Keypress:{CtrlD:"Events.Keypress.CtrlD",CtrlX:"Events.Keypress.CtrlX",CtrlC:"Events.Keypress.CtrlC",CtrlV:"Events.Keypress.CtrlV",CtrlZ:"Events.Keypress.CtrlZ",CtrlY:"Events.Keypress.CtrlY",Delete:"Events.Keypress.Delete"}},Metrics:{JsonTemplateLoaded:"fileload_json",YamlTemplateLoaded:"fileload_yaml",TemplateLoadError:"fileload_error",TemplateRenderError:"render_error",ConvertTemplateToJson:"convert_toJson",ConvertTemplateToYaml:"convert_toYaml",ConvertTemplateToJsonError:"convert_toJson_error",ConvertTemplateToYamlError:"convert_toYaml_error",ValidateTemplate:"validate_error",SaveToS3:"save_to_S3",SaveToLocal:"save_to_local",OpenLocalFile:"open_local_file",OpenS3File:"open_S3_file",OpenSampleTemplate:"open_sample_template",CreateStack:"create_stack"},ElementType:{Container:"Container",Element:"Element",Link:"Link"},ELEMENT_MIN_HEIGHT:80,ELEMENT_MIN_WIDTH:80,ENTER:13}}),define("resolvers/TemplateResolver",["Constants"],function(e){function t(t,n){var r=relationshipTypesMap[t];if(r&&r.Relationships){if(r.Relationships.IsContainedInside&&!_.isUndefined(r.Relationships.IsContainedInside[n]))return e.Resolver.ContainedIn;if(r.Relationships.IsAppliedTo&&!_.isUndefined(r.Relationships.IsAppliedTo[n]))return e.Resolver.ContainedIn}var i=relationshipTypesMap[n];if(i&&i.Relationships){if(i.Relationships.IsContainedInside&&!_.isUndefined(i.Relationships.IsContainedInside[t]))return e.Resolver.ContainedIn;if(i.Relationships.IsAppliedTo&&!_.isUndefined(i.Relationships.IsAppliedTo[t]))return e.Resolver.ContainedIn}return e.Resolver.References}var n=function(e,t,n,r,i,s,o,u){_.has(e,"isCfnFunction")?this.Dependee=e.data:this.Dependee=e,this.DependeeType=t,this.Dependent=n,this.DependentType=r,this.ReferenceType=i,this.Type=s,this.Relationship=o,this.PropertyName=u||""},r=function(e){this.resources=[],this.relationships=[],this.relationshipsByResource={},this.Cft=e;if(!_.isObject(e))throw"Unable to resolve Cft";_.isUndefined(this.Cft.Resources)||(_.forOwn(this.Cft.Resources,function(e,t){var n=_.cloneDeep(e);n.LogicalName=t,this.resources.push(n)},this),_.each(this.resources,function(e){this.resolveResource(e)},this))};return r.prototype.ensureRelationship=function(e,t,r,i,s,o,u){var a=_.find(this.relationships,function(t){return t.Dependee===e&&t.Dependent===r&&t.ReferenceType===s&&t.Type===o&&t.PropertyName===u});if(_.isUndefined(a)){var f=new n(e,t,r,i,s,o,u);this.addRelation(f)}},r.prototype.ensureReference=function(e,n,r,i,s){var o=t(r,s);this.ensureRelationship(n,r,i,s,e?"Implicit":"Explicit",o)},r.prototype.getParentRelationships=function(t){return _.filter(this.relationships,function(n){return n.Dependent===t&&n.Type===e.Resolver.ContainedIn})},r.prototype.getDependents=function(e){return _.filter(this.relationships,function(t){return t.Dependee===e.LogicalName})},r.prototype.getDependees=function(e){return _.filter(this.relationships,function(t){return t.Dependent===e.LogicalName})},r.prototype.ensureDependencyReference=function(r,i,s,o,u){var a=this.getResourceByName(i),f=_.isUndefined(a)?"Implicit":"Explicit",l=r.LogicalName,c=r.Type,h=s==="*"?e.Resolver.References:t(s,c);u=u||"";if(s!=="*"&&a&&a.Type!==s)return;var p=_.find(this.relationships,function(e){return e.Dependee===i&&e.DependeeType===s&&e.Dependent===l&&e.DependentType===c&&e.ReferenceType===f&&e.Type===h&&e.Relationship===o&&e.PropertyName===u});_.isUndefined(p)&&this.addRelation(new n(i,s,l,c,f,h,o,u))},r.prototype.ensureContainedInsideDependency=function(t,n,r){if(_.isArray(n))_.each(n,function(e){this.ensureContainedInsideDependency(t,e,r)},this);else if(_.isBoolean(n))r===e.ResourceTypes.AWS_EC2_VPC?console.warn("Special case that requires resource chain interpolation",t,n,r):r!=="*"&&console.warn("Unhandled dependency case",t,n,r);else if(n.Arity==="Many"){if(n.PropertyName!==undefined&&t.Properties!==undefined){var i=t.Properties[n.PropertyName];_.isObject(i)&&_.each(i,function(i){if(i){var s;_.has(i,"isCfnFunction")?s=i.data:_.isObject(i)&&i.hasOwnProperty("Ref")?s=i.Ref:_.isObject(i)&&!_.isUndefined(n.EmbeddedPropertyName)&&i.hasOwnProperty(n.EmbeddedPropertyName)?s=i[n.EmbeddedPropertyName]:s=i,s!==undefined&&this.ensureDependencyReference(t,s,r,e.RelationshipTypes.IsContainedInside,n.PropertyName)}},this)}}else if(t.Properties!==undefined){var s=t.Properties[n.PropertyName];if(s!==undefined){var o;_.has(s,"isCfnFunction")?o=s.data:_.isObject(s)&&s.hasOwnProperty("Ref")?o=s.Ref:o=s,o!==undefined&&this.ensureDependencyReference(t,o,r,e.RelationshipTypes.IsContainedInside,n.PropertyName)}}},r.prototype.linkGenericResource=function(t){var n=relationshipTypesMap[t.Type];_.isUndefined(n)&&(n=relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE]),n.Relationships&&(t.EntityType=n.EntityType,n.Relationships[e.RelationshipTypes.IsContainedInside]&&_.forOwn(n.Relationships[e.RelationshipTypes.IsContainedInside],function(e,n){if(n==="*")return;this.ensureContainedInsideDependency(t,e,n)},this),_.each([e.RelationshipTypes.IsAssociatedWith,e.RelationshipTypes.References],function(e){n.Relationships[e]&&_.forOwn(n.Relationships[e],function(n,r){var i=_.isArray(n)?n:[n];_.each(i,function(n){if(n.Arity==="Many"){if(n.PropertyName!==undefined&&t.Properties!==undefined){var i=t.Properties[n.PropertyName];_.isObject(i)&&_.each(i,function(i){var s;n.EmbeddedPropertyName===undefined?s=i:s=i[n.EmbeddedPropertyName];if(s!==undefined){var o;_.has(s,"isCfnFunction")?o=s.data:_.isObject(s)&&s.hasOwnProperty("Ref")?o=s.Ref:o=s,o!==undefined&&this.ensureDependencyReference(t,o,r,e,n.PropertyName)}},this)}}else if(n.PropertyName!==undefined&&t.Properties!==undefined){var s=t.Properties[n.PropertyName],o;_.isObject(s)?_.has(s,"isCfnFunction")?o=s.data:s.hasOwnProperty("Ref")&&(o=s.Ref):o=s,o!==undefined&&this.ensureDependencyReference(t,o,r,e,n.PropertyName)}},this)},this);var r=t.DependsOn;r&&(r=_.isArray(r)?r:[r],_.each(r,function(e){this.ensureDependencyReference(t,e,"*","DependsOn","DependsOn")},this))},this));try{var r=this.Cft.Resources[t.LogicalName],i=this;_.each(r.Properties,function(e,n){i.linkForResources(t,e,i.relationshipsByResource[t.LogicalName],n)})}catch(s){throw s.resourceName=t.LogicalName,s.resources=_.keys(this.Cft.Resources),s}},r.prototype.linkForResources=function(e,t,n,r){var i=this;if(_.isObject(t)){t=i.collapseCfnFunction(t);if(t.Ref||t["Fn::GetAtt"]){var s=i.resolveProperty(t.Ref?t.Ref:t),o=i.Cft.Resources[s];if(o){var u=!1;_.each(n,function(t){t.Dependee===s&&t.DependeeType===o.Type&&t.Dependent===e.LogicalName&&t.DependentType===e.Type&&(u=!0)}),u||i.ensureDependencyReference(e,s,o.Type,"IsRelatedTo",r)}}else _.each(t,function(t,r){i.linkForResources(e,t,n,r)})}else _.isArray(t)&&_.each(t,function(t,r){i.linkForResources(e,t,n,r)})},r.prototype.findParameter=function(e){return this.Cft.Parameters?this.Cft.Parameters[e]:undefined},r.prototype.getResourceByName=function(e){var t=_.find(this.resources,function(t){return t.LogicalName===e});return t},r.prototype.addRelation=function(e){this.relationships.push(e),_.isArray(this.relationshipsByResource[e.Dependent])||(this.relationshipsByResource[e.Dependent]=[]),this.relationshipsByResource[e.Dependent].push(e)},r.prototype.getResources=function(){return this.resources},r.prototype.getRelationships=function(){return this.relationships},r.prototype.collapseCfnFunction=function(e){if(_.has(e,"isCfnFunction")){var t={};return t[e.type]=e.data,t}return e},r.prototype.resolveCfnFunction=function(e){return _.has(e,"isCfnFunction")?e.data:e},r.prototype.resolveFnFindInMap=function(t){if(this.Cft.Mappings===undefined)return console.error("CFN Validation - Fn::FindInMap - Missing mappings section",t),"Unresolved Fn::FindInMap";t=this.resolveCfnFunction(t);var n={MapName:t[0],TopLevelKey:this.resolveProperty(t[1]),SecondLevelKey:this.resolveProperty(t[2])},r=null;for(var i in this.Cft.Mappings)if(this.Cft.Mappings.hasOwnProperty(i)&&i===n.MapName){r=this.Cft.Mappings[i];break}if(r===null)return console.error("CFN Validation - Fn::FindInMap - Mapping not found",n),"Unresolved Fn::FindInMap";if(_.isObject(n.TopLevelKey)){if(!n.TopLevelKey.Ref)return this.resolveProperty(r);var s=n.TopLevelKey.Ref;if(s===e.Resolver.AwsRegion){for(var o in r)if(r.hasOwnProperty(o)){var u=r[o];return n.SecondLevelKey?u[n.SecondLevelKey]:u}}else console.warn("Fn::FindInMap - Top Level Key reference parameter "+s+" not implemented",n)}else{var a=null;for(var f in r)if(r.hasOwnProperty(f)){if(n.TopLevelKey===e.Resolver.AwsRegion){a=r[f];break}if(f===n.TopLevelKey){a=r[f];break}}if(a!=null)return n.SecondLevelKey?a[n.SecondLevelKey]:a}return t},r.prototype.resolveRef=function(t){t=this.collapseCfnFunction(t);var n=t.Ref;if(n!==undefined){switch(n){case e.PseudoParameters.AWS_ACCOUNTID:return e.PseudoParameters.AWS_ACCOUNTID;case e.PseudoParameters.AWS_NOVALUE:return"";case e.PseudoParameters.AWS_NOTIFICATIONARNS:return e.PseudoParameters.AWS_NOTIFICATIONARNS;case e.PseudoParameters.AWS_STACKID:return e.PseudoParameters.AWS_STACKID;case e.PseudoParameters.AWS_STACKNAME:return e.PseudoParameters.AWS_STACKNAME;case e.PseudoParameters.AWS_REGION:return e.PseudoParameters.AWS_REGION;default:}var r=this.findParameter(n);if(r)return r;var i=this.getResourceByName(n);return i?i.LogicalName:(console.error("CFN Validation - Ref cannot be resolved",t),n)}return undefined},r.prototype.resolveEquals=function(e){e=this.resolveCfnFunction(e),e[0]=this.collapseCfnFunction(e[0]),e[1]=this.collapseCfnFunction(e[1]);var t={expression:e[0],expected:e[1]},n;return _.isObject(t.expression)&&t.expression.Ref!==undefined?(n=this.resolveRef(t.expression),n===t.expected):(console.warn("Fn::Equals - Case not implemented ",t),!1)},r.prototype.resolveCondition=function(e){if(this.Cft.Conditions===undefined)return console.error("CFN Validation - Missing Conditions section of template"),undefined;e=this.resolveCfnFunction(e);var t=this.collapseCfnFunction(this.Cft.Conditions[e]);if(t){for(var n in t)if(t.hasOwnProperty(n)){var r=this.resolveFunction(n,t);return typeof r!="boolean"?(typeof console.error=="function"&&console.error("CFN Validation - Resolve Condition - condition does not resolve to boolean",r),undefined):r}}else typeof console.error=="function"&&console.error("CFN Validation - Resolve Condition - No matching condition found for condition",e)},r.prototype.resolveIf=function(e){if(this.Cft.Conditions){e=this.resolveCfnFunction(e);var t={condition:e[0],whenTrue:e[1],whenFalse:e[2]},n=this.resolveCondition(t.condition);if(typeof n=="boolean"){var r=t.whenTrue,i=t.whenFalse;return _.isObject(t.whenTrue)&&(r=this.resolveProperty(t.whenTrue)),_.isObject(t.whenFalse)&&(i=this.resolveProperty(t.whenFalse)),n?r:i}console.error("CFN Validation - Fn::If - condition does not resolve to boolean",n)}return undefined},r.prototype.resolveNot=function(e){e=this.resolveCfnFunction(e);var t=e?this.collapseCfnFunction(e[0]):undefined;if(t)if(typeof t=="string")console.warn("Fn::Not - expression string not supported: "+t);else for(var n in t)if(t.hasOwnProperty(n)){var r=this.resolveFunction(n,t);return typeof r!="boolean"?(console.error("CFN Validation - Fn::Not - expression does not resolve to boolean",t,e),undefined):!r}},r.prototype.resolveAnd=function(e){var t=!0;e=this.resolveCfnFunction(e);for(var n=0;n<e.length;n++){var r=this.resolveProperty(e[n]);if(typeof r!="boolean")return console.error("CFN Validation - Fn::And - expression does not resolve to boolean",e[n]),undefined;t=t&&r}return t},r.prototype.resolveOr=function(e){var t=!1;e=this.resolveCfnFunction(e);for(var n=0;n<e.length;n++){var r=this.resolveProperty(e[n]);if(typeof r!="boolean")return console.error("CFN Validation - Fn::Or - expression does not resolve to boolean",e[n]),undefined;t=t||r}return t},r.prototype.resolveSelect=function(e){e=this.resolveCfnFunction(e);var t={index:parseInt(this.resolveCfnFunction(e[0]),10),item:e[1]};if(_.isObject(t.item)){var n=this.resolveProperty(t.item);if(_.isArray(n)){if(n.length>0&&n.length>t.index)return n[t.index];if(n.length===1&&t.index===1)return console.error("CFN Validation - Fn::Select - indexes are zero based not one based",t),n[0];console.error("CFN Validation - Fn::Select - invalid item index",t)}else console.error("CFN Validation - Fn::Select - select item is not an array",t)}},r.prototype.resolveJoin=function(e){e=this.resolveCfnFunction(e);var t={separator:this.resolveCfnFunction(e[0]),values:e[1]},n="",r=0;return _.each(t.values,function(e){var s=this.resolveProperty(e);typeof s=="string"&&(r++!==0&&(n+=t.separator),n+=s)},this),n},r.prototype.resolveSplit=function(e){e=this.resolveCfnFunction(e);if(e.length!==2)return console.error("CFN Validation - Fn::Split - function must be called with a delimiter and a value to split"),undefined;var t=e[0],n=e[1];_.isObject(n)&&(n=this.resolveProperty(n));if(!_.isString(n))console.error("CFN Validation - Fn::Split - value must resolve to a non-empty string",{delimiter:t,value:n});else{if(typeof t=="string"&&!_.isEmpty(t))return n.split(t);console.error("CFN Validation - Fn::Split - delimiter must be a non-empty static string",{delimiter:t,value:n})}},r.prototype.resolveGetAtt=function(e){return e=this.resolveCfnFunction(e),_.isObject(e)?e[0]:e.split(".")[0]},r.prototype.resolveSub=function(e){e=this.resolveCfnFunction(e);var t=_.isObject(e)?e[0]:e,n=_.isObject(e)?e[1]:[],r=/\$\{([^!].*?)\}/g,i={},s=this;return _.each(_.keys(n),function(e){i[e]=s.resolveProperty(n[e])}),t=t.replace(r,function(e,t){return _.has(i,t)||(i[t]=s.resolveProperty(t)),i[t]}),t},r.prototype.resolveImportValue=function(e){return this.resolveProperty(e)},r.prototype.resolveFunction=function(t,n){_.has(t,"isCfnFunction")&&(n={},n[t.type]=t.data,t=t.type);switch(t){case undefined:return n;case e.Resolver.YamlTags.Ref:return this.resolveRef(n);case e.Resolver.FnFindInMap:return this.resolveFnFindInMap(n[t]);case e.Resolver.FnIf:return this.resolveIf(n[t]);case e.Resolver.FnNot:return this.resolveNot(n[t]);case e.Resolver.FnOr:return this.resolveOr(n[t]);case e.Resolver.FnAnd:return this.resolveAnd(n[t]);case e.Resolver.FnEquals:return this.resolveEquals(n[t]);case e.Resolver.FnJoin:return this.resolveJoin(n[t]);case e.Resolver.FnSplit:return this.resolveSplit(n[t]);case e.Resolver.FnBase64:return n;case e.Resolver.FnSelect:return this.resolveSelect(n[t]);case e.Resolver.FnGetAZs:return["us-east-1"];case e.Resolver.FnGetAtt:return this.resolveGetAtt(n[t]);case e.Resolver.FnSub:return this.resolveSub(n[t]);case e.Resolver.FnImportValue:return this.resolveImportValue(n[t]);case e.Resolver.Condition:return this.resolveCondition(n[t]);default:return console.warn("Resolve Function - Unsupported function type",{key:t,prop:n}),n}},r.prototype.resolveProperty=function(t){var n;if(typeof t=="string")return t;if(Array.isArray(t)){var r=[];for(n=0;n<t.length;n++){var i=this.resolveProperty(t[n]);r.push(i)}return r}if(_.isObject(t)){var s=this.resolveRef(t);if(s!==undefined)return s;if(_.has(t,"isCfnFunction"))return this.resolveFunction(t);var o=Object.getOwnPropertyNames(t);for(n=0;n<o.length;n++){var u=o[n];if(u.indexOf(e.Resolver.Fn)===0){var a=this.resolveFunction(u,t);if(o.length===1)return a;t[u]=a}else{if(u==="Condition"&&!_.isObject(t[u]))return this.resolveCondition(t[u]);var f=this.resolveProperty(t[u]);f&&(t[u]=f)}}}return t},r.prototype.resolveResource=function(e){var t;if(e.Properties)for(t in e.Properties)e.Properties.hasOwnProperty(t)&&(e.Properties[t]=this.resolveProperty(e.Properties[t]));for(t in e)e.hasOwnProperty(t)&&t!=="Properties"&&(e[t]=this.resolveProperty(e[t]));return e},r}),define("resolvers/BlockVisResolver",["Constants","resolvers/TemplateResolver"],function(e,t){var n=function(e){t.call(this,e),_.each(this.getResources(),function(e){this.linkGenericResource(e)},this)};return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n}),define("json!UseServiceIcon.json",function(){return["apigateway","athena","batch","cloudformation","cloudfront","cloudwatch","codebuild","codecommit","codedeploy","cognito","dax","dms","ec2","ecs","efs","elasticache","elasticloadbalancingv2","emr","glue","iam","inspector","iot","kinesisanalytics","kinesisfirehose","kms","lambda","opsworks","rds","sns","ssm","stepfunctions","waf","wafregional"]}),define("json!UseResourceIcon.json",function(){return["android","apigateway-account","applicationautoscaling-scalabletarget","applicationautoscaling-scalingpolicy","autoscaling-autoscalinggroup","autoscaling-launchconfiguration","autoscaling-lifecyclehook","autoscaling-scalingpolicy","autoscaling-scheduledaction","certificatemanager-certificate","cli","client","cloudformation-customresource","cloudformation-stack","cloudformation-template","cloudformation-waitcondition","cloudformation-waitconditionhandle","cloudfront-distribution","cloudfront-edgelocation","cloudfront-streamingdistribution","cloudfront","cloudsearch-sdfmetadata","cloudsearch","cloudtrail-trail","cloudwatch-alarm","cloudwatch","codedeploy-application","codedeploy-deploymentconfig","codedeploy-deploymentgroup","codepipeline-customactiontype","codepipeline-pipeline","cognito","config-configrule","config-configurationrecorder","config-deliverychannel","config","corporatedatacenter","datapipeline-pipeline","directconnect","directoryservice-microsoftad","directoryservice-simplead","disk","dynamodb-attribute","dynamodb-attributes","dynamodb-globalsecondaryindexes","dynamodb-item","dynamodb-items","dynamodb-table","dynamodb","ebs-snapshot","ebs","ec2-ami","ec2-cloudwatch","ec2-customergateway","ec2-dboninstance","ec2-dhcpoptions","ec2-eip","ec2-eipassociation","ec2-instance","ec2-instances","ec2-internetgateway","ec2-natgateway","ec2-networkacl","ec2-networkaclentry","ec2-networkinterface","ec2-networkinterfaceattachment","ec2-optimizedinstance","ec2-placementgroup","ec2-route","ec2-routetable","ec2-securitygroup","ec2-securitygroupegress","ec2-securitygroupingress","ec2-spotfleet","ec2-subnet","ec2-subnetnetworkaclassociation","ec2-subnetroutetableassociation","ec2-volume","ec2-volumeattachment","ec2-vpc","ec2-vpcdhcpoptionsassociation","ec2-vpcendpoint","ec2-vpcgatewayattachment","ec2-vpcpeeringconnection","ec2-vpnconnection","ec2-vpnconnectionroute","ec2-vpngateway","ec2-vpngatewayroutepropagation","ecr-repository","ecs-cluster","ecs-service","ecs-taskdefinition","efs-filesystem","efs-mounttarget","elasticache-cachecluster","elasticache-memcache","elasticache-node","elasticache-parametergroup","elasticache-redis","elasticache-replicationgroup","elasticache-securitygroup","elasticache-securitygroupingress","elasticache-subnetgroup","elasticbeanstalk-application","elasticbeanstalk-applicationversion","elasticbeanstalk-configurationtemplate","elasticbeanstalk-environment","elasticbeanstalkdeployment","elasticloadbalancing-loadbalancer","elasticsearch-domain","elastictranscoder","email","emr-cluster","emr-instancegroupconfig","emr-step","emr","emrcluster","emrengine","emrhdfscluster","emrmaprm3engine","emrmaprm5engine","emrmaprm7engine","events-rule","forums","gamelift-alias","gamelift-build","gamelift-fleet","genericdatabase","glacier","glacierarchive","glaciervault","iam-accesskey","iam-group","iam-instanceprofile","iam-managedpolicy","iam-policy","iam-role","iam-user","iam-usertogroupaddition","iamadd-on","iamcredentials","iamdataencryptionkey","iamencrypteddata","iammfatoken","iampermissions","iamsecuritytokenservice","iamshorttermcredentials","iamsts","importexport","internet","ios","iot-certificate","iot-policy","iot-thing","iot-topicrule","java","javascript","kinesis-stream","kinesis","kinesisenabledapp","kms-alias","kms-key","lambda-alias","lambda-eventsourcemapping","lambda-function","lambda-permission","lambda-version","logs-destination","logs-loggroup","logs-logstream","logs-metricfilter","logs-subscriptionfilter","managementconsole","mechanicalturk","mechanicalturkassignmenttask","mechanicalturkhumanintelligencetasks","mechanicalturkrequester","mechanicalturkworkers","mobileanalytics","mobileclient","multimedia","net","nodejs","opsworks-app","opsworks-deployment","opsworks-elasticloadbalancerattachment","opsworks-instance","opsworks-layer","opsworks-monitoring","opsworks-permissions","opsworks-resource","opsworks-stack","opsworks","php","python","rds-dbcluster","rds-dbclusterparametergroup","rds-dbinstance","rds-dbparametergroup","rds-dbsecuritygroup","rds-dbsecuritygroupingress","rds-dbsubnetgroup","rds-eventsubscription","rds-optiongroup","rdsinstancereadreplica","rdsinstancestandby","rdsmastersql","rdsmssqlinstance","rdsmysqldbinstance","rdsoracledbinstance","rdspostgresql","rdsreplicasetswithpiop","rdsslavesql","redshift-cluster","redshift-clusterparametergroup","redshift-clustersecuritygroup","redshift-clustersecuritygroupingress","redshift-clustersubnetgroup","redshift","redshiftdw1cluster","redshiftssdfamilycluster","route53-healthcheck","route53-hostedzone","route53-recordset","route53-recordsetgroup","route53","ruby","s3-bucket","s3-bucketpolicy","s3","s3bucketwithobjects","s3objects","sdb-domain","ses","simpledb-domain","simpledb","sns-emailnotification","sns-httpnotification","sns-topic","sns-topicpolicy","sns","sqs-message","sqs-queue","sqs-queuepolicy","sqs","ssm-association","ssm-document","storagegateway","storagegatewaycachedvolumn","storagegatewaynon-cachedvolumn","storagegatewayvirtualtapelibrary","swf","swfdecider","swfworker","tapestorage","toolkitforeclipse","toolkitforvisualstudio","toolsforwindowspowershell","traditionalserver","trustedadvisor","users","virtualprivatecloud","vpcrouter","waf-bytematchset","waf-ipset","waf-rule","waf-sizeconstraintset","waf-sqlinjectionmatchset","waf-webacl","waf-xssmatchset","workdocs","workspaces-workspace"]}),define("utils/ImgUtils",["json!UseServiceIcon.json","json!UseResourceIcon.json"],function(e,t){function s(e){return n+e.substring(3)}function o(e){var t;return a(e)===!0?t=r+e[1]+"-"+e[2]+".svg":u(e)===!0?t=i+e[1]+".svg":t=r+"cloudformation-customresource.svg",s(t)}function u(t){return e.indexOf(t[1])>=0}function a(e){return t.indexOf(e[1]+"-"+e[2])>=0}var n=$("#img-endpoint").attr("href"),r="img/resource-icons/",i="img/service-icons/";return{getImagePath:s,getResourceImage:o}}),define("utils/AttrHelper",["Constants","utils/ImgUtils"],function(e,t){var n="'helvetica neue', roboto, arial, 'droid sans', sans-serif",r=function(e){return t.getResourceImage(e.split("-"))},i=function(t){var r;return t===e.ElementType.Container?r={".body":{stroke:"black",rx:8,ry:8},".port-body":{r:5,magnet:!0,stroke:"#000000"},".resize":{display:"none",width:10,height:10},text:{"font-size":"10px",fill:"black","pointer-events":"none"},"text.container-text":{"font-size":"8px","font-weight":"bold","font-family":n,fill:"black","pointer-events":"none","ref-x":46,"ref-y":7,ref:"rect"}}:t===e.ElementType.Link?r={".":{magnet:!0,opacity:1},".connection":{stroke:"#333333","stroke-width":2},".marker-source":{d:""},".marker-target":{fill:"#333333",d:"M 10 0 L 0 5 L 10 10 z"}}:r={".":{magnet:!0,fill:"#FFFFFF",stroke:"none"},".body":{stroke:"black",width:60,height:60,rx:5,ry:5},".port-body":{r:5,magnet:!0,stroke:"#000000"},rect:{},"text.icon-sup-text":{"font-size":"7px","font-family":n,fill:"#666666","pointer-events":"none","ref-x":30,"ref-y":48,ref:"rect","text-anchor":"middle"},"text.icon-text":{"font-size":"8px","font-family":n,"font-weight":"bold",fill:"black","pointer-events":"none","ref-x":30,"ref-y":39,ref:"rect","text-anchor":"middle"},image:{"ref-x":10,"ref-y":0,ref:"rect",width:40,height:40},".label":{text:"","ref-x":5,"ref-y":-15,ref:".body","text-anchor":"start"},".outPorts circle":{fill:"#E74C3C"}},r},s=function(e,t){var n={"aws-apigateway-resource":{attrs:{".body":{stroke:"rgb(0, 98, 237)","stroke-width":1,"stroke-dasharray":4,fill:"rgba(232, 203, 183, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-apigateway-restapi":{attrs:{".body":{stroke:"rgb(237, 98, 0)","stroke-width":1,"stroke-dasharray":4,fill:"rgba(232, 203, 183, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-ec2-host":{attrs:{".body":{stroke:"rgb(237, 98, 0)","stroke-width":1,"stroke-dasharray":4,fill:"rgba(232, 203, 183, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-ec2-networkacl":{attrs:{".body":{stroke:"rgb(237, 98, 0)","stroke-width":1,"stroke-dasharray":4,fill:"rgba(232, 203, 183, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-ec2-routetable":{attrs:{".body":{stroke:"rgb(234, 172, 0)","stroke-width":1,"stroke-dasharray":4,fill:"rgba(234, 221, 192, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-ec2-subnet":{attrs:{".body":{"stroke-dasharray":"6px 3px"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-ec2-vpc":{attrs:{".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-rds-dbsubnetgroup":{attrs:{".body":{stroke:"rgb(111, 45, 109)","stroke-width":2,fill:"rgba(111, 45, 109, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-redshift-clustersubnetgroup":{attrs:{".body":{stroke:"rgb(54, 178, 219)","stroke-width":2,fill:"rgba(54, 178, 219, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-elasticache-subnetgroup":{attrs:{".body":{stroke:"#2473B8","stroke-width":2,fill:"rgba(36, 115, 184, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-opsworks-layer":{attrs:{".body":{stroke:"#007FEF","stroke-width":1,"stroke-dasharray":"6px 3px",fill:"rgba(255, 255, 255, 0.1)"},image:{"xlink:href":r(e)}}},"aws-opsworks-app":{attrs:{".body":{stroke:"#000000","stroke-width":1,"stroke-dasharray":"6px 3px",fill:"rgba(255, 255, 255, 0.1)"},image:{"xlink:href":r(e)}}},"aws-opsworks-instance":{attrs:{".body":{stroke:"#000000","stroke-width":1,fill:"rgba(255, 255, 255)"},image:{"xlink:href":r(e)}}},"aws-opsworks-stack":{attrs:{".body":{stroke:"#009938","stroke-width":1,"stroke-dasharray":"6px 3px",fill:"rgba(0, 153, 56, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-route53-hostedzone":{attrs:{".body":{stroke:"#BCBCBC","stroke-width":1,"stroke-dasharray":"6px 3px",fill:"rgba(247, 247, 247, 0.1)"},".outlineImageWrap rect":{stroke:"#BCBCBC","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-logs-loggroup":{attrs:{".body":{stroke:"#BCBCBC","stroke-width":1,"stroke-dasharray":"6px 3px",fill:"rgba(247, 247, 247, 0.1)"},".outlineImageWrap rect":{stroke:"#BCBCBC","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}},"aws-elasticbeanstalk-application":{attrs:{".body":{stroke:"#5F7D35","stroke-width":1,"stroke-dasharray":"6px 3px",fill:"rgba(95, 125, 53, 0.1)"},".outlineImageWrap rect":{stroke:"#C0C0C0","stroke-width":"1","stroke-opacity":".5",fill:"white",rx:"4",ry:"4",width:"30",height:"30"},".outlineImageWrap image":{"xlink:href":r(e),width:"30",height:"30"}}}}[e],i={attrs:{image:{"xlink:href":r(e)}}};return n!=null?n[t]:i[t]};return{getAttrs:s,getElementAttrs:i}}),define("JST",[],function(){return this.JST=this.JST||{},this.JST["templates/bubbleTip/generic.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="bubble-tip">\n	<h3>'+__e(logicalName)+"</h3>\n	<b>"+__e(resourceType)+"</b>\n</div>";return __p},this.JST["templates/halo.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="buttons" class="btn-group-vertical btn-group-sm" role="group">\r\n    <a href="#" id="properties" class="btn btn-default" title="Edit properties">\r\n        <span class="fa fa-eye"></span>\r\n    </a>\r\n\r\n    <a href="#" id="duplicate" class="btn btn-default" title="Duplicate">\r\n        <span class="fa fa-copy"></span>\r\n    </a>\r\n\r\n    <a href="#" id="deletenode" class="btn btn-default" title="Delete">\r\n   <span class="fa fa-trash-o"></span>\r\n    </a>\r\n\r\n     <a href="#" id="helpnode" class="btn btn-default" title="Documentation">\r\n        <span class="fa fa-question-circle"></span>\r\n    </a> \r\n\r\n   </div>';return __p},this.JST["templates/joint/port.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<g class="port port'+((__t=id)==null?"":__t)+'">\n	<circle class="port-body"/>\n	<text class="port-label" display="none"/>\n</g>';return __p},this.JST}),define("models/AWS",["Constants","utils/AttrHelper","JST"],function(e,t,n){function r(e,t){return Math.sqrt(e*e+t*t)/2}function i(e,t,n){var r=0;switch(e){case"bottomLeft":r+=Math.atan(n/t);break;case"corner":r+=Math.PI/2+Math.atan(t/n);break;case"topRight":r+=Math.PI+Math.atan(n/t);break;case"origin":r+=3*Math.PI/2+Math.atan(t/n)}return r}function s(e,t,n){return!_.isEmpty(e)&&e.length>t?e.substr(0,n)+"...":e}function o(e,t){if(e>=16)throw new Error("Too many ports");var n={},r=t/6,i=Math.floor(e/8)*4/3+1;switch(e%8){case 0:n["ref-x"]=t,n["ref-y"]=r*i;break;case 1:n["ref-x"]=r*(6-i),n["ref-y"]=t;break;case 2:n["ref-x"]=0,n["ref-y"]=r*(6-i);break;case 3:n["ref-x"]=r*i,n["ref-y"]=0;break;case 4:n["ref-x"]=t,n["ref-y"]=r*(6-i);break;case 5:n["ref-x"]=r*i,n["ref-y"]=t;break;case 6:n["ref-x"]=0,n["ref-y"]=r*i;break;case 7:n["ref-x"]=r*(6-i),n["ref-y"]=0}return n}joint.dia.Element.prototype.resize=function(e,t,n){return this.trigger("batch:start"),this.set("size",{width:e,height:t},n),this.trigger("batch:stop"),this},joint.dia.Cell.prototype.isContainer=function(){return!1},joint.dia.Cell.prototype.clone=function(e){e=e||{};var t={},n=Backbone.Model.prototype.clone.apply(this,arguments);n.set("id",joint.util.uuid(),{silent:!0}),n.set("embeds","");var r=this.collection.getConnectedLinks(this,{outbound:!0});_.each(r,function(e){var r=e.get("type");if(r==="Composer.aws-reflink"){var i=t[e.id]||e.clone();t[e.id]=i,i.prop("source",{id:n.id})}});if(!e.deep)return n;var i=_.sortBy(this.getEmbeddedCells(),function(e){return e instanceof joint.dia.Element}),s=[n];return _.each(i,function(e){var r=e.clone({deep:!0});n.embed(r[0]),_.each(r,function(r){if(r instanceof joint.dia.Link){r.get("source").id===this.id&&r.prop("source",{id:n.id}),r.get("target").id===this.id&&r.prop("target",{id:n.id}),t[e.id]=r;return}s.push(r);var i=this.collection.getConnectedLinks(e,{inbound:!0});_.each(i,function(e){var n=t[e.id]||e.clone();t[e.id]=n,n.prop("target",{id:r.id})});var o=this.collection.getConnectedLinks(e,{outbound:!0});_.each(o,function(e){var n=t[e.id]||e.clone();t[e.id]=n,n.prop("source",{id:r.id})})},this)},this),s=s.concat(_.values(t)),s};var u=joint.dia.Element.extend(_.extend({},joint.shapes.basic.PortsModelInterface,{markup:$("#outline-template").html().trim(),portMarkup:n["templates/joint/port.html"],defaults:joint.util.deepSupplement({type:"AWS.container",size:{width:140,height:140},minSize:{width:80,height:80},inPorts:[],outPorts:[],resizable:!0,attrs:t.getElementAttrs(e.ElementType.Container)},joint.dia.Element.prototype.defaults),idAttribute:"id",initialize:function(){this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments),this.updatePortsAttrs(),this.on("change:inPorts change:outPorts change:size",this.updatePortsAttrs,this),this.on("change:data",this.onChange,this),this.updateResourceText()},isContainer:function(){return!0},getPortAttrs:function(e,t,n,r,i){var s={},o="port"+t,u=r+">."+o,a=u+">.port-label",f=u+">.port-body";return s[a]={text:e},s[f]={port:{id:e||_.uniqueId(i),type:i}},s[u]={ref:".body","ref-x":t*20+50},r===".outPorts"&&(s[u]["ref-dx"]=0),s},onChange:_.debounce(function(e){e.save()},500),getLogicalName:function(){return this.prop("logicalName")},setLogicalName:function(e){this.prop("logicalName",e)},getName:function(){var e=this.prop("data/Properties/Tags");if(!_.isUndefined(e)&&!_.isNull(e)){var t=_.findIndex(e,{Key:"Name"});return e[t].Value}return this.getLogicalName()},resize:function(e,t,n){if(_.isUndefined(n)||!_.isUndefined(n.resize))return!_.isUndefined(n)&&n.resize.canceled?null:joint.dia.Element.prototype.resize.call(this,e,t,n);var s=r(e,t),o=i(n.selectedCorner,e,t),u=this.getBBox()[n.selectedCorner](),a=g.point.fromPolar(s,o,u),f=g.point(a).offset(e/-2,t/-2),l={resize:{canceled:!1,originalPosition:this.get("position"),originalSize:this.get("size")}};return this.position(Math.round(f.x),Math.round(f.y),l).resize(Math.round(e),Math.round(t),l)},tooltip:function(){return n["templates/bubbleTip/generic.html"]({logicalName:this.get("logicalName"),resourceType:this.get("resourceType")})},updateResourceText:function(){this.attr(".container-text/text",s(this.get("logicalName"),10,9))}})),a=joint.dia.Link.extend({defaults:joint.util.deepSupplement({type:"AWS.link",router:{name:"manhattan",args:{perpendicular:!1}},connector:{name:"rounded",radius:5},attrs:t.getElementAttrs(e.ElementType.Link)},joint.dia.Link.prototype.defaults),idAttribute:"id",getLogicalName:function(){return this.prop("logicalName")},setLogicalName:function(e){this.prop("logicalName",e)},tooltip:function(){switch(this.get("type")){case"Composer.aws-reflink":case"Composer.aws-relatedtolink":case"Composer.aws-containedinsidelink":return"Link";case"Composer.aws-dependencylink":return"DependsOn";default:return n["templates/bubbleTip/generic.html"]({logicalName:this.get("logicalName"),resourceType:this.get("resourceType")})}}}),f=a.extend({defaults:joint.util.deepSupplement({type:"AWS.embeddedLink",embedded:!0},a.prototype.defaults)}),l=joint.dia.Element.extend(_.extend({},joint.shapes.basic.PortsModelInterface,{markup:$("#ec2-designer-template").html().trim(),portMarkup:n["templates/joint/port.html"],defaults:joint.util.deepSupplement({type:"AWS.element",outPorts:[],inPorts:[],size:{width:60,height:60},attrs:t.getElementAttrs(e.ElementType.Element)},joint.dia.Element.prototype.defaults),idAttribute:"id",initialize:function(){this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments),this.updatePortsAttrs(),this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this),this.on("change:data",this.onChange,this),this.updateResourceText()},getPortAttrs:function(e,t,n,r,i){var s={},u="port"+t,a=r+">."+u,f=a+">.port-label",l=a+">.port-body";s[f]={text:e},s[l]={port:{id:e||_.uniqueId(i),type:i}},s[a]={ref:".body"};var c=o(t,60);return _.each(c,function(e,t){s[a][t]=e}),r===".outPorts"&&(s[a]["ref-dx"]=0),s},onChange:_.debounce(function(e){e.save()},500),getName:function(){var e=this.prop("Properties/Tags");if(!_.isUndefined(e)&&!_.isNull(e)){var t=_.findIndex(e,{Key:"Name"});return e[t].Value}return"Model"},getLogicalName:function(){return this.prop("logicalName")},setLogicalName:function(e){this.prop("logicalName",e)},tooltip:function(){return n["templates/bubbleTip/generic.html"]({logicalName:this.get("logicalName"),resourceType:this.get("resourceType")})},updateResourceText:function(){this.attr(".icon-text/text",s(this.get("logicalName"),10,9));if(!_.isEmpty(this.get("resourceType"))){var e=this.get("resourceType").split("::");this.attr(".icon-sup-text/text",s(e[e.length-1],13,11))}else this.attr(".icon-sup-text/text","")}})),c=function(t){var n=[],r=relationshipTypesMap[t];return _.isUndefined(r)&&(r=relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE]),_.isUndefined(r.Relationships)||(_.each(e.RelationshipTypes,function(i){r.Relationships[i]!=null&&_.forOwn(r.Relationships[i],function(r,s){i===e.RelationshipTypes.IsAssociatedWith&&s==="AWS::EC2::SecurityGroup"&&t!=="AWS::EC2::SecurityGroup"&&_.isArray(r)&&(r=r[0]),_.each(_.isArray(r)?r:[r],function(t){if(t.Via)_.all(n,function(e){return e!==t.Via})&&n.push(t.Via);else if(t.PropertyName){var r=_.findIndex(n,function(e){var n=e.split("-")[2];return!_.isUndefined(n)&&n===t.PropertyName});if(r===-1)n.push((i===e.RelationshipTypes.IsContainedInside?"AWS::ContainedInsideLink-":"AWS::RefLink-")+s+"-"+t.PropertyName);else{var o=n[r],u=o.split("-");u[1]=u[1]+"/"+s,n[r]=u.join("-")}}else n.push((i===e.RelationshipTypes.IsContainedInside?"AWS::ContainedInsideLink-":"AWS::RefLink-")+s)},this)})}),n.push("AWS::DependencyLink-*")),n},h=_.transform(relationshipTypesMap,function(e,t,n){t.EntityType!=="EmbeddedElement"&&(e[n]=t)});joint.shapes.Composer={},_.forOwn(h,function(e,n){var r={Container:u,Link:a,EmbeddedLink:f,Element:l}[e.EntityType];if(r!=null){var i=n.replace(/::/g,"-").toLowerCase();joint.shapes.Composer[i]=r.extend({defaults:joint.util.deepSupplement({type:"Composer."+i,outPorts:c(n)||[],attrs:t.getAttrs(i,"attrs")||{},relationships:e.Relationships,resourceType:n},r.prototype.defaults)})}},this),joint.shapes.Composer["aws-reflink"]=f.extend({defaults:joint.util.deepSupplement({type:"Composer.aws-reflink"},f.prototype.defaults)}),joint.shapes.Composer["aws-containedinsidelink"]=f.extend({defaults:joint.util.deepSupplement({type:"Composer.aws-containedinsidelink"},f.prototype.defaults)}),joint.shapes.Composer["aws-dependencylink"]=f.extend({defaults:joint.util.deepSupplement({type:"Composer.aws-dependencylink",attrs:{".connection":{stroke:"#DB72C8","stroke-width":2,opacity:"0.5"},".marker-target":{fill:"#DB72C8",d:"M 10 0 L 0 5 L 10 10 z"}}},f.prototype.defaults)}),joint.shapes.Composer["aws-relatedtolink"]=f.extend({defaults:joint.util.deepSupplement({type:"Composer.aws-relatedtolink",attrs:{".connection":{stroke:"#0000ff","stroke-width":2,opacity:"0.5","stroke-dasharray":2.5},".marker-target":{fill:"#0000ff",d:"M 10 0 L 0 5 L 10 10 z"}}},f.prototype.defaults)})}),define("models/BlockVis",["Constants","resolvers/BlockVisResolver","models/AWS"],function(e,t){function r(t){var n;switch(t){case e.RelationshipTypes.DependsOn:n=e.BlockModel.AwsDependencyLink;break;case e.RelationshipTypes.IsRelatedTo:n=e.BlockModel.AwsRelatedToLink;break;case e.RelationshipTypes.IsContainedInside:n=e.BlockModel.AwsContainedInsideLink;break;default:n=e.BlockModel.AwsReflink}return n}var n=function(e,t,n,i){var s=r(e.Relationship),o={References:e.Dependee,PropertyName:e.PropertyName};return new joint.shapes.Composer[s]({source:{id:t},target:{id:n},z:i,relationships:o})},i=function(t,n){var r=o(t),i=l(t),s=_.has(joint.shapes.Composer,i)?joint.shapes.Composer[i]:joint.shapes.Composer["aws-cloudformation-customresource"],u=_.extend({id:r,resourceType:t.Type,logicalName:t.LogicalName},n[r]||{}),a=new s(u);return t.Metadata=t.Metadata||{},t.Metadata[e.ComposerKey]={id:a.id},a},s=function(t,n,r){var i=t.get(n)||[];_.indexOf(i,r)===-1&&i.push(r),_.each(e.RelationshipTypes,function(e){if(e.toLowerCase()!==n){var i=_.without(t.get(e.toLowerCase()),r);_.isEmpty(i)?t.unset(e.toLowerCase()):t.set(e.toLowerCase(),i,{silent:!0})}}),t.set(n,i,{silent:!0})},o=function(e){if(_.isUndefined(e))return e;var t=u(e);return t?t.id:undefined},u=function(t){return t&&t.Metadata&&t.Metadata.hasOwnProperty(e.ComposerKey)?t.Metadata[e.ComposerKey]:undefined},a=function(e,t,n){var r=_.find(e,function(e){return e.id===n});return r&&r.attributes.z&&r.attributes.z>t.attributes.z?r.attributes.z:t.attributes.z?t.attributes.z:10},f=function(e,t,n){var r=_.find(e,function(e){return e.id===t}),i=_.find(e,function(e){return e.id===n});return r&&r.attributes.z&&i&&i.attributes.z?Math.max(r.attributes.z,i.attributes.z):r?r.attributes.z:i?i.attributes.z:10},l=function(e){return e&&!_.isUndefined(e.Type)?e.Type.replace(/::/g,"-").toLowerCase():undefined},c=function(e,t,n,r){var i=e.getParentRelationships(t.LogicalName),s;n.get("parent")?s=_.find(i,function(t){return o(e.getResourceByName(t.Dependee))===n.get("parent")}):r[n.id]||(s=_.find(i,function(t){if(!_.find(i,function(e){return t.PropertyName===e.PropertyName&&t.Dependee!==e.Dependee}))return!_.any(r,function(r){var i=r.source&&r.source.id===n.id;if(i){var s=o(e.getResourceByName(t.Dependee)),u=r.target&&r.target.id===s;return u}})}));if(s){var u=e.getResourceByName(s.Dependee),a=o(u);if(a){a!==n.attributes.parent&&(n.attributes.parent=a);var f=n.get("iscontainedinside")||[];_.has(f,a)||(f.push(a),n.set("iscontainedinside",f))}else n.attributes.parent&&(n.attributes.parent=undefined)}},h=function(t,r,i,u,f){var l=[],c=_.filter(t.getDependees(r),function(n){return n.Type!==e.RelationshipTypes.IsContainedInside||o(t.getResourceByName(n.Dependee))!==i.get("parent")});return i&&c&&_.each(c,function(e){var c=t.getResourceByName(e.Dependee);if(c){var h=o(c);if(h)if(f[h])if(e.Relationship){s(i,e.Relationship.toLowerCase(),h);var p=a(u,i,h),d=n(e,i.id,h,p);l.push(d)}else console.warn("Relationship is undefined, not drawing link",r,e);else console.warn("Referenced resource is not visible, not drawing link",c);else console.warn("Referenced resource does not have metadata id",r)}else console.warn("Unable to get resource referenced by connection, not drawing link",r,e)},this),l},p=function(t,n,r,i){var s,u,a,l=_.pluck(_.filter(t.getDependees(n),function(t){return t.Relationship===e.RelationshipTypes.References}),"Dependee");if(r&&l){for(var c=0;c<l.length;c++){if(s&&u)break;a=l[c];if(a){var h=t.getResourceByName(a);if(h){var p=o(h);p?_.isUndefined(s)?s=p:_.isUndefined(u)&&(u=p):console.warn("Referenced resource does not have metadata id",h)}}}if(!s||!u)return console.warn("Source and/or target resources IDs missing, cant visualize link",{resource:n,ref:a}),!1;r.attributes.source={id:s},r.attributes.target={id:u},r.attributes.z=f(i,s,u)}return!0},d=function(e,t){var n=_.filter(e,function(e){var n=e.get("parent");return n?n===t.id:!1}),r=[];_.each(n,function(e){var t=_.any(r,function(t){return t===e.id});t||r.push(e.id)}),t.attributes.embeds=r},v=function(n){function a(e){if(e.visited===!1){e.visited=!0;var t=_.filter(u,function(t){return _.any(r.getDependents(e.resource),function(e){return e.Dependent===t.resource.LogicalName})});for(var n=0;n<t.length;n++)a(t[n]);o.unshift(e.resource)}}this.cells=[],this.links=[];var r=new t(n),s={};n&&n.Metadata&&n.Metadata[e.ComposerKey]&&(s=n.Metadata[e.ComposerKey]);var o=[],u=_.map(r.getResources(),function(e){return{resource:e,visited:!1}});_.each(u,function(e){e.visited||a(e)}),this.cellsAddedList={},_.each(o,function(e){if(!e.IsExternalReference){var t=i(e,s);if(!_.isUndefined(t))if(e.EntityType!=="Link"){this.addCell(t),c(r,e,t,s);var n=h(r,e,t,this.cells,this.cellsAddedList);_.each(n,function(e){this.addLink(e)},this)}else p(r,e,t,this.cells)&&this.addCell(t)}},this),_.each(this.cells,function(e){d(this.cells,e)},this)};return v.prototype.addCell=function(e){this.cells.push(e),this.cellsAddedList[e.id]=!0},v.prototype.addLink=function(e){this.links.push(e)},v}),define("utils/LayoutGrid",[],function(){function n(e){var t=e.get("position");return t!=null&&t.x!=null&&t.y!=null&&t.x!==0&&t.y!==0}function r(e){return{width:e.width*t,height:e.height*t}}function i(e){var n=e.cell.attributes.position;n.x=n.x*t,n.y=n.y*t,e.offset&&(n.x=n.x+e.offset.x*t,n.y=n.y+e.offset.y*t),e.needsScaled=!1}function s(){return{x:0,y:0}}function o(e,t){if(e.offset===undefined){var n=e.cell.attributes.parent;if(n===undefined)e.offset=s();else{var r=_.find(t,function(e){return e.cell.id===n});r===undefined?(console.warn("unable to locate cell parent for computing offset",e,n),e.offset=s()):(r.offset===undefined&&(r.offset=o(r,t)),e.offset={x:r.cell.attributes.position.x+r.offset.x,y:r.cell.attributes.position.y+r.offset.y})}}return e.offset}function u(e,t,n,r,i,s){_.each(n,function(n){var o=f(e,t,n.cell,i,s);o===undefined?console.error("Unable to position element",n.cell):(n.cell.attributes.position=o,n.needsPositioned=!1),n.cell.attributes.z=r})}function a(e,t,n,i,s,o,u,a,l,c,h){var v=[];_.each(i,function(e){var t=new d(e.cell.attributes.size),n=p(o,e),i=p(u,e);t.positionAndSize(e,n,i,o,u,a+1,c,c,h),v.push({container:e,size:r(t.gridSize)})});var m=_.sortBy(v,function(e){return e.size.height*e.size.width}).reverse();_.each(m,function(r){var i=r.container,s=f(e,t,i.cell,l,h);s===undefined?console.error("unable to position container in container",n.cell,i.cell):(i.cell.attributes.position=s,i.needsPositioned=!1)})}function f(r,i,s,o,u){var a=!1,p=s.attributes.size,d=Math.round(e/t)||1,v={width:Math.round(p.width/t),height:Math.round(p.height/t)},m={x:d,y:d};if(n(s)){var g=s.attributes.position,y={x:0,y:0};while(u!=null&&u.parent!=null){n(u.container.cell)||console.error("unexpected parent without positioning");var b=u.container.cell.attributes.position;y.x+=Math.round(b.x/t),y.y+=Math.round(b.y/t),u=u.parent}var w={x:Math.abs(y.x-Math.round(g.x/t)),y:Math.abs(y.y-Math.round(g.y/t))};return c(r,i,w.x,w.y,v.width+d,v.height+d),w}o&&(m.x+=o.x,m.y+=o.y);for(var E=m.y;E<r[m.x].length;E++)for(var S=m.x;S<r.length;S++){var x=h(r,i,S,E,v,d*2);if(x.willFit)return a=!0,{x:S,y:E};if(!x.willFitBox)break}if(!a){var T={width:i.width+d*3,height:i.height};return i.width>i.height&&(T={width:i.width,height:i.height+d*3}),l(r,i,T),f(r,i,s,o,u)}return undefined}function l(e,n,r,i){var s=i?Math.round(r.width/t):r.width,o=i?Math.round(r.height/t):r.height;for(var u=0;u<s;u++){e[u]=e[u]||[];for(var a=0;a<o;a++)e[u][a]=e[u][a]||0}n.width=s,n.height=o}function c(e,t,n,r,i,s){(t.width<n+i||t.height<r+s)&&l(e,t,{width:n+i+t.width,height:r+s+t.height});for(var o=n;o<i+n;o++)for(var u=r;u<s+r;u++)e[o][u]=1}function h(e,t,n,r,i,s){var o=i.width+s,u=i.height+s,a={willFit:!1,willFitBox:!0};if(t.width>n&&t.height>r&&t.width-o>n&&t.height-u>r){for(var f=n;f<o+n;f++)for(var l=r;l<u+r;l++)if(e[f][l]===1)return a;a.willFit=!0,c(e,t,n,r,o,u)}else a.willFitBox=!1;return a}function p(e,t){return _.filter(e,function(e){return e.cell.attributes.parent===t.cell.id})}var e=30,t=30,d=function(e){this.grid=[],this.gridSize={width:0,height:0},e&&l(this.grid,this.gridSize,e,!0)};return d.prototype.positionAndSize=function(e,t,n,i,s,o,f,l,c){e.needsSized=!1,e.cell.attributes.z=o,c=c===undefined?{}:{parent:c,container:e},_.isEmpty(t)||a(this.grid,this.gridSize,e,t,n,i,s,o,f,l,c),_.isEmpty(n)||u(this.grid,this.gridSize,n,o+1,f,c),e.cell.attributes.size=r(this.gridSize)},d.prototype.applyScaling=function(e,t){_.each(t,function(t){o(t,e),i(t)},this);var n=_.select(e,function(e){return e.offset===undefined});_.each(n,function(t){o(t,e)}),_.each(e,function(e){i(e)},this)},d}),define("models/AutoLayoutEngine",["Constants","utils/LayoutGrid"],function(e,t){function n(t,n){_.forEach(n,function(n){var r;n.isLink()?r={source:n.get("source"),target:n.get("target"),z:n.get("z")}:(r={size:n.get("size"),position:n.get("position"),z:n.get("z"),parent:n.get("parent"),embeds:n.get("embeds")},v(r,n));var i,s,o=t.get("template"),u=n.getLogicalName();o.hasOwnProperty("Resources")&&o.Resources.hasOwnProperty(u)&&(o.Resources[u].hasOwnProperty("Metadata")?o.Resources[u].Metadata.hasOwnProperty(e.ComposerKey)?t.set("template.Resources["+u+"].Metadata["+e.ComposerKey+"].id",n.id,{silent:!0}):(s={},s.id=n.id,t.set("template.Resources["+u+"].Metadata["+e.ComposerKey+"]",s,{silent:!0})):(i={},i[e.ComposerKey]={},i[e.ComposerKey].id=n.id,t.set("template.Resources["+u+"].Metadata",i,{silent:!0}))),r=_.omit(r,_.isUndefined),o.hasOwnProperty("Metadata")?o.Metadata.hasOwnProperty(e.ComposerKey)?t.set("template.Metadata["+e.ComposerKey+"]["+n.id+"]",r,{silent:!0}):(s={},s[n.id]=r,t.set("template.Metadata["+e.ComposerKey+"]",s,{silent:!0})):(i={},i[e.ComposerKey]={},i[e.ComposerKey][n.id]=r,t.set("template.Metadata",i,{silent:!0}))})}function r(e){f(e)||e.set("position",{x:0,y:0})}function i(e){a(e)||e.set("size",u(e))}function s(e){return relationshipTypesMap[e.get("resourceType")]}function o(e){var t=[];return _.each(e,function(e){d(e)&&t.push(e)}),{cellsNeedingLayout:t}}function u(e){return l(e)?{width:100,height:100}:c(e)?{width:60,height:60}:undefined}function a(e){var t=e.get("size");return t!=null&&t.width!=null&&t.height!=null&&t.width!==0&&t.height!==0}function f(e){var t=e.get("position");return t!=null&&t.x!=null&&t.y!=null&&t.x!==0&&t.y!==0}function l(e){var t=s(e);return _.isUndefined(t)?!1:t.EntityType==="Container"}function c(e){var t=s(e);return _.isUndefined(t)?!0:t.EntityType==="Element"}function h(e){var t=s(e);return _.isUndefined(t)?!1:t.EntityType==="Link"}function p(t){return t.get("type")===e.BlockModel.JointTypePrefix+e.BlockModel.AwsReflink}function d(e){return(!a(e)||!f(e))&&!h(e)&&!p(e)}function v(t,n){_.forEach(e.RelationshipTypes,function(e){var r=n.get(e.toLowerCase());r&&r.length&&(t[e.toLowerCase()]=r)})}var m=function(e){this.cells=e.cells,this.containers=[],this.elements=[];var t=_.select(this.cells,function(e){return!h(e)&&!p(e)}),n=o(t);if(_.isEmpty(n.cellsNeedingLayout))return;_.each(t,function(e){l(e)?this.containers.push({hasPosition:f(e),needsPositioned:!0,needsSized:!0,needsScaled:!0,cell:e}):c(e)&&this.elements.push({hasPosition:f(e),needsPositioned:!0,cell:e}),i(e),r(e)},this)};return m.prototype.applyLayout=function(e){this.rootLayout=this.rootLayout||new t({width:100,height:100});var r=0,i={x:1,y:2},s={x:0,y:1},o=_.filter(this.containers,function(e){return _.isUndefined(e.cell.attributes.parent)&&e.hasPosition}),u=_.filter(this.elements,function(e){return _.isUndefined(e.cell.attributes.parent)&&e.hasPosition});this.rootLayout.positionAndSize({cell:{attributes:{}}},o,u,this.containers,this.elements,r,i,s),o=_.select(this.containers,function(e){return _.isUndefined(e.cell.attributes.parent)&&!e.hasPosition}),u=_.select(this.elements,function(e){return _.isUndefined(e.cell.attributes.parent)&&!e.hasPosition}),this.rootLayout.positionAndSize({cell:{attributes:{}}},o,u,this.containers,this.elements,r,i,s),this.rootLayout.applyScaling(this.containers,this.elements),e&&n(e,this.cells)},m}),define("models/CfnFunction",[],function(){var e=function(e,t){this.data=t,this.type=e,this.isCfnFunction=!0};return e}),define("models/CloudFormation",["Constants","models/BlockVis","models/AutoLayoutEngine","models/CfnFunction"],function(e,t,n,r){var i=Backbone.NestedModel.extend({defaults:{template:{AWSTemplateFormatVersion:"2010-09-09"}},initialize:function(){_.bindAll(this,"fixupMetadata","getBlockVisModel","getResourceId","getResource","addOrUpdate","addResource","removeResource","templateChanged","silentlyClearDirty","isDirty","update","updateResource"),this.bind("change:template",this.templateChanged),$.Topic(e.Topics.Composer.Editor.Clear).subscribe(this.silentlyClearDirty),$.Topic(e.Topics.Composer.Vis.CanvasChanging).subscribe(_.bind(function(t){t?this.canvasChanging=!0:(this.canvasChanging=!1,$.Topic(e.Topics.Composer.Vis.UpdateEditor).publish())},this)),$.Topic(e.Topics.Composer.Vis.Refresh).subscribe(_.bind(function(){this.isChangingProps(!1)},this))},canvasChanging:!1,isChangingProps:function(t){$.Topic(e.Topics.Composer.CFT.IsChangingProps).publish(t),t&&($.Topic(e.Topics.Composer.DirtyFlag.Toggle).publish(!0),$.Topic(e.Topics.Composer.Vis.TemplateChanged).publish(!0))},templateChanged:function(e,t){_.isEmpty(t)||this.set("dirty",!0,{silent:!0})},silentlyClearDirty:function(){this.set("dirty",!1,{silent:!0})},isDirty:function(){return this.get("dirty")},getLogicalName:function(t){var n=this.get("template");if(n!=null&&n.Resources!=null)return _.findKey(n.Resources,function(n){return n.Metadata!=null&&n.Metadata[e.ComposerKey]!=null&&n.Metadata[e.ComposerKey].id!=null?n.Metadata[e.ComposerKey].id===t:!1})},getResourceId:function(t){var n=this.get("template");if(n!=null&&n.Resources!=null){var r=n.Resources[t];if(r!=null&&r.Metadata&&r.Metadata[e.ComposerKey]&&r.Metadata[e.ComposerKey].id)return r.Metadata[e.ComposerKey].id}},getResource:function(e){var t=this.get("template");return _.isUndefined(t.Resources)?undefined:t.Resources[e]},removeResource:function(t,n){if(!_.isUndefined(t)){var r=this.getResourceId(t);_.isUndefined(r)?n&&this.get("template.Metadata["+e.ComposerKey+"]["+n+"]")&&this.unset("template.Metadata["+e.ComposerKey+"]["+n+"]"):(this.unset("template.Resources["+t+"]"),this.unset("template.Metadata["+e.ComposerKey+"]["+r+"]"))}},removeDependencies:function(e,t){if(!_.isObject(e))return _.contains(t,e)?"":e;if(_.has(e,"isCfnFunction"))return _.any(t,function(t){return _.contains(e,t)})?"":(e.data=this.removeDependencies(e.data,t),e);var n=_.isArray(e)?[]:{};return _.each(e,function(e,r){if(_.isObject(e)){var i=this.removeDependencies(e,t);_.isEmpty(i)||(n[r]=i)}else _.contains(t,e)||(n[r]=e)},this),n},fixupRefs:function(t,n,i){var s,o,u=this.get("template.Resources["+t+"]"),a=u.Type,f=u.Properties||{},l=relationshipTypesMap[a];_.isUndefined(l)&&(l=relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE]);if(l.Relationships){_.each(Object.keys(l.Relationships),function(u){switch(u){case e.RelationshipTypes.References:if(n.source||n.target){_.each(l.Relationships[u],function(e,s){_.each(["source","target"],function(o){if(_.isUndefined(n[o])||_.isUndefined(n[o].id)){if(_.isArray(e))_.each(e,function(n){if(n.PropertyName in f){var r=_.keys(_.pick(this.get("template.Resources"),function(e){return e.Type===s||s==="*"})),o=this.removeDependencies(this.get("template.Resources["+t+"].Properties["+e.PropertyName+"]"),_.union(r,[i]));_.isEmpty(o)?this.unset("template.Resources["+t+"].Properties["+e.PropertyName+"]"):this.set("template.Resources["+t+"].Properties["+e.PropertyName+"]",o)}},this);else if(e.PropertyName in f){var u=_.keys(_.pick(this.get("template.Resources"),function(e){return e.Type===s||s==="*"})),a=this.removeDependencies(this.get("template.Resources["+t+"].Properties["+e.PropertyName+"]"),_.union(u,[i]));_.isEmpty(a)?this.unset("template.Resources["+t+"].Properties["+e.PropertyName+"]"):this.set("template.Resources["+t+"].Properties["+e.PropertyName+"]",a)}}else{var l=this.getLogicalName(n[o].id);if(l){var c=this.getResource(l);if(c&&s===c.Type)if(_.isArray(e)){var h=_.find(e,function(e){if(!_.isUndefined(e.Endpoint))return e.Endpoint.toLowerCase()===o});h&&this.set("template.Resources["+t+"].Properties["+h.PropertyName+"]",new r("Ref",l))}else this.set("template.Resources["+t+"].Properties["+e.PropertyName+"]",new r("Ref",l))}}},this)},this);break};case e.RelationshipTypes.IsContainedInside:case e.RelationshipTypes.IsAssociatedWith:s=l.Relationships[u],o=Object.keys(s),_.each(o,function(o){var a=s[o],l,c;u===e.RelationshipTypes.IsContainedInside&&(l=this.getLogicalName(n.parent),c=this.getResource(l));if(n[u.toLowerCase()]||c){var h=_.compact(_.map(n[u.toLowerCase()],function(e){var t=this.getLogicalName(e);if(t){var n=this.getResource(t);if(n.Type===o||o==="*")return t}},this));c&&c.Type===o&&(_.contains(h,l)||h.unshift(l));if(h.length){var p=a;if(_.isArray(a)){var d=_.find(a,function(e){var n=this.get("template.Resources["+t+"]");return n.Properties&&n.Properties.hasOwnProperty(e.PropertyName)?!0:!1},this);p=_.isUndefined(d)?_.find(a,function(e){return e.PropertyName!==undefined}):d}if(p&&!_.isUndefined(p.PropertyName))if(p.Arity==="Many"){if(p.PropertyName){var v=[],m=_.keys(_.pick(this.get("template.Resources"),function(e){return e.Type===o||o==="*"})),g=this.get("template.Resources["+t+"].Properties["+p.PropertyName+"]");_.isString(g)&&(g=[g]),_.each(g,function(e){var t=this.removeDependencies(e,_.union(m,[i]));_.isEmpty(t)||v.push(t)},this),_.each(h,function(e){if(p.EmbeddedPropertyName){var t={};t[p.EmbeddedPropertyName]=new r("Ref",e),v.push(t)}else v.push(new r("Ref",e))},this),this.set("template.Resources["+t+"].Properties["+p.PropertyName+"]",v)}}else{var y=h[0];p.PropertyName&&this.set("template.Resources["+t+"].Properties["+p.PropertyName+"]",new r("Ref",y))}}else _.each(_.isArray(a)?a:[a],function(e){if(e&&e.PropertyName&&_.any(Object.keys(f),function(t){return t.toLowerCase()===e.PropertyName.toLowerCase()})){var n=_.keys(_.pick(this.get("template.Resources"),function(e){return e.Type===o||o==="*"})),r=this.removeDependencies(this.get("template.Resources["+t+"].Properties["+e.PropertyName+"]"),_.union(n,[i]));_.isEmpty(r)?this.unset("template.Resources["+t+"].Properties["+e.PropertyName+"]"):this.set("template.Resources["+t+"].Properties["+e.PropertyName+"]",r)}},this)}else a&&_.each(_.isArray(a)?a:[a],function(e){if(e.PropertyName&&_.any(Object.keys(f),function(t){return t.toLowerCase()===e.PropertyName.toLowerCase()})){var n=_.keys(_.pick(this.get("template.Resources"),function(e){return e.Type===o||o==="*"})),r=this.removeDependencies(this.get("template.Resources["+t+"].Properties["+e.PropertyName+"]"),_.union(n,[i]));_.isEmpty(r)?this.unset("template.Resources["+t+"].Properties["+e.PropertyName+"]"):this.set("template.Resources["+t+"].Properties["+e.PropertyName+"]",r)}},this)},this);break;default:}},this);var c="DependsOn";if(n[c.toLowerCase()]){var h=_.compact(_.map(n[c.toLowerCase()],function(e){return this.getLogicalName(e)},this));if(h.length){var p=[];_.each(h,function(e){p.push(e)},this),this.set("template.Resources["+t+"]["+c+"]",p)}}else this.unset("template.Resources["+t+"]["+c+"]")}},addOrUpdate:function(e,t,n,r){var i=this.get("template"),s;if(i.hasOwnProperty("Resources")){var o=i.Resources;o.hasOwnProperty(t)&&(s=o[t])}s?this.updateResource(e,t,n,r):this.addResource(e,t,n,r)},addResource:function(t,n,r,i){var s={Type:r,Properties:{}};s.Metadata=s.Metadata||{},s.Metadata[e.ComposerKey]=s.Metadata[e.ComposerKey]||{},s.Metadata[e.ComposerKey].id=t;var o={};o["template.Metadata["+e.ComposerKey+"]["+t+"]"]=i,o["template.Resources["+n+"]"]=s,this.set(o),_.isEmpty(_.pick(i,["parent","embeds","source","target","isassociatedwith","references","iscontainedinside","dependson"]))||this.fixupRefs(n,i)},updateLogicalName:function(t,n){function r(e,t){return e.dependson&&_.any(e.dependson,function(e){return e===t})||e.isassociatedwith&&_.any(e.isassociatedwith,function(e){return e===t})||e.references&&_.any(e.references,function(e){return e===t})||e.iscontainedinside&&_.any(e.iscontainedinside,function(e){return e===t})}var i=/[.\[\]]+/;if(t!==n){t=t.replace(i,"_");var s=this.get("template.Resources["+t+"]");_.isUndefined(s)||(this.unset("template.Resources["+t+"]",{silent:!0}),n=n.replace(i,"_"),this.set("template.Resources["+n+"]",s,{silent:!0}));var o=s.Metadata[e.ComposerKey].id;_.forOwn(this.get("template.Resources"),function(n,i){if(!_.isUndefined(n.Metadata[e.ComposerKey])){var s=n.Metadata[e.ComposerKey].id,u=this.get("template.Metadata["+e.ComposerKey+"]["+s+"]");(u.parent===o||u.source&&u.source.id===o||u.target&&u.target.id===o||r(u,o))&&this.fixupRefs(i,u,t)}},this)}},updateResource:function(t,n,r,i){var s={};if(t&&n){var o=this.get("template"),u;if(o.hasOwnProperty("Resources")){var a=o.Resources;a.hasOwnProperty(n)&&(u=a[n])}if(u)if(_.isUndefined(u.Metadata)||_.isUndefined(u.Metadata[e.ComposerKey])||_.isUndefined(u.Metadata[e.ComposerKey].id)){var f=u.Metadata||{};f[e.ComposerKey]=f[e.ComposerKey]||{},f[e.ComposerKey].id=t,s["template.Resources["+n+"].Metadata["+e.ComposerKey+"].id"]=t,this.set(s)}var l=this.get("template.Metadata["+e.ComposerKey+"]["+t+"]");if(i&&(l==null||!_.isEqual(i,l))){s={},s["template.Metadata["+e.ComposerKey+"]["+t+"]"]=i,this.set(s);var c=!_.isEqual(_.pick(i,["parent","embeds","source","target","isassociatedwith","references","iscontainedinside","dependson"]),_.pick(l,["parent","embeds","source","target","isassociatedwith","references","iscontainedinside","dependson"]));u&&c&&this.fixupRefs(n,i)}}},getResourceProperty:function(e,t){return this.get("template.Resources["+e+"]["+t+"]")},updateResourceProperty:function(e,t,n){var r=this.get("template.Resources["+e+"]["+t+"]");_.isUndefined(r)?_.isEmpty(n)||(this.isChangingProps(!0),this.set("template.Resources["+e+"]["+t+"]",n),this.isChangingProps(!1)):(this.isChangingProps(!0),this.set("template.Resources["+e+"]["+t+"]",n),this.isChangingProps(!1))},getTemplateProperty:function(e){return this.get("template["+e+"]")},updateTemplateProperty:function(e,t){var n=this.get("template["+e+"]");!_.isUndefined(n)&&!_.isEqual(n,t)?(this.isChangingProps(!0),this.set("template["+e+"]",t),this.isChangingProps(!1)):_.isEmpty(t)||(this.isChangingProps(!0),this.set("template["+e+"]",t),this.isChangingProps(!1))},removeResources:function(e){_.each(e,function(e){this.removeResource(e)},this)},fixupMetadata:function(t){return _.isUndefined(t.Metadata)||_.isUndefined(t.Metadata[e.ComposerKey])?t:(_.forOwn(t.Metadata[e.ComposerKey],function(n,r){if(!_.any(t.Resources,function(t){return t.Metadata&&t.Metadata[e.ComposerKey]&&t.Metadata[e.ComposerKey].id&&t.Metadata[e.ComposerKey].id===r})){if(n.parent){var i=_.findIndex(t.Metadata[e.ComposerKey][n.parent].embeds,function(e){return e===r});t.Metadata[e.ComposerKey][n.parent].embeds.splice(i,1)}n.embeds&&_.each(n.embeds,function(n){t.Metadata[e.ComposerKey][n].parent&&delete t.Metadata[e.ComposerKey][n].parent}),delete t.Metadata[e.ComposerKey][r]}},this),t)},update:function(e){e=this.fixupMetadata(this.escapeDotNotation(e)),this.set("template",e)},escapeDotNotation:function(e){var t={};return e&&e.Resources&&(_.each(e.Resources,function(e,n){n=n.replace(/[.\[\]]+/,"_"),t[n]=e}),e.Resources=t),e},getBlockVisModel:function(){var r=this.get("template");if(r)try{var i=new t(r),s=new n(i);return s.applyLayout(this),window.AWSC.Clog.log(e.Metrics.TemplateRenderError,0,document.body.getAttribute("data-aws-account-id")),i}catch(o){return console.error("Unable to load block vis model:",o),window.AWSC.Clog.log(e.Metrics.TemplateRenderError,1,document.body.getAttribute("data-aws-account-id")),o.useragent=navigator.userAgent,window.clientReporting.error(e.Metrics.TemplateRenderError,o),undefined}return undefined}});return new i}),define("services/RegionService",[],function(){function e(){var e=document.getElementById("awsc-mezz-region");return e&&e.content||"us-east-1"}function t(){switch(e()){case"cn-north-1":case"cn-northwest-1":return"aws-cn";case"us-gov-east-1":case"us-gov-west-1":return"aws-us-gov";case"us-iso-east-1":case"us-iso-west-1":case"us-isob-east-1":return"aws-iso";default:return"aws"}}return{getRegion:e,getPartition:t}}),define("services/LocalizationService",["./RegionService"],function(e){function t(t){return e.getPartition()==="aws-cn"?t.replace("AWS","Amazon"):t}function n(e){return!e&&!_.has(window.localized,e)?"":t(window.localized[e])}return{localize:n,processString:t}}),define("models/Graph",["Constants","models/CloudFormation","services/LocalizationService"],function(e,t,n){var r=function(e,t){if(e.isLink())return;t.resize?t.resize.canceled?e.resize(t.resize.originalSize.width,t.resize.originalSize.height):(t.resize.canceled=!0,e.position(t.resize.originalPosition.x,t.resize.originalPosition.y),e.resize(t.resize.originalSize.width,t.resize.originalSize.height)):_.isUndefined(t.tx)||e.translate(-t.tx,-t.ty)},i=function(e,t){if(t.length){var n=this.findModelsInArea(e);return _.any(n,function(e){return _.contains(t,e)})}return!1},s=function(e,t){var n=_.filter(this.getElements(),function(t){return t.get("z")===e.get("z")&&t.id!==e.id&&(t.get("type")===e.get("type")||!t.get("relationships").IsContainedInside||!t.get("relationships").IsContainedInside["AWS::CloudFormation::Stack"])});return i.call(this,t||g.rect(e.getBBox()),n)},o=function(e){if(s.call(this,e))throw"Overlap"},u=function(e){var t=g.rect(e.getBBox()),n=!0;_.each(e.getEmbeddedCells(),function(e){if(_.isUndefined(e)||_.isNull(e))return;var r=g.rect(e.getBBox());t.containsRect(r)||(n=!1)});if(!n)throw"Children not contained"},a=function(e){var t=g.rect(e.getBBox()),n=this.getCell(e.get("parent"));if(n){var r=g.rect(n.getBBox());if(!r.containsRect(t))throw"Parent does not contain child"}};return joint.dia.Graph.extend({isWriting:!1,initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),_.bindAll(this,"addModel","addLink","fromJSON","resetCells","applyMetadata","updateConnections","writeAndNotify");var t={};this.listenTo(this,"batch:start",function(n){if(n&&n.batchName){if(n.batchName==="to-front"||n.batchName==="to-back"||n.batchName==="resize"||n.batchName==="rotate"||n.batchName==="remove"||n.batchName==="unembed"||n.batchName==="pointer")return;t.hasOwnProperty(n.batchName)||(t[n.batchName]=null),this.trigger("change:begin"),n.batchName.indexOf("cellPointer")!==0&&$.Topic(e.Topics.Composer.CFT.IsChanging).publish(!0)}},this),this.listenTo(this,"batch:stop",function(n){if(n&&n.batchName){if(n.batchName==="to-front"||n.batchName==="to-back"||n.batchName==="resize"||n.batchName==="rotate"||n.batchName==="remove"||n.batchName==="unembed"||n.batchName==="pointer")return;t.hasOwnProperty(n.batchName)&&(delete t[n.batchName],n.batchName.indexOf("cellPointer")!==0&&$.Topic(e.Topics.Composer.CFT.IsChanging).publish(!1),this.trigger("change:end"))}},this),this.listenTo(this,"change:size",this.onGraphCellChangeSizePos,this),this.listenTo(this,"change:position",this.onGraphCellChangeSizePos,this),this.listenTo(this,"change:source change:target change:parent change:embeds change:z",this.onMetadataChanged,this),this.listenTo(this,"change:isassociatedwith change:references change:iscontainedinside change:dependson",this.onMetadataChanged,this),this.listenTo(this,"add",this.onAddResource,this),this.listenTo(this,"remove",this.onRemoveResource,this),$.Topic(e.Topics.Composer.Vis.TemplateChanged).subscribe(_.bind(function(e){this.isWriting||this.updateVisModel({merge:e})},this)),$.Topic(e.Topics.Composer.Editor.FileLoaded).subscribe(_.bind(function(){this.updateVisModel({merge:!1})},this)),$.Topic(e.Topics.Composer.Editor.Clear).subscribe(_.bind(function(){this.clear()},this)),$.Topic(e.Topics.Composer.DirtyFlag.Toggle).subscribe(_.bind(function(e){e?this.isWriting=!0:this.isWriting=!1},this)),$.Topic(e.Topics.Composer.Vis.Refresh).subscribe(_.bind(function(){$.Topic(e.Topics.Composer.DirtyFlag.Toggle).publish(!1),this.updateVisModel()},this))},serialize:function(){var e=_.pick(this.toJSON(),"cells");return e},deserialize:function(e){return this.fromJSON(e)},updateConnections:function(n){var r=n.get("source");if(r)var i=this.getCell(r.id);var s=n.get("target");if(s)var o=this.getCell(s.id);if(i&&o){var u=i.get("resourceType"),a=o.get("resourceType"),f;_.contains(["Composer.aws-reflink","Composer.aws-dependencylink","Composer.aws-relatedtolink","Composer.aws-containedinsidelink"],n.get("type"))&&(f=relationshipTypesMap[u],_.isUndefined(f)&&(f=relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE]),_.each(e.RelationshipTypes,function(e){if(f.Relationships&&f.Relationships[e]){var n=f.Relationships[e][a]||f.Relationships[e]["*"];n&&(i.set(e.toLowerCase(),_.filter(i.get(e.toLowerCase())||[],function(e){return e!==o.id}),{silent:!0}),this.applyMetadata(i,t.updateResource))}},this),i.set("dependson",_.filter(i.get("dependson")||[],function(e){return e!==o.id}),{silent:!0}),this.applyMetadata(i,t.updateResource))}},onAddResource:function(e,n,r){if(r.suppressModelUpdate)return;e.get("embedded")==null&&this.applyMetadata(e,t.addOrUpdate)},onRemoveResource:function(n,r,i){n.get("embedded")&&_.isUndefined(i.auto)&&this.updateConnections(n);var s=n.getLogicalName();this.writeAndNotify(function(){t.removeResource(s,n.id),$.Topic(e.Topics.Composer.Vis.TemplateChanged).publish(!0)}),$.Topic(e.Topics.Composer.Vis.NodeRemoved).publish()},applyMetadata:function(n,r){function i(t,n){_.each(e.RelationshipTypes,function(e){var r=n.get(e.toLowerCase());r&&r.length&&(t[e.toLowerCase()]=r)})}var s;n.isLink()?s={source:n.get("source"),target:n.get("target"),z:n.get("z")}:(s={size:n.get("size"),position:n.get("position"),z:n.get("z"),parent:n.get("parent"),embeds:n.get("embeds")},i(s,n),n.get("relationships").IsContainedInside?_.each(n.get("iscontainedinside"),function(e){var r=this.getCell(e);if(r){var i=_.find(this.getLinks(),function(e){return e.get("type")==="Composer.aws-containedinsidelink"&&e.get("source").id===n.id&&e.get("target").id===r.id});if(r.getBBox().containsRect(n.getBBox()))i&&(i.remove({auto:!0}),t.removeResource(i.getLogicalName(),i.id));else if(!i&&n.get("relationships").IsContainedInside[r.get("resourceType")]){var s={References:r.get("resourceType"),PropertyName:n.get("relationships").IsContainedInside[r.get("resourceType")].PropertyName},o=new joint.shapes.Composer["aws-containedinsidelink"]({source:{id:n.id},target:{id:r.id},z:n.z,relationships:s,logicalName:"ref-"+(0|Math.random()*9e6).toString(36).toUpperCase()});this.addCell(o)}}},this):n.unset("iscontainedinside")),this.writeAndNotify(function(){r(n.id,n.getLogicalName(),n.get("resourceType"),_.omit(s,_.isUndefined)),$.Topic(e.Topics.Composer.Vis.TemplateChanged).publish(!0)})},updateVisModel:function(e){var n=_.extend({merge:!0},e||{});this.stopListening(this,"change:size",this.onGraphCellChangeSizePos,this),this.stopListening(this,"change:position",this.onGraphCellChangeSizePos,this),this.stopListening(this,"change:source change:target change:parent change:embeds change:z",this.onMetadataChanged,this),this.stopListening(this,"change:isassociatedwith change:references change:iscontainedinside change:dependson",this.onMetadataChanged,this),this.stopListening(this,"add",this.onAddResource,this),this.stopListening(this,"remove",this.onRemoveResource,this);var r=t.getBlockVisModel();r&&(this.fromJSON(r,n),_.each(r.links,function(e){this.addCell(e)},this)),this.listenTo(this,"change:source change:target change:parent change:embeds change:z",this.onMetadataChanged,this),this.listenTo(this,"change:isassociatedwith change:references change:iscontainedinside change:dependson",this.onMetadataChanged,this),this.listenTo(this,"add",this.onAddResource,this),this.listenTo(this,"remove",this.onRemoveResource,this),this.listenTo(this,"change:size",this.onGraphCellChangeSizePos,this),this.listenTo(this,"change:position",this.onGraphCellChangeSizePos,this)},resetCells:function(e,t){if(t&&t.merge){var n=_.map(e,this._prepareCell,this),r=this.get("cells");return r.set(n,_.extend({merge:!0,add:!0},t)),this}return joint.dia.Graph.prototype.resetCells.apply(this,arguments)},addModel:function(t,r,s,o){var u=new(joint.shapes.Composer[t.replace(/::/g,"-").toLowerCase()])({resourceType:t,position:s,logicalName:r||(0|Math.random()*9e6).toString(36).toUpperCase()});if(o){var a=o.getBBox(),f=a.x+a.width,l=a.y+a.height,c=u.get("size"),h=u.get("minSize")||{width:70,height:70};if(s.x+c.width>f||s.y+c.height>l){s.x+c.width>f&&(c.width=f-s.x-10),s.y+c.height>l&&(c.height=l-s.y-10);if(c.width<h.width||c.height<h.height)throw n.localize("resource_size_error")}var p=o.getEmbeddedCells();if(i.call(this,g.rect(s.x,s.y,c.width,c.height),p)){var d,v;for(d=c.width,v=c.height;d>=h.width||v>=h.height;d<v?d-=0:d-=10,v<d?v-=0:v-=10)if(!i.call(this,g.rect(s.x,s.y,d,v),p))break;if(d<h.width||v<h.height)throw"Will overlap sibling resources";c.width=d,c.height=v}return u.set({size:c,z:o.get("z")+1},{silent:!0}),_.has(relationshipTypesMap[t].Relationships.IsContainedInside,o.get("resourceType"))&&u.set({iscontainedinside:[o.id]},{silent:!0}),this.addCell(u),o.embed(u),$.Topic(e.Topics.Composer.Vis.ResourceDropped).publish(u.getLogicalName()),u}return u.set("z",0,{silent:!0}),this.addCell(u),$.Topic(e.Topics.Composer.Vis.ResourceDropped).publish(u.getLogicalName()),u},addLink:function(e,n,r,i,s){var o=new(joint.shapes.Composer[e.replace(/::/g,"-").toLowerCase()])({source:r,target:i,logicalName:n});return!_.isUndefined(s)&&_.isFunction(s)&&s(o),this.addCell(o),t.addModel(),o},onMetadataChanged:function(e,n,r){if(r&&r.skipParentHandler)return;this.applyMetadata(e,t.updateResource)},onGraphCellChangeSizePos:function(e,n,i){if(i.skipParentHandler)return;try{i.resize&&(o.apply(this,arguments),u.apply(this,arguments),a.apply(this,arguments)),e.set("originalPosition",e.get("position")),e.set("originalSize",e.get("size")),this.applyMetadata(e,t.updateResource)}catch(s){this.off("change:size",this.onGraphCellChangeSizePos,this),this.off("change:position",this.onGraphCellChangeSizePos,this),r(e,i),this.on("change:size",this.onGraphCellChangeSizePos,this),this.on("change:position",this.onGraphCellChangeSizePos,this)}},updateLogicalName:function(n,r){this.writeAndNotify(function(){t.updateLogicalName(n,r),$.Topic(e.Topics.Composer.Vis.TemplateChanged).publish(!0)})},writeAndNotify:function(e){this.isWriting=!0,e(),this.isWriting=!1}})}),define("views/ZoomControls",["Constants"],function(e){return Backbone.View.extend({className:"zoom-toolbar",template:$("#slider-template").html(),events:{"click .control-zoom-in":"zoomIn","click .control-zoom-out":"zoomOut","click .zoom-scale":"zoomToValue","click .zoom-center":"zoomExtent"},initialize:function(e){if(!e.svg)return!1;e.uid&&(this.template=this.template.replace(/(SVGID_\d\d?_)/g,"$1"+e.uid)),this.canvas=e.svg,this.viewport=e.viewport,_.bindAll(this,"render","zoomOut","zoomIn","zoomToValue","zoomCanvas","zoomed","interpolateZoom","setSlider","enableZoom","resetZoom"),this.zoom=d3.behavior.zoom().scaleExtent([.2,3]).on("zoom",this.zoomed),this.initialScale=this.zoom.scale(),this.yScale=d3.scale.linear().rangeRound([220,0]).domain(this.zoom.scaleExtent()).clamp(!0),d3.select(this.canvas).attr("preserveAspectRatio","xMidYMid meet").call(this.zoom).on("dblclick.zoom",null)},render:function(){this.$el.html(this.template);var e=this.zoom.scale(),t=this;return this.active=!0,this.zoomSlider=this.$el.find(".zoom-slider"),this.setSlider(e),d3.select(this.zoomSlider[0]).call(d3.behavior.drag().on("drag",function(){e=t.yScale.invert(Math.round(d3.event.y)),t.setSlider(e)}).on("dragend",function(){e=t.yScale.invert(Math.round($(".zoom-slider").position().top-$(".zoom-scale").position().top-4)),t.zoomCanvas(e)})),this},zoomed:function(){if(this.active){var t=this.zoom.translate(),n=this.zoom.scale();d3.event&&d3.event.sourceEvent&&(d3.event.sourceEvent.type==="wheel"||d3.event.sourceEvent.type==="mousewheel")&&this.setSlider(n),d3.select(this.viewport).attr("transform","translate("+t+")scale("+n+")")}$.Topic(e.Topics.Composer.Vis.Zoomed).publish()},zoomIn:function(){var e=this.yScale.range()[1],t=d3.transform(this.zoomSlider.attr("transform")).translate,n=t[1]-11<e?e:t[1]-11,r=this.yScale.invert(n);return this.setSlider(r),this.zoomCanvas(r),!1},zoomOut:function(){var e=this.yScale.range()[0],t=d3.transform(this.zoomSlider.attr("transform")).translate,n=t[1]+11>e?e:t[1]+11,r=this.yScale.invert(n);return this.setSlider(r),this.zoomCanvas(r),!1},zoomExtent:function(){var e={cH:$(this.canvas).height(),cW:$(this.canvas).width(),box:this.viewport.getBBox()},t=e.cH/e.box.height<e.cW/e.box.width?e.cH/e.box.height:e.cW/e.box.width;t=t>this.zoom.scaleExtent()[1]?this.zoom.scaleExtent()[1]:t,t=t<this.zoom.scaleExtent()[0]?this.zoom.scaleExtent()[0]:t;var n=[-(e.box.x*t)+(e.cW-e.box.width*t)/2,-(e.box.y*t)+(e.cH-e.box.height*t)/2];this.setSlider(t),this.interpolateZoom(n,t)},zoomToValue:function(e){var t=e.pageY-$(".zoom-scale").offset().top-12,n=this.yScale.invert(Math.round(t));return this.setSlider(n),this.zoomCanvas(n),!1},interpolateZoom:function(e,t){var n=d3.select(this.canvas),r=this.zoom;return d3.transition().duration(750).tween("zoom",function(){var i=d3.interpolate(r.translate(),e),s=d3.interpolate(r.scale(),t);return function(e){n.call(r.scale(s(e)).translate(i(e)).event)}})},zoomCanvas:function(e){var t=d3.select(this.canvas);t.call(this.zoom.event);var n=[$(this.canvas).width()/2,$(this.canvas).height()/2],r=this.zoom.translate(),i=this.coordinates(n);this.zoom.scale(e);var s=this.point(i);this.zoom.translate([r[0]+n[0]-s[0],r[1]+n[1]-s[1]]),t.transition().duration(750).call(this.zoom.event)},coordinates:function(e){var t=this.zoom.scale(),n=this.zoom.translate();return[(e[0]-n[0])/t,(e[1]-n[1])/t]},point:function(e){var t=this.zoom.scale(),n=this.zoom.translate();return[e[0]*t+n[0],e[1]*t+n[1]]},setZoomCanvas:function(e,t){this.zoom.size([e,t])},setSlider:function(e){this.zoomSlider.attr("transform","translate(0,"+this.yScale(e)+")")},enableZoom:function(e){this.active=e,e?(this.zoom.scale(this.savedScale),this.zoom.translate(this.savedTranslate)):(this.savedScale=this.zoom.scale(),this.savedTranslate=this.zoom.translate())},resetZoom:function(){this.zoomCanvas(this.initialScale),this.setSlider(this.initialScale)},getZoomExtent:function(){var t={cH:$(this.canvas).height(),cW:$(this.canvas).width(),box:this.viewport.getBBox()},n=t.cH/t.box.height<t.cW/t.box.width?t.cH/t.box.height:t.cW/t.box.width;n=n>this.zoom.scaleExtent()[1]?this.zoom.scaleExtent()[1]:n,n=n<this.zoom.scaleExtent()[0]?this.zoom.scaleExtent()[0]:n;var r=e.ScalingConstant/n,i=[-(t.box.x*r)+(t.cW-t.box.width*r)/2,-(t.box.y*r)+(t.cH-t.box.height*r)/2];return{zoomCenter:i,centerScale:n,scale:r}}})}),define("utils/RegionUtils",[],function(){function e(){var e=$(location).attr("href"),t=/region=([a-zA-Z0-9\-]+)/.exec(e);return t[1]}return{getRegion:e}}),define("views/Halo",["Constants","JST","utils/RegionUtils"],function(e,t,n){return Backbone.View.extend({template:t["templates/halo.html"],events:{"click #properties":"onEditProperties","click #duplicate":"onDuplicate","click #deletenode":"onDelete","click #helpnode":"onHelp"},initialize:function(t){_.bindAll(this,"render","reposition","remove","onEditProperties","onDuplicate","onDelete","onHelp"),this.listenTo(this.model,"change:position",this.reposition),this.svg=t.target,$.Topic(e.Topics.Composer.Vis.Zoomed).subscribe(this.reposition),this.tip=d3.tip().direction("w").offset(function(){return[0,-10]}).attr("class","halo").attr("id","halo_"+this.model.id),d3.select(t.paper.svg).call(this.tip)},render:function(){return this.tip.html(_.bind(function(){return this.template()},this)),_.defer(_.bind(function(){this.reposition()},this)),this.$el=$("#halo_"+this.model.id),this.delegateEvents(),this},reposition:function(){this.tip!=null&&this.tip.show({},this.svg)},remove:function(){this.tip!=null&&(this.tip.destroy(),delete this.tip),Backbone.View.prototype.remove.call(this)},onDelete:function(){$.Topic(e.Topics.Composer.Vis.Delete).publish(this.model.id),this.remove()},onHelp:function(){if(_.has(resourceSpecification.ResourceTypes,this.model.attributes.resourceType)){var e=resourceSpecification.ResourceTypes[this.model.attributes.resourceType].Documentation,t={"cn-north-1":"https://docs.amazonaws.cn/","cn-northwest-1":"https://docs.amazonaws.cn/","us-iso-east-1":"https://docs.c2shome.ic.gov/","us-iso-west-1":"https://docs.c2shome.ic.gov/","us-isob-east-1":"https://docs.sc2shome.sgov.gov/"},r="https://docs.aws.amazon.com",i=n.getRegion();_.has(t,i)&&(e=e.replace(r,t[i]));var s="docs_cfn_console_designer";window.open(e+"?icmpid="+s)}else{var o=$("#docs-endpoint").attr("href"),u=this.model.attributes.resourceType.toLowerCase().replace(/::/g,"-");window.open(o+"/"+u)}this.remove()},onEditProperties:function(){$.Topic(e.Topics.Composer.Vis.EditProperties).publish(this.model.attributes.logicalName),this.remove()},onDuplicate:function(t){t.stopPropagation(),$.Topic(e.Topics.Composer.Vis.Duplicate).publish(this.model.id),this.remove()}})}),define("views/ResizableElement",["Constants","views/Halo","services/LocalizationService"],function(e,t,n){function r(e){switch(e){case"origin":return"corner";case"corner":return"origin";case"topRight":return"bottomLeft";case"bottomLeft":return"topRight";default:return"origin"}}var i=joint.dia.ElementView.extend(joint.shapes.basic.PortsViewInterface);return i.extend({initialize:function(){i.prototype.initialize.apply(this,arguments),_.bindAll(this,"calculateResize","resize","remove","removeResizer","removeHalo","select","elementRemoved","startResizing","stopResizing","update","updateResizer","pointermove","pointerdown"),this.listenTo(this,"cell:unhighlight",this.removeResizer),this.listenTo(this.model,"remove destroy",this.elementRemoved),this.resizable=this.model.get("resizable"),this.resizable&&($(document.body).on("mousemove",this.calculateResize),$(document).on("mouseup",this.stopResizing)),$.Topic(e.Topics.Composer.Vis.Undo).subscribe(this.removeResizer),$.Topic(e.Topics.Composer.Vis.Undo).subscribe(this.removeHalo),$.Topic(e.Topics.Composer.Vis.Redo).subscribe(this.removeHalo),$.Topic(e.Topics.Composer.ClearCurrent).subscribe(this.removeResizer),$.Topic(e.Topics.Composer.Vis.Zoomed).subscribe(this.removeResizer)},render:function(){i.prototype.render.apply(this,arguments)},removeResizer:function(){this.resizer!=null&&(this.resizer.remove(),delete this.resizer)},removeHalo:function(){this.halo!=null&&(this.halo.remove(),delete this.halo)},elementRemoved:function(){this.removeResizer(),this.removeHalo(),this.remove()},remove:function(){this.resizable&&($(document.body).off("mousemove",this.calculateResize),$(document).off("mouseup",this.stopResizing)),joint.dia.ElementView.prototype.remove.apply(this,arguments)},removeElement:function(){var e=this.model.getEmbeddedCells();e&&e.length===0?confirm(n.localize("delete_confirm"))&&this.model.remove():alert(n.localize("nested_resource"))},stopResizing:function(){this.resizing&&(this.resizing=!1,this.resizeOptions=null,this.model.trigger("batch:stop",{batchName:"resizing"}))},startResizing:function(e){e.stopPropagation(),this.model.trigger("batch:start",{batchName:"resizing"});var t=$(e.target).data("box-corner"),n=0,i=0;switch(t){case"bottomLeft":n=-1,i=1;break;case"topRight":n=1,i=-1;break;case"origin":n=-1,i=-1;break;case"corner":n=1,i=1}return this.resizeOptions={angle:0,resizeX:n,resizeY:i,selectedCorner:r(t)},this.resizing=!0,!1},calculateResize:function(t){if(this.resizing){t=joint.util.normalizeEvent(t),t.stopPropagation();var n=this.paper.snapToGrid({x:t.clientX,y:t.clientY}),r=this.model.getBBox(),i=r[this.resizeOptions.selectedCorner](),s=r.center(),o=g.point(n).rotate(s,0).difference(i),u=this.resizeOptions.resizeX?o.x*this.resizeOptions.resizeX:r.width,a=this.resizeOptions.resizeY?o.y*this.resizeOptions.resizeY:r.height,f=this.paper.options.gridSize;u=f>u?f:g.snapToGrid(u,f),a=f>a?f:g.snapToGrid(a,f),a<e.ELEMENT_MIN_HEIGHT&&(a=e.ELEMENT_MIN_HEIGHT),u<e.ELEMENT_MIN_WIDTH&&(u=e.ELEMENT_MIN_WIDTH);if(r.width!==u||r.height!==a)this.model.resize(u,a,{selectedCorner:this.resizeOptions.selectedCorner}),this.updateResizer()}},resize:function(){var e=this.model.get("size")||{width:1,height:1},t=V(this.$("rect")[0]);if(!t)return;t.attr("width",e.width),t.attr("height",e.height)},update:function(){i.prototype.update.apply(this,arguments)},updateResizer:function(){if(this.resizer!==undefined){var e=this.getBBox(),t={width:e.width+4,height:e.height+4,left:e.x,top:e.y};this.resizer.css(t)}},select:function(){this.highlight(),$(".resizer").hide(),this.resizable&&(this.resizer===undefined&&(this.resizer=$($("#resizer-template").html()).appendTo("#paper").data("model-id",this.model.id).off("mousedown",this.startResizing).on("mousedown",this.startResizing).off("mouseup",this.stopResizing).on("mouseup",this.stopResizing)),this.resizer.show(),this.updateResizer(),this.resizing=!1),this.translate=!1},showHalo:function(e){this.halo=new t({model:this.model,target:this.el,paper:e}),this.halo.render()},pointerup:function(){this.translate&&(this.translate=!1,this.model.trigger("batch:stop",{batchName:"translate"})),joint.dia.ElementView.prototype.pointerup.apply(this,arguments),this.resizer!==undefined&&this.updateResizer()},pointermove:function(){if(this.halo!==undefined)return;joint.dia.ElementView.prototype.pointermove.apply(this,arguments),this.resizer!==undefined&&this.updateResizer(),!this.resizing&&!this.translate&&!this._linkView&&(this.model.trigger("batch:start",{batchName:"translate"}),this.translate=!0)},pointerdown:function(){joint.dia.ElementView.prototype.pointerdown.apply(this,arguments),this.select()}})}),define("views/ComposerLinkView",[],function(){return joint.dia.LinkView.extend({onEndModelChange:function(e,t,n){var r=!n.cacheOnly,i=this.model.get(e)||{};if(t){var s=this.constructor.makeSelector(i),o=e==="source"?"target":"source",u=this.model.get(o)||{},a=u.id&&this.constructor.makeSelector(u);if(n.isLoop&&s===a)this[e+"BBox"]=this[o+"BBox"],this[e+"View"]=this[o+"View"],this[e+"Magnet"]=this[o+"Magnet"];else{var f=this.paper.findViewByModel(i.id);if(f){var l=f.el.querySelector(s);this[e+"BBox"]=f.getStrokeBBox(l),this[e+"View"]=f,this[e+"Magnet"]=l}}n.isLoop&&n.translateBy&&this.model.isEmbeddedIn(t)&&!_.isEmpty(this.model.get("vertices"))&&(r=!1);if(!this.updatePostponed&&u.id){var c=this.paper.getModelById(u.id);n.isLoop=i.id===u.id;if(n.isLoop||n.translateBy&&c.isEmbeddedIn(n.translateBy))this.updatePostponed=!0,r=!1}}else this[e+"BBox"]=g.rect(i.x||0,i.y||0,1,1),this[e+"View"]=this[e+"Magnet"]=null;this.lastEndChange=e,r&&this.update()},hide:function(){this.model.attr("./opacity",.05),this.update()},show:function(){this.model.attr("./opacity",1),this.update()},pointerdown:function(){joint.dia.LinkView.prototype.pointerdown.apply(this,arguments),this.highlight()}})}),define("utils/UndoManager",["Constants"],function(e){return function(t){var n=Backbone.Model.extend({defaults:{isChanging:!1,isChangingProps:!1},initialize:function(){$.Topic(e.Topics.Composer.CFT.IsChanging).subscribe(_.bind(function(e){this.set("isChanging",e)},this)),$.Topic(e.Topics.Composer.CFT.IsChangingProps).subscribe(_.bind(function(e){this.set("isChangingProps",e)},this))}}),r=new Backbone.UndoManager,i=t.get("template");r.changeUndoType("change",{on:function(){}}),r.changeUndoType("remove",{on:function(){}}),r.changeUndoType("add",{on:function(){}}),r.addUndoType("change:isChangingProps",{on:function(e,n){if(!n){var s=t.get("template");_.isEqual(i,s)===!1&&r.stack.pointer>-1&&(r.stack.models[r.stack.pointer].attributes.after=s)}},undo:function(){},redo:function(){}}),r.addUndoType("change:isChanging",{on:function(n,r){if(r)i=t.get("template");else{var s=t.get("template");if(_.isEqual(i,s)===!1)return $.Topic(e.Topics.Composer.Designer.UndoRedoReset).publish(!0,!1),{object:t,before:i,after:s}}},undo:function(e,n){t.set("template",n,{silent:!0}),i=n},redo:function(e,n,r){t.set("template",r,{silent:!0}),i=r}});var s=new n;return r.register(s),r.on("undo redo",function(){var t=this.stack.pointer>=0,n=this.stack.pointer<this.stack.length-1;$.Topic(e.Topics.Composer.Vis.TemplateChanged).publish(!0),$.Topic(e.Topics.Composer.Designer.OnUndoRedo).publish(t,n)}),r.stack.on("reset",function(){$.Topic(e.Topics.Composer.Designer.UndoRedoReset).publish(!1,!1)}),r.startTracking(),$.Topic(e.Topics.Composer.Designer.UndoRedoReset).publish(!1,!1),$.Topic(e.Topics.Composer.Vis.Redo).subscribe(function(){r.redo()}),$.Topic(e.Topics.Composer.Vis.Undo).subscribe(function(){r.undo()}),$.Topic(e.Topics.Composer.Vis.RewindUndo).subscribe(function(e){e===undefined&&(e=1);var t;for(t=0;t<e;t++)r.stack.pop(),r.stack.pointer--}),$.Topic(e.Topics.Composer.Editor.FileLoaded).subscribe(function(){r.clear()}),r}}),define("views/Paper",["Constants","models/CloudFormation","models/Graph","views/ZoomControls","views/ResizableElement","views/ComposerLinkView","utils/UndoManager","services/LocalizationService"],function(e,t,n,r,i,s,o,u){function f(e){return e.EntityType!=="Link"}function l(e,t){return t.EntityType!=="Link"}function c(e){if(e===undefined)return;e.set("startPos",e.get("position"),{silent:!0});var t=e.get("embeds");if(t&&t.length)for(var n=0;n<t.length;n++)c(e.collection.get(t[n]))}function h(t){t.set("position",t.get("startPos"),{silent:!0});var n=t.get("embeds");if(n&&n.length)for(var r=0;r<n.length;r++)h(t.collection.get(n[r]));$.Topic(e.Topics.Composer.Vis.RewindUndo).publish()}function p(){$("#introWatermark").hide()}var a=function(e){var t="",n,r,i=e.match("AWS::(.*)::(.*)");return!_.isNull(i)&&i.length>2&&(n=i[1],r=i[2],t=n.replace(/[a-z]/g,"")+r.replace(/[a-z]/g,"")),t.length>7&&(t=t.substr(0,7)),t+(0|Math.random()*9e6).toString(36).toUpperCase()};return joint.dia.Paper.prototype.drop=function(t){t.preventDefault(),t.stopPropagation(),p();var n=this.model,r=t.dropX-$("#paper").offset().left,i=t.dropY-$("#paper").offset().top,s=this.viewport.getCTM(),o={x:(r-s.e)/s.a,y:(i-s.f)/s.d},c=relationshipTypesMap[t.resourceType]||relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE],h=_.sortBy(n.findModelsFromPoint(g.point(o.x,o.y)),function(e){return e.get("z")}),d,v;n.trigger("batch:start",{batchName:"element-drop"});if(h.length===0&&f(c))switch(c.EntityType){case"Container":case"Element":d=a(t.resourceType);try{v=n.addModel(t.resourceType,d,o)}catch(m){$.Topic(e.Topics.Composer.Message).publish(u.localize("invalid_action"),u.localize("invalid_drop")+": "+m)}break;case"EmbeddedElement":throw"Not implemented"}else if(h.length>0&&l(_.last(h).get("resourceType"),c)){var y=_.last(h);switch(c.EntityType){case"Container":case"Element":d=a(t.resourceType);try{v=n.addModel(t.resourceType,d,o,y)}catch(m){$.Topic(e.Topics.Composer.Message).publish(u.localize("invalid_action"),u.localize("invalid_drop")+": "+m)}break;case"EmbeddedElement":throw"Not Implemented"}}else $.Topic(e.Topics.Composer.Message).publish(u.localize("invalid_action"),u.localize("invalid_embedded"));n.trigger("batch:stop",{batchName:"element-drop"})},function(f,d,v){function b(e){if(e===undefined)return;var t=$(".fileNameTitle"),n=u.localize("file")+": '"+_.escape(e)+"'";t.length>0?$(".fileNameTitle").html(n):$("#designer").append($("<div class='fileNameTitle'>"+n+"</div>"))}function T(){var e=y.$("#introWatermark");e.length>0?e.show():(e=$("<h1 />",{id:"introWatermark",text:u.localize("intro_message")}),y.$el.append(e))}function N(){_.each($(".element.highlighted, .link.highlighted"),function(e){var t=$(e).data("view");t&&t.unhighlight()})}function C(t){_.each(m.get("cells").models,function(e){if(t&&t.model.id===e.id)return;var n=e.findView(y);n&&n.unhighlight()}),t===undefined&&$.Topic(e.Topics.Composer.Vis.TemplateSelected).publish()}var m=new n,y=new joint.dia.Paper({el:$(f),width:d,height:v,gridSize:10,model:m,snapLinks:!1,interactive:{vertexAdd:!1,vertexRemove:!1},elementView:i,linkView:s,async:!1,markAvailable:!0,perpendicularLinks:!1,linkConnectionPoint:joint.util.shapePerimeterConnectionPoint,clickThreshold:1,defaultLink:function(e,t){var n=V(t).attr("port");if(n){var r;if(n.indexOf("-")>-1){var i=n.split("-"),s;i[1].indexOf("/")>-1?s=i[1].split("/"):s=i[1];var o=i[i.length-1];r=new(joint.shapes.Composer[i[0].replace(/::/g,"-").toLowerCase()])({logicalName:"ref-"+a(i[0]),relationships:{References:s,PropertyName:o}})}else r=new(joint.shapes.Composer[n.replace(/::/g,"-").toLowerCase()])({logicalName:a(n)});return r}},validateConnection:function(t,n,r){if(t===r)return;var i=t.model.get("resourceType"),s=r.model.get("resourceType");if(i!=null&&s!=null){var o=V(n).attr("port");if(o.indexOf("-")>-1){var u=o.split("-")[1];return u.indexOf("/")>-1?_.any(u.split("/"),function(e){return e===s}):u==="*"||s===u}var a=relationshipTypesMap[o];_.isUndefined(a)&&(a=relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE]);if(a.Relationships!=null&&a.Relationships.References!=null){var f=Object.keys(a.Relationships.References);return f.length===0?!1:f.length===1?f[0]===s:_.any(_.transform(a.Relationships.References,function(e,t,n){if(n!==i&&t.Endpoint===undefined||t.Endpoint==="Target")e[n]=t}),function(e,t){return t===s})}}return!1}});y.$el.on("contextmenu",".element",function(e){e.preventDefault()});var w=o(t),E=new r({svg:y.svg,viewport:y.viewport,uid:"paper"});$(f).append(E.render().el);var S=_.debounce(function(){var e=$("#designer");y.setDimensions(e.width(),e.height()),E.setZoomCanvas(e.width(),e.height())},100);$.Topic(e.Topics.Composer.ClearCurrent).subscribe(function(){w.clear(),E.resetZoom(),T(),y.$("#out-of-date").length&&y.$("#out-of-date").hide()});var x=!1;y.on("render:done",function(){x&&(x=!1)}),T(),$.Topic(e.Topics.Composer.Vis.Refresh).subscribe(function(){p()}),$.Topic(e.Topics.Composer.Editor.FileLoaded).subscribe(function(e){x=!0;var t=$("#designer");y.setDimensions(t.width(),t.height()),E.setZoomCanvas(t.width(),t.height()),E.zoomExtent(),w.clear(),b(e),p()}),$.Topic(e.Topics.Composer.Splitter.Resize).subscribe(S),$.Topic(e.Topics.Composer.Vis.ResourceDropped).subscribe(function(t){var n=_.find(m.get("cells").models,function(e){return e.getLogicalName()===t});if(n){var r=y.findViewByModel(n);r&&typeof r.select=="function"&&(N(),r.select(),$.Topic(e.Topics.Composer.Vis.NodeSelected).publish(t,n.id))}}),y.on("blank:pointerdown",function(){C();var e=m.get("cells").models;_.each(e,function(e){var t=y.findViewByModel(e);t&&typeof t.removeHalo=="function"&&t.removeHalo()})});var k=d3.tip().attr("class","vis-tip").html(function(t){return t.type?t.type==="AWS::DependencyLink"&&t.target==="*"?e.LinkTypes.DependsOn:t.target?t.propertyName?t.target+" (Property: "+t.propertyName+")":t.target:t.type:typeof t.tooltip=="function"?t.tooltip():undefined});d3.select(y.svg).call(k),y.on("cell:mouseover",function(e,t){document.onselectstart=function(){return!1};if(L===undefined||!L)if(V(t.target).hasClass("port-body")){var n=V(t.target).attr("port").split("-");k.direction("e").show({type:n[0],target:n[1],propertyName:n[2]},t.target)}else k.direction("n").show(e.model,t.currentTarget)}),y.on("cell:mouseout",function(){k.hide(),document.onselectstart=null});var L=!1;y.on("cell:pointerdown",function(t,n){return n.preventDefault(),n.stopPropagation(),k.hide(),m.trigger("batch:start",{batchName:"cellPointer"}),n.button===2&&!t.model.isLink()?(_.each(m.get("cells").models,function(e){var t=y.findViewByModel(e);t&&typeof t.removeHalo=="function"&&t.removeHalo()}),typeof t.showHalo=="function"&&t.showHalo(y)):(typeof t.removeHalo=="function"&&t.removeHalo(),L=!0,C(t),c(t.model)),$.Topic(e.Topics.Composer.Vis.CanvasChanging).publish(!0),!1}),y.on("cell:pointerup",function(t){if(L){L=!1;var n=t.model;if(!n.isLink()){var r=_.sortBy(_.filter(m.getElements(),function(e){return!n.isLink()&&e.getBBox().containsRect(g.rect(n.getBBox()))}),function(e){return e.get("z")}).reverse();if(r.length){var i=_.find(r,function(e){return e.id!==n.id}),s=relationshipTypesMap[n.get("resourceType")]||relationshipTypesMap[e.ResourceTypes.AWS_CLOUDFORMATION_CUSTOMRESOURCE];if(i)if(i.get("parent")===n.id||n.get("parent")!==undefined&&i.id===n.get("parent"))i.get("parent")!==n.id&&(n.get("parent")!==undefined||i.id===n.get("parent"))&&n.set("z",i.get("z")+1);else if(l(i.get("resourceType"),s)){var o=m.getCell(n.get("parent"));o&&o.unembed(n);var a=s.Relationships.IsContainedInside;if(a&&a[i.get("resourceType")]){var f=n.get("iscontainedinside")||[];_.contains(f,i.id)||(f.push(i.id),n.set("iscontainedinside",f)),a[i.get("resourceType")].Arity!=="Many"&&_.each(m.getLinks(),function(e){e.get("type")==="Composer.aws-containedinsidelink"&&e.get("source").id===n.id&&m.getCell(e.get("target").id)&&m.getCell(e.get("target").id).get("resourceType")===i.get("resourceType")&&e.remove()})}i.embed(n),n.set("z",i.get("z")+1);var c=function(e){var t=e.get("z")+1;_.each(e.get("embeds"),function(e){var n=m.getCell(e);n.set("z",t),c(n)})};c(n)}else $.Topic(e.Topics.Composer.Message).publish(u.localize("invalid_action"),u.localize("invalid_embedded")),h(n);else if(l(null,s)){if(n.get("parent")){var p=m.getCell(n.get("parent"));p.unembed(n),n.set("z",0)}}else $.Topic(e.Topics.Composer.Message).publish(u.localize("invalid_action"),u.localize("invalid_embedded")),h(n)}}n.unset("startPos",{silent:!0});var d=n.get("type");if(_.contains(["Composer.aws-reflink","Composer.aws-dependencylink","Composer.aws-relatedtolink","Composer.aws-containedinsidelink"],d)){var v=m.getCell(n.get("source").id);if(typeof v.getLogicalName=="function"){var b=y.findViewByModel(v);b&&b.select(),$.Topic(e.Topics.Composer.Vis.NodeSelected).publish(v.getLogicalName(),v.id)}}else typeof n.getLogicalName=="function"&&$.Topic(e.Topics.Composer.Vis.NodeSelected).publish(n.getLogicalName(),n.id)}m.trigger("batch:stop",{batchName:"cellPointer"}),$.Topic(e.Topics.Composer.Vis.CanvasChanging).publish(!1)}),y.on("link:pointerup",function(){var t=m.getLinks();_.each(t,function(e){var t=e.get("source"),n=e.get("target");(t.id===undefined||n.id===undefined)&&e.remove({auto:!0})}),$.Topic(e.Topics.Composer.Vis.CanvasChanging).publish(!1)}),m.on("change:target",function(t){var n,r,i,s;if(t)if(t.get("embedded")){r=t.get("target");if(r&&r.id){var o=m.getCell(t.get("source").id),u=m.getCell(r.id);if(o&&u){var a=u.get("resourceType"),f=o.get("relationships"),l=_.findKey(f,function(e,n){var r=t.get("relationships");return _.any(Object.keys(e),function(e){return _.any(_.isArray(r.References)?r.References:[r.References],function(t){return e===a&&a===t})})});if(l){var c=f[l];if(c&&(c[a]||c["*"])){var h=c[a]||c["*"];_.isArray(h)&&(h=_.find(h,function(e){return e.PropertyName!==undefined}));if(h){var p=o.get(l.toLowerCase())||[];if(h.Arity==="Many"){if(_.indexOf(p,r.id)!==-1){t.remove({auto:!0});return}p.push(r.id)}else{if(o.get("parent")&&l===e.RelationshipTypes.IsContainedInside&&m.getCell(o.get("parent")).get("resourceType")===a){t.remove({auto:!0});return}if(_.indexOf(p,r.id)>-1){t.remove({auto:!0});return}var d=[];_.each(p,function(e){var n=_.find(m.getLinks(),function(n){var r=n.get("source"),i=n.get("target");return r&&r.id&&r.id===t.get("source").id&&i&&i.id&&i.id===e&&n.get("relationships").PropertyName===t.get("relationships").PropertyName});n?n.remove({auto:!0}):d.push(e)}),p=d,p.push(r.id)}var v=y.findViewByModel(t);v&&(n=t.get("source"),n.port=undefined,n.selector=undefined,v.render()),o.set(l.toLowerCase(),p,{silent:!0}),o.trigger("change:"+l.toLowerCase(),o)}else typeof console.error=="function"&&console.error("unable to determine link relationship")}}else{var p=o.get("dependson")||[];if(_.indexOf(p,r.id)!==-1){t.remove({auto:!0});return}p.push(r.id);var v=y.findViewByModel(t);v&&(n=t.get("source"),n.port=undefined,n.selector=undefined,v.render()),o.set("dependson",p,{silent:!0}),o.trigger("change:dependson",o)}}}}else{var g=t.get("target"),b=t.previous("target");if(g!=null&&g.id!=null&&b!=null&&b.id!==null&&g.id!==b.id){var w=t.get("relationships").References;w&&(r=m.getCell(g.id),r!=null&&(n=t.get("source"),n.port!==undefined&&(n.port=undefined,n.selector=undefined,i=m.getCell(t.id),i&&(s=y.findViewByModel(i),s&&s.render()))))}}}),m.on("change:begin",function(){E.enableZoom(!1)}),m.on("change:end",function(){E.enableZoom(!0)}),$.Topic(e.Topics.Composer.Vis.Duplicate).subscribe(function(t){m.trigger("batch:start",{batchName:"duplicate-elements"});var n=m.getCell(t),r=y.findViewByModel(n);if(r){var i=r.model.clone();if(!i.isLink()){var s=i.get("position"),o=a(i.get("resourceType"));s.x=s.x+20,s.y=s.y+20,i.set("position",s,{silent:!0}),i.setLogicalName(o)}m.addCell(i),r.unhighlight();var u=i.findView(y);u&&u.select(),$.Topic(e.Topics.Composer.Vis.TemplateChanged).publish(!0),$.Topic(e.Topics.Composer.Vis.ResourceDropped).publish(i.getLogicalName())}m.trigger("batch:stop",{batchName:"duplicate-elements"})}),$.Topic(e.Topics.Composer.File.UpdateFileName).subscribe(function(e){b(e)}),$.Topic(e.Topics.Composer.Vis.UpdateLogicalName).subscribe(function(e,t){var n=m.get("cells").models,r=_.find(n,function(t){return t.getLogicalName()===e});r&&(m.updateLogicalName(e,t),r.setLogicalName(t))}),$.Topic(e.Topics.Composer.Vis.Delete).subscribe(function(t){var n=m.getCell(t),r=y.findViewByModel(n);r&&(m.trigger("batch:start",{batchName:"delete-elements"}),r.model.isLink()?confirm(u.localize("delete_link_confirm"))&&r.model.remove():r.removeElement(),m.trigger("batch:stop",{batchName:"delete-elements"}),$.Topic(e.Topics.Composer.Vis.NodeRemoved).publish())}),y.on("link:confirmremove",function(t,n){$.Topic(e.Topics.Composer.Vis.Delete).publish(n.model.id)}),$.Topic(e.Events.Keypress.Delete).subscribe(function(t){t.preventDefault();var n=y.findView(".highlighted");n&&(k.hide(),typeof n.removeHalo=="function"&&n.removeHalo(),$.Topic(e.Topics.Composer.Vis.Delete).publish(n.model.id))});var A=function(e){var t=V(y.svg),n=t.defs(),r=n.findOne("#mask");r&&r.remove();var i=t.findOne("#viewportMask");i&&i.remove();if(e==null||e===!1||e.length===0)return;var s=V('<rect id="viewportMask" width="100%" height="100%" fill="rgba(68, 68, 68, 0.4)" mask="url(#mask)" pointer-events="none"></rect>'),o=V('<mask id="mask" x="0" y="0" width="100%" height="100%" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse"><rect width="100%" height="100%" fill="white"/></mask>');e.length&&_.each(e,function(e){var t=y.findViewByModel(e).el,n=t.getBBox(),r=t.getAttribute("transform"),i=/translate\(\s*([^\s,)]+)[ ,]([^\s,)]+)/.exec(r),s=i[1],u=i[2],a=V(t).findOne(".body");if(a){var f=a.clone(),l=V(y.viewport).attr("transform");f.attr("x",s),f.attr("y",u),l&&f.attr("transform",l),o.append(f)}else o.append(V('<rect width="'+n.width+'" height="'+n.height+'" x="'+s+'" y="'+u+'" ></rect>'))}),n.append(o),t.append(s)};$.Topic(e.Topics.Composer.ClearCurrent).subscribe(function(){A(!1)}),$.Topic(e.Topics.Composer.DirtyFlag.Toggle).subscribe(function(e){e?(y.$("#out-of-date").length===0&&y.$el.append($("<div>").attr("id","out-of-date").text(u.localize("refresh_designer")).css({display:"none",position:"absolute",top:"25px"})),y.$("#out-of-date").length&&y.$("#out-of-date").show(),A(!0)):(y.$("#out-of-date").length&&y.$("#out-of-date").hide(),A(!1))});var O=function(){var t=$(".fileNameTitle").html();return _.isNull(t)?t=e.DefaultImageFileName:(t=t.replace(/.*: /,""),t=t.replace(/'/g,""),t=t.replace(/\..*/,""),t+="-designer.png"),t};return $.Topic(e.Topics.Composer.ExportImage).subscribe(function(){var t=E.getZoomExtent();t=_.extend(t,{backgroundColor:e.ExportImageBackgroundColor});var n=O();saveSvgAsPng($("#paper").find("svg")[0],n,t)}),y}}),define("views/Designer",["Constants","models/CloudFormation","views/Paper"],function(e,t,n){var r=Backbone.View.extend({id:"designer",events:{mouseover:"focus",mouseout:"blur"},initialize:function(){_.bindAll(this,"render","focus","blur"),$(document).keydown(_.bind(function(e){this.onKeyPress(e)},this))},render:function(){var t=$(".ui-dialog:visible").find(".ui-dialog-content"),r=this.$el.find("#paper");t.length>0&&t.dialog("close"),r.hide();if(this.paper===undefined){var i=$('<div id="paper">');this.paper=n(i,600,400),this.$el.append(i)}else r.show();return $.Topic(e.Topics.Composer.Vis.TemplateSelected).publish(),this},onKeyPress:function(t){if(this.$el.attr("data-focus")==="true")if(t.ctrlKey)switch(t.keyCode){case 67:$.Topic(e.Events.Keypress.CtrlC).publish(t);break;case 68:$.Topic(e.Events.Keypress.CtrlD).publish(t);break;case 88:$.Topic(e.Events.Keypress.CtrlX).publish(t);break;case 89:$.Topic(e.Events.Keypress.CtrlY).publish(t);break;case 90:$.Topic(e.Events.Keypress.CtrlZ).publish(t)}else switch(t.keyCode){case 8:case 46:$.Topic(e.Events.Keypress.Delete).publish(t)}},getSelectedNode:function(){var e,t=null;return t=this.paper.findView(".highlighted"),e=t?t.model.getLogicalName():null,e},ctrld:function(t){$.Topic(e.Events.Keypress.CtrlD).publish(t)},ctrlc:function(t){$.Topic(e.Events.Keypress.CtrlC).publish(t)},ctrlx:function(t){$.Topic(e.Events.Keypress.CtrlX).publish(t)},ctrlz:function(t){$.Topic(e.Events.Keypress.CtrlZ).publish(t)},ctrly:function(t){$.Topic(e.Events.Keypress.CtrlY).publish(t)},focus:function(){this.$el.attr("data-focus",!0)},blur:function(){this.$el.attr("data-focus",!1)}});return new r({model:t})}),define("plugins/topic",[],function(){var e={};$.Topic=function(t){var n,r=t&&e[t];return r||(n=$.Callbacks(),r={publish:n.fire,subscribe:n.add,unsubscribe:n.remove},t&&(e[t]=r)),r}}),define("utils/Parser",["Constants","models/CfnFunction","plugins/topic"],function(e,t){function r(){return n}function i(e){n=e,$("#languageselect-"+e)[0].checked=!0}function s(t){return _.isEmpty(t)?n:t[0]==="{"?e.EditorMode.JSON:e.EditorMode.YAML}function a(t,r){return _.isEmpty(t)?{}:(r||(r=n),r===e.EditorMode.JSON?JSON.parse(t,f):jsyaml.safeLoad(t,{schema:u}))}function l(t,r){r||(r=n);if(r===e.EditorMode.JSON)return JSON.stringify(t,c,4);var i=jsyaml.safeDump(t,{schema:u}),s=/!<(!\w+)>/mg;return i.replace(s,"$1")}var n=e.EditorMode.JSON;$.Topic(e.Topics.Composer.Editor.SetLanguage).subscribe(i);var o=[];_.each(["scalar","sequence","mapping"],function(n){_.each(_.keys(e.Resolver.YamlTags),function(r){var i=e.Resolver.Fn+r;if(r===e.Resolver.YamlTags.Ref||r===e.Resolver.YamlTags.Condition)i=r;o.push(new jsyaml.Type("!"+r,{kind:n,construct:function(e){return new t(i,e)},instanceOf:t,represent:function(e){return e.data},predicate:function(e){return _.has(e,"isCfnFunction")&&e.type===i}}))})});var u=jsyaml.Schema.create(jsyaml.JSON_SCHEMA,o),f=function(n,r){if(_.isObject(r)&&_.keys(r).length===1){var i=_.keys(r)[0],s=i.replace(e.Resolver.Fn,"");if(e.Resolver.YamlTags[s])return new t(i,c("",r[i]))}return r},c=function(t,n){if(_.has(n,"isCfnFunction")){var r={};return n.type===e.Resolver.FnGetAtt&&_.isString(n.data)?r[n.type]=n.data.split("."):r[n.type]=n.data,r}return n};return{getLanguage:r,parse:a,setLanguage:i,detectLanguage:s,stringify:l}}),define("json-editor/Node",[],function(){function e(e,t){this.editor=e,this.dom={},this.expanded=!1,this.field="",this.value="",this.childs=[],t&&_.isObject(t)?(this.setField(t.field,t.fieldEditable),this.setValue(t.value,t.type)):(this.setField(""),this.setValue(null))}function n(e){if(e)while(e.length)this.removeChild(e[0])}function r(e){return!_.isUndefined(e)&&!_.isFunction(e)}function i(e,n){if(n[1].toLowerCase()!=="resources")return[];switch(n[3].toLowerCase()){case"type":return t;case"properties":var r=s(e,n);if(_.isObject(r))return _.keys(r)}return[]}function s(e,t){var n=resourceSpecification.ResourceTypes[e].Properties;if(n)for(var r=4;r<t.length;r++){var i=t[r],s;i!==""?s=n[i]:s=n[Object.getOwnPropertyNames(n)[0]],_.has(s,"ItemType")?s.ItemType!=="Tag"?n=resourceSpecification.PropertyTypes[e+"."+s.ItemType].Properties:n=resourceSpecification.PropertyTypes.Tag.Properties:_.has(s,"Type")&&!_.includes(["List","Map"],s.Type)?n=resourceSpecification.PropertyTypes[e+"."+s.Type].Properties:n=null}return n}function o(e,t){if(e)return[];switch(t.getField().toLowerCase().replace('"',"")){case"parameters":case"mappings":case"conditions":case"resources":case"outputs":case"description":return[];default:return[]}}function u(e,t){switch(t[1].toLowerCase().trim()){case"resources":return _.filter(["Type","Properties","CreationPolicy","DeletionPolicy","UpdatePolicy","DependsOn"],function(t){return _.indexOf(_.map(e.childs,function(e){return e.getField().toLowerCase().trim()}),t.toLowerCase().trim())===-1});case"parameters":return _.filter(["Type","Default","NoEcho","DeletionPolicy","AllowedValues","AllowedPattern","MaxLength","MinLength","MaxValue","MinValue","Description","ConstraintDescription"],function(t){return _.indexOf(_.map(e.childs,function(e){return e.getField().toLowerCase().trim()}),t.toLowerCase().trim())===-1});case"outputs":return _.filter(["Description","Value"],function(t){return _.indexOf(_.map(e.childs,function(e){return e.getField().toLowerCase().trim()}),t.toLowerCase().trim())===-1})}}function a(e,t,n){if(t[1].toLowerCase()==="resources"){var r=e.getAwsType();if(t[3].toLowerCase()==="type")return _.filter(i(r,t),function(t){return _.indexOf(_.map(e.childs,function(e){return e.getField()}),t)===-1});if(t[3].toLowerCase()==="properties"&&!n&&r){var s=resourceSpecification.ResourceTypes[r].Properties;if(s)return _.filter(Object.keys(s),function(t){switch(t){case"AllowCreationPolicy":case"AllowUpdatePolicy":case"AllowDeletionPolicy":return!1;default:return _.indexOf(_.map(e.childs,function(e){return e.getField()}),t)===-1}})}}}function f(e,t){var n=e.getAwsType();if(n){if(e.parent.type==="array")return _.filter(i(n,t),function(t){return _.indexOf(_.map(e.childs,function(e){return e.getField()}),t)===-1});if(e.parent.type==="object")return _.filter(i(n,t),function(t){return _.indexOf(_.map(e.childs,function(e){return e.getField()}),t)===-1})}}var t=_.keys(resourceSpecification.ResourceTypes).sort();return e.prototype.setField=function(e,t){this.field=e,this.fieldEditable=t===!0},e.prototype.setValue=function(t,i){var s,o;n(this.childs),_.isArray(t)?this.type="array":_.isObject(t)?this.type="object":this.type=i||this.type;if(i&&i!==this.type)throw new Error('Type mismatch: cannot cast value of type "'+this.type+' to the specified type "'+i+'"');switch(this.type){case"array":this.childs=[],_.each(t,function(t){r(t)&&(o=new e(this.editor,{value:t}),this.appendChild(o))}),this.value="";break;case"object":this.childs=[];for(var u in t)t.hasOwnProperty(u)&&(s=t[u],r(s)&&(o=new e(this.editor,{field:u,value:s}),this.appendChild(o)));this.value="";break;default:this.value=t}},e.prototype.setParent=function(e){this.parent=e},e.prototype.getValue=function(){return this.value},e.prototype.getField=function(){return this.field},e.prototype.getLevel=function(){return this.parent?this.parent.getLevel()+1:0},e.prototype.appendChild=function(e){e.setParent(this);if(this.type==="array"||this.type==="object")e.fieldEditable=this.type==="object",this.type==="array"&&(e.index=this.childs.length);this.childs.push(e)},e.prototype.removeChild=function(e){e.setParent(undefined),this.childs.splice(this.childs.indexOf(e),1)},e.prototype.getResourcePath=function(){var e=[],t=this;while(t){var n=t.field;_.isUndefined(n)||(n!==""||!t.parent||t.parent.type!=="array")&&e.unshift(n),t=t.parent}return e},e.prototype.getAutoComplete=function(e,t){var n=this;_.isUndefined(e)&&(e=n);var r=n.getResourcePath(),i=[];switch(r.length){case 0:break;case 1:i=_.filter(["AWSTemplateFormatVersion","Description","Parameters","Mappings","Conditions","Resources","Outputs"],function(e){return _.indexOf(_.map(n.childs,function(e){return e.getField()}),e)===-1});break;case 2:i=o(t,n);break;case 3:i=u(n,r);break;case 4:i=a(n,r,t);break;default:i=f(n,r)}return i},e.prototype.findChildNodeByKey=function(e){var t=this;if(t.childs&&t.childs.length)return _.find(t.childs,function(t){var n=t.getField();return n?n.toLowerCase()===e.toLowerCase():!1})},e.prototype.getAwsType=function(){var e=this,t;while(_.isUndefined(e.getField())||e.getField()!=="resources"&&e.getLevel()>1){var n=e.findChildNodeByKey("Type");n!=null&&(t=n.getValue().replace(/^"|"$/g,"").trim());if(e.parent==null)break;e=e.parent}return t},e}),define("views/Editor",["Constants","models/CloudFormation","services/LocalizationService","utils/Parser","json-editor/Node"],function(e,t,n,r,i){function s(t,n,i){var s=[],u,a;for(u=0;u<t.length;u++)if(t[u]!=null){t[u].length===0&&t[u].push({value:""});for(a=0;a<t[u].length;a++){var f=t[u][a];u===n&&a===i?f.current=!0:f.current=!1,f.value.trim()!==""?f.type==="paren.lparen"||f.type==="paren.rparen"?o(f.type,s,f):s.push(f):(f.current||r.getLanguage()===e.EditorMode.YAML)&&s.push(f)}}return s}function o(e,t,n){var r;if(n.value.trim().length===1)t.push(n);else for(r=0;r<n.value.trim().length;r++){var i=n.value.trim().split("")[r];t.push({type:e,value:i,current:n.current})}}function u(e,t){var n=t;while(e[n].type!=="meta.tag"&&n>0)n--;return n}function a(e){var t,n,r=!1,s,o,a,f=_.findIndex(e,function(e){return e.current});e[f].type==="text"&&e[f].value.trim()!==""&&(r=!0);var l=e[f].value;if(l==="{"&&f>1||_.trimLeft(l)===""&&e[f-1].value==="{"&&f>2)f=u(e,f),l=e[f].value;var c=l.length-_.trimLeft(l).length;t=new i,t.setField(l.trim()),n=new i,n.setValue({},"object"),n.appendChild(t);for(var h=f+1;h<e.length;h++)if(e[h].type==="meta.tag"){var p=e[h].value,d=p.length-_.trimLeft(p).length;if(d===c){var v=new i;v.setField(p.trim()),n.appendChild(v)}else if(d<c)break}for(var m=f-1;m>=0;m--)if(e[m].type==="meta.tag"){var g=e[m].value,y=g.length-_.trimLeft(g).length;if(!s&&y<c&&g.trim()!==""){var b=new i;b.setValue({},"object"),b.appendChild(n),n.setField(g.trim()),n=b,c=y,g.trim()==="Properties"&&(o=b,a=y);if(y===0)break}else if(y===c){var w=new i;w.setField(g.trim()),s&&(w.setValue(s),s=null),g.trim()==="Properties"&&(o=w,a=y),n.appendChild(w)}}else e[m].type==="string"&&(s=e[m].value.trim().replace(/['|"](.*)['|"]/,"$1"));while(t&&t.getField().trim()==="")t=t.parent;if(o&&!t.getAwsType()&&t.getResourcePath().length>=4)for(m=h;m<e.length;m++)if(e[m].type==="meta.tag"){var E=e[m].value,S=E.length-_.trimLeft(E).length;if(S===a&&E.trim()==="Type"){if(e[m+1]&&e[m+1].value.trim()===":"&&e[m+2]&&e[m+2].type==="string"){var x=new i;x.setField(E.trim()),x.setValue(e[m+2].value.trim().replace(/['|"](.*)['|"]/,"$1")),o.appendChild(x);break}}else if(S<a)break}return[n,t,r]}function f(e){var t=[],r,s,o,u=!1,a=!1,f=!1,l;for(var c=0;c<e.length;c++){var h=e[c];switch(h.type){case"paren.lparen":var p=new i;o&&p.setField(o);if(h.value==="[")p.setValue([],"array");else if(h.value==="{")p.setValue({},"object");else if(h.value==="(")continue;if(h.current||a)s=p;a=!1,r&&(r.childs&&(u||r.type==="array")&&r.appendChild(p),t.push(r)),r=p,o=undefined,f=!1,u=!1;break;case"paren.rparen":u?(r&&r.childs&&(l=new i,l.setField(o),l.setValue(undefined,"auto"),r.appendChild(l),a?s=l:h.current&&(s=r),a=!1),o=undefined,u=!1):(a&&(s=r,a=!1),t.length&&(r=t.pop(),h.current&&(s=r)));break;case"variable":if(u){if(r&&r.childs){l=new i,l.setField(o),l.setValue(undefined,"auto"),r.appendChild(l);if(h.current||a)s=l;a=!1}u=undefined}else h.current&&(s=r),o=h.value.replace(/"/g,"").trim();break;default:if(r===undefined)throw n.localize("invalid_json");h.current&&(a=!0);var d=h.value.trim();d===":"?(h.current&&(f=!0),u=!0):u?(h.current&&(f=!0),r&&r.childs&&(l=new i,l.setField(o),l.setValue(d,"string"),r.appendChild(l),h.current&&(s=l),a=!1),u=!1,o=undefined):a&&(s=r,a=!1)}}if(o!==undefined||u)l=new i,l.setField(o),l.setValue(undefined,"auto"),r.appendChild(l);while(t.length)r=t.pop();return[r,s,f]}var l=_.debounce(function(){var t=this.editor.getSession(),n=t.getAnnotations(),i=this.editor.getValue(),s=r.detectLanguage(i);if(n.length||s!==r.getLanguage())try{s!==r.getLanguage()&&this.updateTemplateLanguage(s,i)}catch(o){$.Topic(e.Topics.Composer.Editor.GoToError).publish()}else{this.isWriting=!0;try{this.updateModelWithTemplateChanges()}catch(o){console.log(o)}this.isWriting=!1}},250),c=_.debounce(function(){var e=this.model.get("template"),t=this.editor.getCursorPosition();this.editor.getSession().off("change",this.onChange),this.editor.set(e),this.editor.getSession().on("change",this.onChange),this.editor.resize(!0),this.editor.scrollToLine(t.row+1,!0,!0,function(){}),this.editor.gotoLine(t.row+1,t.column,!0),this.gotoSelectedResource()},250),h=_.debounce(function(){var e=this.editor.getSession(),t=e.getAnnotations();if(t.length){var n=this.editor.getFirstVisibleRow(),r=this.editor.getLastVisibleRow();(t[0].row<n||t[0].row>r)&&this.editor.gotoLine(t[0].row)}},500),p=Backbone.View.extend({id:"jsoneditor",isWriting:!1,initialize:function(){_.bindAll(this,"render","clearEditor","clearAnnotations","convertTemplateLanguage","setLanguage","resize","focus","focused","blurred","getEditorContents","findInContents","gotoFirstLine","gotoSelectedResource","loadFile","validateData","setEditor","onChange","enableEditor","goToError","selectProperties","updateTemplateLanguage","updateModelWithTemplateChanges"),$.Topic(e.Topics.Composer.ClearCurrent).subscribe(this.clearEditor),$.Topic(e.Topics.Composer.Editor.GoToError).subscribe(this.goToError),$.Topic(e.Topics.Composer.Editor.SetLanguage).subscribe(this.setLanguage),$.Topic(e.Topics.Composer.Editor.ConvertTemplate).subscribe(this.convertTemplateLanguage),$.Topic(e.Topics.Composer.LoadFileAndVis).subscribe(this.loadFile),$.Topic(e.Topics.Composer.Splitter.Resize).subscribe(this.resize),$.Topic(e.Topics.Composer.Vis.NodeSelected).subscribe(this.findInContents),$.Topic(e.Topics.Composer.Vis.TemplateSelected).subscribe(this.gotoFirstLine),$.Topic(e.Topics.Composer.Vis.EditProperties).subscribe(this.selectProperties),$.Topic(e.Topics.Composer.Vis.UpdateEditor).subscribe(this.setEditor),$.Topic(e.Topics.Composer.Editor.ClearAnnotations).subscribe(this.clearAnnotations),$.Topic(e.Topics.Composer.Vis.TemplateChanged).subscribe(_.bind(function(){this.isWriting||this.setEditor()},this));var t=window.ace.require("ace/ext/language_tools"),n={getCompletions:function(t,n,i,o,u){var l=i.row,c=i.column,h=n.getTokenAt(l,c);if(h)if(h.value.trim()===""&&r.getLanguage()!==e.EditorMode.YAML)for(l=i.row;l>=0;l--){for(c=l===i.row?h.index:n.bgTokenizer.lines[l].length-1;c>=0;c--){h=n.bgTokenizer.lines[l][c];if(h.value.trim()!==""){h.current=!0;break}}if(h.current)break}else h.current=!0,l=i.row,c=h.index;var p=s(n.bgTokenizer.lines,l,c),d;r.getLanguage()===e.EditorMode.YAML?d=a(p):d=f(p);var v=d[0],m=d[1]||v,g=d[2],y=_.map(m.getAutoComplete(v,g),function(t){var n=t;if(r.getLanguage()===e.EditorMode.JSON)if(h)switch(h.value){case'""':n=t;break;case'"':n=t+'"';break;default:n='"'+t+'"'}else n='"'+t+'"';return{caption:t,value:n}});u(null,y)}};t.setCompleters([n])},render:function(){return this.editor===undefined&&(window.ace.config.set("workerPath","/cloudformation/designer/js/ace/"),this.editor=window.ace.edit(this.el),this.editor.set=function(e,n){if(t.canvasChanging)return;this.setValue(r.stringify(e,n),this.getCursorPosition())},this.editor.get=function(e){return r.parse(this.getValue(),e)},this.editor.set(this.model.get("template")),this.editor.setOptions({enableBasicAutocompletion:!0}),this.editor.getSession().setMode("ace/mode/json"),this.editor.setShowPrintMargin(!1),this.editor.on("focus",this.focused),this.editor.on("blur",this.blurred),this.enableEditor(),this.editor.$blockScrolling=Infinity),this},enableEditor:function(){this.editor.getSession().on("change",this.onChange),this.editor.getSession().on("focus",this.focused),this.editor.getSession().on("blur",this.blurred),this.editor.setBehavioursEnabled(!0)},convertTemplateLanguage:function(t,r){this.editor.getSession().off("change",this.onChange);var i=t===e.EditorMode.JSON?e.Metrics.ConvertTemplateToJson:e.Metrics.ConvertTemplateToYaml,s=t===e.EditorMode.JSON?e.Metrics.ConvertTemplateToJsonError:e.Metrics.ConvertTemplateToYamlError,o;try{o=this.editor.get(r)}catch(u){$.Topic(e.Topics.Composer.ClearEvents).publish(),$.Topic(e.Topics.Composer.Events.Error).publish(n.localize("convert_template_error")+": "+u.message),window.AWSC.Clog.log(i,0,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(s,0,document.body.getAttribute("data-aws-account-id"))}if(o)try{this.setLanguage(t),this.editor.set(o,t),this.model.update(this.editor.get(t)),$.Topic(e.Topics.Composer.ClearEvents).publish();var a=n.localize("convert_template_success")||"Successfully converted the template to %LANGUAGE%";$.Topic(e.Topics.Composer.Events.Success).publish(a.replace("%LANGUAGE%",t.toUpperCase())),window.AWSC.Clog.log(i,1,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(s,0,document.body.getAttribute("data-aws-account-id"))}catch(u){$.Topic(e.Topics.Composer.ClearEvents).publish(),$.Topic(e.Topics.Composer.Events.Error).publish(n.localize("convert_template_error")+": "+u.message),window.AWSC.Clog.log(i,0,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(s,1,document.body.getAttribute("data-aws-account-id")),u.useragent=navigator.userAgent,u.hasOwnProperty("mark")&&delete u.mark,window.clientReporting.error(s,u)}this.editor.getSession().on("change",this.onChange)},updateTemplateLanguage:function(t,i){var s=r.parse(i,t);$.Topic(e.Topics.Composer.Editor.SetLanguage).publish(t),this.model.isChangingProps(!0),this.model.update(s),$.Topic(e.Topics.Composer.ClearEvents).publish();var o=n.localize("convert_template_success")||"Successfully converted the template to %LANGUAGE%";$.Topic(e.Topics.Composer.Events.Success).publish(o.replace("%LANGUAGE%",t.toUpperCase())),this.model.isChangingProps(!1)},updateModelWithTemplateChanges:function(){var e=this.editor.get(),t=this.model.get("template");!_.isEqual(e,t)&&!this.model.canvasChanging&&(this.model.isChangingProps(!0),this.model.update(e),this.model.isChangingProps(!1))},setLanguage:function(e){this.editor.getSession().setMode("ace/mode/"+e)},resize:function(){this.editor&&typeof this.editor.resize=="function"&&this.editor.resize()},focus:function(){this.editor.focus()},focused:function(){this.editor.getSession().on("change",this.onChange)},blurred:function(){this.editor.getSession().off("change",this.onChange)},onChange:l,setEditor:c,goToError:h,gotoSelectedResource:function(){var e=$(".element.highlighted"),t,n,r;e.length>0&&(t=e.first().data("view"),t&&(n=t.model,n&&(r=n.getLogicalName(),this.findInContents(r))))},gotoFirstLine:function(){this.editor&&this.editor&&this.editor.gotoLine(0,0)},clearEditor:function(){this.editor.getSession().off("change",this.onChange),$(".jsoneditor .search input").val(""),$("input.ace_search_field").val(""),this.isWriting=!0;var t={AWSTemplateFormatVersion:"2010-09-09"};this.model.set("template",t),this.editor.set(t),$.Topic(e.Topics.Composer.Editor.Clear).publish(),this.isWriting=!1,this.editor.getSession().on("change",this.onChange)},clearAnnotations:function(){return this.editor.getSession().clearAnnotations()},getEditorContents:function(){return this.editor?this.editor.getValue():""},findInContents:function(t){if(this.editor){this.editor.gotoLine(0,0);var n='"'+t+'" *:';r.getLanguage()===e.EditorMode.YAML&&(n=t+" *:"),this.editor.find(n,{wrap:!0,range:null,caseSensitive:!1,wholeWord:!1,regExp:!0,preventScroll:!1})}},selectProperties:function(t){var n=$(".inverted li.active").attr("data-id");n==="details"&&$('.topNav li[data-id="properties"]').find("a").addClass("active").trigger("click");var i=r.getLanguage()===e.EditorMode.YAML?"Properties":'"Properties"';this.findInContents(t),this.editor.find(i,{wrap:!0,range:null,caseSensitive:!1,wholeWord:!1,regExp:!0,preventScroll:!1})},loadFile:function(t,n,r){this.editor.getSession().off("change",this.onChange);var i;try{i=this.loadFileAsJson(r)}catch(s){i=this.loadFileAsYaml(r)}i&&this.model.update(i),this.editor.getSession().setValue(r),this.enableEditor(),$('.inverted li a[aria-controls="json"]').trigger("click"),$.Topic(e.Topics.Composer.Editor.FileLoaded).publish(n)},loadFileAsJson:function(t){var n=r.parse(t,e.EditorMode.JSON);return $.Topic(e.Topics.Composer.Editor.SetLanguage).publish(e.EditorMode.JSON),window.AWSC.Clog.log(e.Metrics.JsonTemplateLoaded,1,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(e.Metrics.YamlTemplateLoaded,0,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(e.Metrics.TemplateLoadError,0,document.body.getAttribute("data-aws-account-id")),n},loadFileAsYaml:function(t){try{var n=r.parse(t,e.EditorMode.YAML);return $.Topic(e.Topics.Composer.Editor.SetLanguage).publish(e.EditorMode.YAML),window.AWSC.Clog.log(e.Metrics.JsonTemplateLoaded,0,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(e.Metrics.YamlTemplateLoaded,1,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(e.Metrics.TemplateLoadError,0,document.body.getAttribute("data-aws-account-id")),n}catch(i){this.templateRenderErrorHandler(i),window.AWSC.Clog.log(e.Metrics.JsonTemplateLoaded,0,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(e.Metrics.YamlTemplateLoaded,0,document.body.getAttribute("data-aws-account-id")),window.AWSC.Clog.log(e.Metrics.TemplateLoadError,1,document.body.getAttribute("data-aws-account-id")),i.useragent=navigator.userAgent,i.hasOwnProperty("mark")&&delete i.mark,window.clientReporting.error(e.Metrics.TemplateLoadError,i)}},validateName:function(){var e=!_.all(_.keys(this.editor.get().Resources),function(e){if(e&&e.length>255||e.length<1)return!1;var t=e.match(/^([a-zA-Z0-9]+)$/);return t===null?!1:!0});return e},validateData:function(t){t===undefined&&(t=this.editor.getSession().getValue());try{var n=r.parse(t);return window.AWSC.Clog.log(e.Metrics.ValidateTemplate,0,document.body.getAttribute("data-aws-account-id")),n}catch(i){this.templateRenderErrorHandler(i),window.AWSC.Clog.log(e.Metrics.ValidateTemplate,1,document.body.getAttribute("data-aws-account-id")),i.useragent=navigator.userAgent,i.hasOwnProperty("mark")&&delete i.mark,window.clientReporting.error(e.Metrics.ValidateTemplate,i)}},templateRenderErrorHandler:function(t){$.Topic(e.Topics.Composer.Events.Error).publish(n.localize("template_rendering_error")+": "+t),$.Topic(e.Topics.Composer.Editor.GoToError).publish()},getErrors:function(){var e=this.editor.getSession(),t=e.getAnnotations();return _.filter(t,function(e){return e.type==="error"})}});return new p({model:t})}),define("views/ResourceEditor",["Constants","utils/Parser"],function(e,t){var n=function(){var t;try{t=this.editor.get()}catch(n){return}typeof t=="object"&&(t=_.transform(t,function(e,t,n){n&&(e[n]=t)}));var r=null;_.isEmpty(t.Resources)||(r=_.keys(t.Resources)[0],r!==this.logicalName&&(this.model.isChangingProps(!0),$.Topic(e.Topics.Composer.File.UpdateFileName).publish(r),this.model.updateLogicalName(this.logicalName,r),this.logicalName=r,this.model.isChangingProps(!1)));var i,s;this.logicalName!=null?(i=this.model.getResourceProperty(this.logicalName,this.options.propertyName),s=t.Resources[this.logicalName][this.options.propertyName],_.isEqual(s,i)||this.model.updateResourceProperty(this.logicalName,this.options.propertyName,s)):(i=this.model.getTemplateProperty(this.options.propertyName),s=t[this.options.propertyName],_.isEqual(s,i)||this.model.updateTemplateProperty(this.options.propertyName,s))},r=_.debounce(n,250);return Backbone.View.extend({id:"resource-editor",initialize:function(t){this.options=_.extend(t||{},{emptyKey:{}}),_.bindAll(this,"render","renderResource","setResourceContext","onChange","setLanguage","resize","updateLogicalName"),$.Topic(e.Topics.Composer.Editor.FileLoaded).subscribe(this.renderResource),$.Topic(e.Topics.Composer.Splitter.Resize).subscribe(this.resize),$.Topic(e.Topics.Composer.Editor.SetLanguage).subscribe(this.setLanguage),$.Topic(e.Topics.Composer.Editor.ConvertTemplate).subscribe(this.renderResource),$.Topic(e.Topics.Composer.Vis.UpdateResourceLogicalName).subscribe(this.updateLogicalName)},render:function(){return this.editor===undefined&&(window.ace.config.set("workerPath","/cloudformation/designer/js/ace/"),this.editor=window.ace.edit(this.el),this.editor.set=function(e,n){this.setValue(t.stringify(e,n),this.getCursorPosition())},this.editor.get=function(e){return t.parse(this.getValue(),e)},this.editor.getSession().setMode("ace/mode/json"),this.editor.setShowPrintMargin(!1),this.editor.setBehavioursEnabled(!0),this.editor.$blockScrolling=Infinity,this.editor.getSession().on("change",this.onChange),this.editor.setOptions({enableBasicAutocompletion:!0})),this},setLanguage:function(e){this.editor.getSession().setMode("ace/mode/"+e)},onChange:r,resize:function(){this.editor&&this.editor.resize()},setResourceContext:function(e,t,n){return this.options.propertyName=e,this.options.emptyKey=t,this.logicalName=n,this},updateLogicalName:function(e,t){this.logicalName=t,this.renderResource()},renderResource:function(){var e={},t,n=this.logicalName;if(this.editor!==undefined){if(n!==null){e.Resources={},e.Resources[n]={},t=this.options.propertyName||"Properties";var r=this.model.getResource(n);r?(e.Resources[n].Type=r.Type,e.Resources[n][t]=r[t]||this.options.emptyKey,this.editor.set(e)):this.editor.set(this.options.emptyKey)}else{t=this.options.propertyName||"Parameters";var i=this.model.get("template");i?(e[t]=i[t]||this.options.emptyKey,this.editor.set(e)):this.editor.set(this.options.emptyKey)}typeof this.editor.expandAll=="function"&&this.editor.expandAll()}}})}),define("views/EventsPanel",["Constants"],function(e){return Backbone.View.extend({id:"eventsPanel",template:$("#eventsPanelTemplate").html(),initialize:function(){_.bindAll(this,"render");var t=function(e,t,n){var r=new Date;$("#eventsContent").prepend('<p class="'+t+'"><i class="fa fa-'+n+'"></i> '+r.toLocaleString()+" - "+_.escape(e)+"</p>")};$.Topic(e.Topics.Composer.Events.Error).subscribe(function(e){t(e,"error","bolt")}),$.Topic(e.Topics.Composer.Events.Warning).subscribe(function(e){t(e,"warning","warning")}),$.Topic(e.Topics.Composer.Events.Success).subscribe(function(e){t(e,"positive","check")}),$.Topic(e.Topics.Composer.ClearEvents).subscribe(this.clearMessages),$.Topic(e.Topics.Composer.ClearCurrent).subscribe(this.clearMessages),$.Topic(e.Topics.Composer.File.Loading).subscribe(this.clearMessages),$.Topic(e.Topics.Composer.Vis.Refresh).subscribe(this.clearMessages)},render:function(){return this.$el.append(this.template),this},clearMessages:function(){$("#eventsContent").html("")}})}),define("views/MainTabs",["Constants","views/Designer","views/Editor","views/ResourceEditor","utils/Parser","views/EventsPanel","models/CloudFormation","services/LocalizationService","utils/ImgUtils"],function(e,t,n,r,i,s,o,u,a){var f=840,l=175;return Backbone.View.extend({id:"mainTabsWrap",template:$("#mainTabsTemplate").html(),events:{"click .topNav li a":"tabClick","click .inverted li a":"bottomTabClick","click #nameEditButton":"nameEditInPlace","click #detailsHeader .editor-title span":"nameEditInPlace","click #nameSetButton":"nameSaveInPlace","keypress #detailsHeader .editor-title span input":"keyPressHandler",'change input[type="radio"][name="languageSelect"]':"languageToggle","click #editorLanguageSelect .fa.fa-question-circle":"openLanguageHelp"},initialize:function(){_.bindAll(this,"render","nameEditInPlace","nameSaveInPlace","setFileName","setResourceName","getNameHeaderData","resize","panelResize","tabClick","bottomTabClick","resourceSelected","templateSelected","setHeight","detailsSelected","detailsNotSelected","keyPressHandler","languageToggle","openLanguageHelp"),this.editor=n,this.propEditor=new r({model:o}),this.eventsPanel=new s,$.Topic(e.Topics.Composer.Vis.NodeSelected).subscribe(this.resourceSelected),$.Topic(e.Topics.Composer.Vis.NodeRemoved).subscribe(this.templateSelected),$.Topic(e.Topics.Composer.Vis.TemplateSelected).subscribe(this.templateSelected),$.Topic(e.Topics.Composer.ClearCurrent).subscribe(this.templateSelected),$.Topic(e.Topics.Composer.Designer.OnUndoRedo).subscribe(this.templateSelected),$.Topic(e.Topics.Composer.File.UpdateFileName).subscribe(this.setFileName),$(window).on("resize",this.resize)},render:function(){this.$el.html(this.template).css("minWidth",f+l+"px"),this.$el.append(this.eventsPanel.render().el),this.$("#details").append(this.propEditor.render().el),this.$("#json").append(this.editor.render().el),this.templateSelected();var e=this;return e.$("#mainTabs").resizable({handles:"e",minWidth:f,resize:function(){e.panelResize()}}),e},nameEditInPlace:function(){var e=this.getNameHeaderData();if(e.existingInput)return;var t=$('<input type="text">').attr("value",e.currentName).attr("style","width: "+(e.nameWidth+15)+"px;");e.$editButton.hide(),e.$saveButton.show(),e.$nameElement.removeClass("padding").html(t).attr("title",""),e.$nameElement.width(e.nameWidth+23),t.focus()},validateName:function(e){if(e&&e.length>255)return!1;var t=e.match(/^([a-zA-Z0-9]+)$/);return t===null?!1:!0},nameSaveInPlace:function(){var t=this.getNameHeaderData();if(this.selectionType==="template")t.currentName===""&&(t.$nameElement.text(t.oldName),t=this.getNameHeaderData()),$.Topic(e.Topics.Composer.File.UpdateFileName).publish(t.currentName);else if(this.selectionType==="resource"){if(t.currentName==="")return;if(t.currentName!==t.oldName){if(!this.validateName(t.currentName))return $.Topic(e.Topics.Composer.Message).publish(u.localize("invalid_resource_name_title"),u.localize("invalid_resource_name")),!1;if(o.getResource(t.currentName))return $.Topic(e.Topics.Composer.Message).publish(u.localize("duplicate_resource_title"),u.localize("duplicate_resource")),!1;o.isChangingProps(!0),$.Topic(e.Topics.Composer.Vis.UpdateLogicalName).publish(t.oldName,t.currentName),$.Topic(e.Topics.Composer.Vis.UpdateResourceLogicalName).publish(t.oldName,t.currentName),o.isChangingProps(!1)}}t.$nameElement.addClass("padding").html(_.escape(t.currentName)).width(t.nameWidth).attr({title:t.currentName,"data-old-name":t.currentName}),t.$editButton.show(),t.$saveButton.hide()},keyPressHandler:function(t){var n=this.getNameHeaderData(),r=this.$("#detailsHeader"),i=$(".editor-title span input",r);i.width(n.nameWidth+15),n.$nameElement.width(n.nameWidth+23),t.keyCode===e.ENTER&&this.nameSaveInPlace()},languageToggle:function(){var t=i.getLanguage(),n=$("input[type=radio][name=languageSelect]:checked").val();t!==n&&($.Topic(e.Topics.Composer.Editor.SetLanguage).publish(n),$.Topic(e.Topics.Composer.Editor.ConvertTemplate).publish(n,t))},openLanguageHelp:function(){window.open($("#docs-endpoint").attr("href")+"/designer/view-template")},getNameHeaderData:function(){var e=this.$("#detailsHeader"),t=$(".editor-title span",e),n=$(".editor-title span input",e),r=n.length>0?$.trim(n.val()):t.text(),i=$("<div id='textWidthTempEl'/>");$("#textWidthTempEl").remove(),i.css("font-size",parseInt(e.css("font-size"),10)).text(r),i.css("font",e.css("font")),$("body").append(i);var s=i.width()+1;return i.remove(),{$nameElement:t,$editButton:this.$("#nameEditButton"),$saveButton:this.$("#nameSetButton"),existingInput:n.length>0,currentName:r,oldName:t.attr("data-old-name"),nameWidth:s>e.width()?e.width()-40:s+5}},setFileName:function(e){var t=e||this.fileNameCache;this.$("#detailsHeader img").remove(),this.$("#detailsHeader span").html(_.escape(t)).attr({title:t,"data-old-name":t}).width(this.getNameHeaderData().nameWidth),this.$("#nameSetButton").hide(),this.$("#nameEditButton").show(),this.fileNameCache=t},setResourceName:function(e){this.$("#detailsHeader img").remove();var t=o.getResourceProperty(e,"Type");if(t){var n;t=t.toLowerCase().split("::"),_.has(joint.shapes.Composer,t.join("-"))?n=a.getResourceImage(t):n=a.getResourceImage(["aws","cloudformation","customresource"]),this.$("#detailsHeader").prepend($("<img />",{src:n,alt:"Resource Icon"}))}this.$("#detailsHeader span").text(_.escape(e)).attr({title:_.escape(e),"data-old-name":e}).width(this.getNameHeaderData().nameWidth),this.$("#nameSetButton").hide(),this.$("#nameEditButton").show()},resize:function(){this.panelResize(),this.$("#mainTabs").resizable("option","maxWidth",this.$el.width()-l)},panelResize:function(){var e=this.$("#mainTabs"),t=this.$("#eventsPanel"),n=window.innerWidth,r=this.$el.width();r>n&&(r=n);var i=r-e.outerWidth();if(i<l){var s=e.outerWidth(!0)-l/2;s<f&&(s=f),e.width(s)}var o=i-(t.outerWidth(!0)-t.width())-1;o<0&&(o=0),t.width(o)},setHeight:function(){var e=this.$(".topNav");if(e.length>0){var t=this.$(".tab-content"),n=this.$(".inverted");t.height(this.$el.height()-e.outerHeight()-(t.outerHeight(!0)-t.height())-n.outerHeight(!0)-20)}var r=t.height();this.eventsPanel.$el.height(r-4),this.$(".ui-resizable-e").height(r+17)},tabClick:function(e){var n=$(e.currentTarget).attr("aria-controls");this.$el.find(".topNav li").removeClass("active");var r=$(e.currentTarget).parent("li").addClass("active"),i=t.getSelectedNode();switch(n){case"properties":this.propEditor.setResourceContext("Properties",{},i),this.lastSelectedDetailTab=r;break;case"metadata":this.propEditor.setResourceContext("Metadata",{},i),i?this.lastSelectedDetailTab=r:this.lastSelectedTemplateTab=r;break;case"creationpolicy":this.propEditor.setResourceContext("CreationPolicy",{},i),this.lastSelectedDetailTab=r;break;case"deletionpolicy":this.propEditor.setResourceContext("DeletionPolicy","",i),this.lastSelectedDetailTab=r;break;case"updatepolicy":this.propEditor.setResourceContext("UpdatePolicy",{},i),this.lastSelectedDetailTab=r;break;case"dependencies":this.propEditor.setResourceContext("DependsOn",[],i),this.lastSelectedDetailTab=r;break;case"condition":this.propEditor.setResourceContext("Condition","",i),this.lastSelectedDetailTab=r;break;case"parameters":this.propEditor.setResourceContext("Parameters",{},i),this.lastSelectedTemplateTab=r;break;case"mappings":this.propEditor.setResourceContext("Mappings",{},i),this.lastSelectedTemplateTab=r;break;case"outputs":this.propEditor.setResourceContext("Outputs",{},i),this.lastSelectedTemplateTab=r;break;case"conditions":this.propEditor.setResourceContext("Conditions",{},i),this.lastSelectedTemplateTab=r;break;default:this.$(".tab-pane").removeClass("active").hide(),this.lastSelectedDetailTab=this.lastSelectedTemplateTab=r;return}this.propEditor.renderResource()},bottomTabClick:function(e){var r=$(e.currentTarget).attr("aria-controls"),i=t.getSelectedNode();switch(r){case"json":this.detailsNotSelected(),i?n.findInContents(i):n.gotoFirstLine();break;case"credentials":this.detailsNotSelected();break;default:i?this.resourceSelected(i,!0):this.templateSelected(!0)}},detailsNotSelected:function(){this.selectionType="template",this.$(".topNav").removeClass("active").css("visibility","hidden"),this.$(".tab-content").removeClass("resourceContext").css("borderTopColor","#ddd"),this.setFileName()},detailsSelected:function(e){var t=this.$(".inverted li[data-id='details']"),n=this.$(".tab-content");n=n.add(t),this.$(".topNav").css("visibility","visible"),this.$(".tab-content").css("borderTopColor","transparent"),e?n.addClass("resourceContext"):n.removeClass("resourceContext")},resourceSelected:function(e,t){this.selectionType="resource";var n=this.$(".inverted li.active").attr("data-id");if(n==="details"||t===!0){this.detailsSelected(!0);var r=["properties","metadata","condition","dependencies","deletionpolicy"],i=o.getResource(e).Type,s=resourceSpecification.ResourceTypes[i].AllowCreationPolicy,u=resourceSpecification.ResourceTypes[i].AllowUpdatePolicy;s==="true"&&r.push("creationpolicy"),u==="true"&&r.push("updatepolicy");var a=this.$(_.map(r,function(e){return".topNav li[data-id='"+e+"']"}).join(","));this.$el.find(".topNav li").removeClass("active").addClass("resourceContext").hide(),a.show(),this.lastSelectedDetailTab=this.lastSelectedDetailTab||a.first(),this.lastSelectedDetailTab.find("a").addClass("active").trigger("click"),this.setResourceName(e)}},templateSelected:function(e){this.selectionType="template";var t=this.$(".inverted li.active").attr("data-id");if(t==="details"||e===!0){this.detailsSelected();var n=this.$(".topNav li[data-id='parameters'], .topNav li[data-id='mappings'], .topNav li[data-id='conditions'], .topNav li[data-id='metadata'], .topNav li[data-id='outputs']");this.$el.find(".topNav li").removeClass("active resourceContext").hide(),n.show(),this.lastSelectedTemplateTab=this.lastSelectedTemplateTab||n.first(),this.lastSelectedTemplateTab.find("a").addClass("active").trigger("click")}this.setFileName()}})}),define("views/Palette",["views/Designer","utils/ImgUtils"],function(e,t){var n=function(e){return t.getResourceImage(e.split("::"))},r=function(){return document.addEventListener?function(e,t,n){if(e&&e.nodeName||e===window)e.addEventListener(t,n,!1);else if(e&&e.length)for(var i=0;i<e.length;i++)r(e[i],t,n)}:function(e,t,n){if(e&&e.nodeName||e===window)e.attachEvent("on"+t,function(){return n.call(e,window.event)});else if(e&&e.length)for(var i=0;i<e.length;i++)r(e[i],t,n)}}();return Backbone.View.extend({id:"palette",initialize:function(){_.bindAll(this,"render","show")},render:function(){var i=_.keys(resourceSpecification.ResourceTypes),s=_.keys(relationshipTypesMap).filter(function(e){return relationshipTypesMap[e].EntityType!=="Link"}),o=_.intersection(i,s).sort(),u=_.groupBy(o,function(e){return e.split("::")[1]});_.forOwn(u,function(e,t){this.$el.append($("<h4 id="+t+">").text(t));var r=$("#img-endpoint").attr("href"),i=$("<div>"),s=$("<ul>").css({display:"block",margin:0,padding:0,"list-style":"none"});_.each(e,function(e){var t=$("<li>"),i=$('<a class="resource-drag" draggable="true" href="#">').text(e.split("::")[2]).attr("data-type",e),o=$('<img src="'+n(e.toLowerCase())+'" />');r!=="img"&&o.attr("crossorigin","anonymous"),i.prepend(o),t.append(i),s.append(t)}),i.append(s),this.$el.append(i)},this),this.$("#parametersList li a").each(function(){$(this).attr("data-drag-icon",t.getImagePath("img/ICON_COMP_NET_EC2_INSTANCE_ACTIVE.svg"))}),this.$("li a").each(function(){var e=this;r(e,"click",function(){return!1}),r(e,"selectstart",function(e){e.preventDefault()}),r(e,"dragstart",function(e){e.stopPropagation();if(typeof e.dataTransfer.setDragImage=="function"){var t=document.createElement("img");t.src=$(e.currentTarget).attr("data-drag-icon")||$(e.currentTarget).find("img").attr("src"),e.dataTransfer.setDragImage(t,50,50)}e.dataTransfer.setData("Text",JSON.stringify({type:$(e.currentTarget).data("type"),offset:{x:27,y:27}}))})});var a=this;this.$el.accordion({header:"h4",heightStyle:"content",collapsible:!0,active:!1,activate:function(e,t){var n=a.$("#palette").prevObject.scrollTop();if(!t.newHeader.length)return;var r=a.$("#palette").prevObject.offset().top,i=$(t.newHeader).offset().top;a.$("#palette").prevObject.animate({scrollTop:n+(i-r)},"fast")}});var f=e.paper.$el[0];return r(f,"dragover",function(e){e.preventDefault()}),r(f,"dragenter",function(e){e.preventDefault()}),r(f,"drop",function(t){var n=JSON.parse(t.dataTransfer.getData("Text"));if(n.type){t.preventDefault();var r=n.offset;t.dropX=t.clientX-r.x,t.dropY=t.clientY-r.y,t.resourceType=n.type,e.paper.drop(t)}}),this},show:function(){this.$el.show()}})}),define("views/Sidebar",["Constants","views/Palette","services/LocalizationService"],function(e,t,n){var r=310;return Backbone.View.extend({id:"sidebar",events:{"click #sidebarTrigger":"triggerClick"},template:$("#sidebarTemplate").html(),initialize:function(){_.bindAll(this,"render","triggerClick","resize","show"),$.Topic(e.Topics.Composer.LoadFileAndVis).subscribe(this.show),this.paletteView=new t},render:function(){return this.$el.append(this.template),this.$("#sidebarContent").append(this.paletteView.render().el),this.paletteView.show(),this.$("#sidebarTitle").text(n.localize("design_palette")),this.$el.width(r+"px"),$("#designer").css("left",r+1+"px"),this.sidebar=this.$el.resizable({handles:"e",minWidth:5,maxWidth:400,resize:this.resize}),this},show:function(){$("#designer").css("left",this.previousWidth+1+"px"),this.$el.width(this.previousWidth).show()},resize:function(){var t=this.$el,n=t.outerWidth(!0),r=this.$("#sidebarTrigger");$("#designer").css("left",n+1+"px"),n<=6?r.addClass("closed"):r.removeClass("closed"),$.Topic(e.Topics.Composer.Splitter.Resize).publish()},triggerClick:function(t){var n=this.$el,i=$(t.currentTarget),s=$("#designer");i.hasClass("closed")?(i.removeClass("closed"),n.width(r),s.css("left",r+1+"px")):(i.addClass("closed"),n.width(5),s.css("left","6px")),$.Topic(e.Topics.Composer.Splitter.Resize).publish()}})}),define("views/Splitter",["Constants","views/MainTabs","views/Designer","views/Sidebar"],function(e,t,n,r){var i=45,s=function(){var t=window.innerHeight,n=this.$("#topPanel"),r=this.$("#bottomPanel"),s=$("#menu"),o=$("#contentSection"),u=$("#main-content"),a=$("#h").height()+$("#f").height();o.height(t-a),u.height(o.height()-s.height());var f=n.parent("#splitter").height()-n.outerHeight(!0),l=f-(r.outerHeight(!0)-r.height());r.height(l),n.hasClass("ui-resizable")&&n.resizable("option","maxHeight",u.height()-i),this.tabs&&this.tabs.setHeight(),$.Topic(e.Topics.Composer.Splitter.Resize).publish(),l<=i*2.75?this.setPosition("vis"):$("#mainTabsWrap").show()},o=_.debounce(s,300),u=Backbone.View.extend({id:"splitter",template:$("#splitter").html(),initialize:function(){_.bindAll(this,"render"),$.widget("ui.resizable",$.ui.resizable,{setHeight:function(e){var t=new $.Event("mousedown",{pageX:0,pageY:0});this._mouseStart(t),this.axis="s";var n=new $.Event("mouseup",{pageX:this.originalSize.width,pageY:e-this.originalSize.height});this._mouseDrag(n),this._mouseStop(n)}}),_.bindAll(this,"render","resize","setPosition"),window.addEventListener("resize",o),$(window).on("resize",this.resize)},render:function(){var e=this;return e.$el.html(e.template),e.resize(),e.$resizeableTopPanel=e.$("#topPanel"),e.$bottomPanel=e.$("#bottomPanel"),e.designer=n,e.tabs=new t,e.sidebar=new r,e.$resizeableTopPanel.html(e.designer.render().el),e.$resizeableTopPanel.prepend(e.sidebar.render().el),e.$bottomPanel.append(e.tabs.render().el),e.resizable=e.$resizeableTopPanel.resizable({handles:"s",minHeight:0,maxHeight:e.$el.height()-i,resize:e.resize}),e.$bottomPanel.find("#screenControls span").bind("click",function(){var t=$(this).data("value");e.setPosition(t)}),_.defer(_.bind(function(){e.resize(),e.setPosition()},e)),e},resize:o,setPosition:function(e){if(this.tabs){var t=this.$("#topPanel"),n=this.$("#bottomPanel"),r=this.$el.height();this.tabs.$el.show();switch(e){case"editor":t.height(0),n.height("100%");break;case"vis":this.tabs.$el.hide(),t.height(r-i),n.height(i);break;default:t.height("50%"),n.height("50%")}this.tabs.setHeight(),this.resize()}}});return new u}),define("views/WarningModal",["Constants"],function(e){return Backbone.View.extend({id:"warningModal",className:"modal fade type-warning",template:$("#warningModalTemplate").html(),events:{"hidden.bs.modal":"teardown","click #newFileOkButton":"publichNewFile"},initialize:function(){_.bindAll(this,"show","teardown","render"),this.render()},render:function(){return this.$el.html(this.template),this.$el.modal({show:!1}),this},show:function(){this.$el.modal("show")},publichNewFile:function(){this.$el.modal("hide"),$.Topic(e.Topics.Composer.File.New).publish()},teardown:function(){this.$el.data("modal",null),this.remove()}})}),define("views/Menu",["Constants","views/WarningModal","views/Editor","services/LocalizationService"],function(e,t,n,r){var i=Backbone.View.extend({id:"menu",events:{"click #mainMenu li":"menuClick"},template:$("#menu").html(),initialize:function(){_.bindAll(this,"render","setEditorMenuState","setUndoRedoButtonState","menuClick","showMessage","hideMessage"),$.Topic(e.Topics.Composer.Menu.ResetState).subscribe(this.setEditorMenuState),$.Topic(e.Topics.Composer.DirtyFlag.Toggle).subscribe(this.setEditorMenuState),$.Topic(e.Topics.Composer.File.New).subscribe(this.setEditorMenuState),$.Topic(e.Topics.Composer.Menu.Help).subscribe(this.helpMenu),$.Topic(e.Topics.Composer.Busy).subscribe(this.showMessage),$.Topic(e.Topics.Composer.Ready).subscribe(this.hideMessage),$.Topic(e.Topics.Composer.Designer.UndoRedoReset).subscribe(this.setUndoRedoButtonState),$.Topic(e.Topics.Composer.Designer.OnUndoRedo).subscribe(this.setUndoRedoButtonState)},render:function(){return this.$el.html(this.template),this.setEditorMenuState(),this},menuClick:function(n){var i=$(n.currentTarget).data("value");switch(i){case"fileNew":var s=new t;s.show();break;case"fileOpen":$.Topic(e.Topics.Composer.File.Open).publish();break;case"fileSave":$.Topic(e.Topics.Composer.File.Save).publish();break;case"ExportImage":$.Topic(e.Topics.Composer.Busy).publish(r.localize("generating_image")),$.Topic(e.Topics.Composer.ExportImage).publish();break;case"sampleTemplates":$.Topic(e.Topics.Composer.File.SampleTemplates).publish();break;case"undo":$.Topic(e.Topics.Composer.Vis.Undo).publish();break;case"redo":$.Topic(e.Topics.Composer.Vis.Redo).publish();break;case"refreshVis":this.refreshVis();break;case"launch":$.Topic(e.Topics.Composer.CFT.Launch).publish();break;case"validate":$.Topic(e.Topics.Composer.CFT.Validate).publish();break;case"help":$.Topic(e.Topics.Composer.Menu.Help).publish()}},setEditorMenuState:function(){this.$(".undo").removeClass("conceal"),this.$(".redo").removeClass("conceal")},helpMenu:function(){window.open($("#docs-endpoint").attr("href")+"/designer")},refreshVis:function(){var t=n.getErrors();if(t.length===0){if(n.validateName()){$.Topic(e.Topics.Composer.Events.Error).publish(r.localize("invalid_resource_name"));return}$.Topic(e.Topics.Composer.Vis.Refresh).publish(),n.validateData()}else _.each(t,function(t){$.Topic(e.Topics.Composer.Events.Error).publish("Row: "+t.row+" Col: "+t.column+" - "+t.text)}),$.Topic(e.Topics.Composer.Events.Error).publish("Failed to refresh, template has errors:")},setUndoRedoButtonState:function(e,t){e?this.$el.find("li.undo").removeClass("disabled").prop("disabled",!1):this.$el.find("li.undo").addClass("disabled").prop("disabled",!0),t?this.$el.find("li.redo").removeClass("disabled").prop("disabled",!1):this.$el.find("li.redo").addClass("disabled").prop("disabled",!0)},showMessage:function(e){var t='<i class="fa fa-spinner fa-spin"></i> '+_.escape(e);this.$el.find(".menu-message").html(t).removeClass("conceal").show()},hideMessage:function(e){this.$el.find(".menu-message").text(_.escape(e)).delay(2e3).fadeOut(400)}});return new i}),define("utils/LocalFile",["Constants","services/LocalizationService"],function(e,t){var n=function(){function e(e,t){return function(){t.resolve(e.result)}}function t(e,t){return function(){t.reject(e.result)}}this.deferred=$.Deferred(),this.reader=new FileReader,this.reader.onload=e(this.reader,this.deferred),this.reader.onerror=t(this.reader,this.deferred)};n.prototype.readAsText=function(e){return this.reader.readAsText(e),this.deferred.promise()};var r=function(r){r&&r.preventDefault();var i=this.files[0];if(!i)return;if(i.size>e.ComposerMaxFileSize){$.Topic(e.Topics.Composer.Events.Error).publish(t.localize("max_file_size"));return}var s=new n;return s.readAsText(i).done(function(t){$.Topic(e.Topics.Composer.ClearCurrent).publish(),$.Topic(e.Topics.Composer.File.Loading).publish(),$.Topic(e.Topics.Composer.LoadFileAndVis).publish("file",i.name,t),$.Topic(e.Topics.Composer.File.UpdateFileName).publish(i.name),$.Topic(e.Topics.Composer.Editor.ClearAnnotations).publish()}).always(function(){$.Topic(e.Topics.Composer.Menu.ResetState).publish()})};return{init:function(){$("#file1").on("change",r)},openFile:function(){window.FileReader?$("#file1").prop("value","").trigger("click"):alert(t.localize("api_not_supported"))},exportFile:function(e,n){if(window.Blob){var r=new Blob([n],{type:"text/json"}),i=navigator.userAgent.match(/MSIE\s([\d.]+)/),s=navigator.userAgent.match(/Trident\/7.0/)&&navigator.userAgent.match(/rv:11/),o=i?i[1]:s?11:-1,u=navigator.userAgent.match("Safari")&&!navigator.userAgent.match("Chrome");if(i&&o<10){console.error("Cannot download on IE < 10");return}if(i||s)window.navigator.msSaveBlob(r,e);else{var a=$("<a>").prop("download",e).text("Download Template");window.webkitURL?a.prop("href",window.webkitURL.createObjectURL(r)):a.prop("href",window.URL.createObjectURL(r)).on("click",function(){a.remove()}).appendTo("body");if(u){window.open(a[0].href);return}a[0].click()}}else alert(t.localize("api_not_supported"))}}}),define("services/XsrfProtection",[],function(){function r(){return _.isUndefined(this.xsrfToken)&&(this.xsrfToken=JSON.parse(t).token),this.xsrfToken}function i(e){this.xsrfToken=e}function s(){return $.ajax({url:"/cloudformation/designer/service/util/xsrfToken",method:"GET"})}var e=/\\([{}])/g,t,n;return n=$("#preload").attr("data-xsrf-token"),n&&(t=n.replace(e,"$1")),{getXsrfToken:r,refreshToken:s,setXsrfToken:i}}),define("services/HttpService",["utils/RegionUtils","services/XsrfProtection","services/LocalizationService"],function(e,t,n){function s(e,n,r,i){var s={beforeSend:function(n){n.setRequestHeader("x-cfn-xsrf-token",t.getXsrfToken()),n.setRequestHeader("X-Composer-RequestId",e)},method:r,contentType:"application/json",processData:!1};return r==="GET"?_.forIn(i,function(e,t){n+="&"+t+"="+e}):s.data=i,s.url=n,$.ajax(s)}function o(e,t,n,r,i){setTimeout(function(){f(t,n,r,i).fail(function(t){e.reject(t)}).done(function(t){e.resolve(t)})},Math.random()*(Math.pow(2,i)-1)*1e3)}function u(e,s,u,a,f,l){l+=1;if(e.status===401){var c=window.confirm(n.localize("credential_warning_message"));if(c){var h=window.location.search,p="#"+(window.location.href.split("#")[1]||"");h?h+="&":h="?",p="state=hashArgs"+encodeURIComponent(p),window.hideRedirectWarning=!0,window.location.replace(window.location.pathname+h+p)}s.reject(i)}else if(e.responseJSON&&e.responseJSON.code==="InvalidXsrf"){var d=t;t.refreshToken().done(function(e){d.setXsrfToken(e),o(s,u,a,f,l)}),window.clientReporting.info("xhrError:"+e.status,e.responseJSON)}else l<r&&(!e.status||e.status>=500)?(o(s,u,a,f,l),window.clientReporting.info("xhrError:"+e.status,e.responseJSON)):(window.clientReporting.error("Error",e.responseJSON),s.reject(e.responseJSON))}function a(e,t){e.Error?t.reject(e.Error):t.resolve(e)}function f(t,n,r,i){var o=Math.random().toString(36).substring(2)+"-"+Math.random().toString(36).substring(2),f=e.getRegion(),l=n+"?region="+f,c=$.Deferred();return s(o,l,t,r).done(function(e){a(e,c)}).fail(function(e){u(e,c,t,n,r,i||0)}),c.promise()}var r=3,i={message:"Internal Failure",code:"InternalFailure",type:"Receiver"};return{getRequest:f}}),define("services/ComposerService",["utils/RegionUtils","services/HttpService"],function(e,t){function n(e){return t.getRequest("GET","/cloudformation/designer/service/template",{stackId:e})}function r(e){return t.getRequest("GET","/cloudformation/designer/service/s3",{templateUrl:e})}function i(e){return t.getRequest("GET","/cloudformation/designer/service/s3/templates",{token:e})}function s(e){var t=window.location.search.substr(1).split("&"),n;return _.each(t,function(t){var r=t.split("=");r[0].toLowerCase()===e.toLowerCase()&&(n=decodeURIComponent(r[1]))}),n}function o(t){var n=$("#cloudformation-endpoint").attr("href"),r=e.getRegion(),i=s("stackId"),o=s("action"),u=n+"?region="+r+"#/";o==="changeset"?u+="stack/changeset/new":o==="update"?u+="stack/update":u+="stacks/new",u+="?templateURL="+encodeURIComponent(t.templateUrl),t.templateEtag&&(u+="&templateEtag="+encodeURIComponent(t.templateEtag)),_.isEmpty(i)||(u+="&stackId="+encodeURIComponent(i)),u+="&redirectId=DesignTemplate",window.hideRedirectWarning=!0,window.location.replace(u)}function u(e){var n=JSON.stringify({templateURL:e});return t.getRequest("POST","/cloudformation/designer/service/template/validate",n)}function a(){return t.getRequest("GET","/cloudformation/designer/service/template/sample")}return{getTemplateForStack:n,getSampleTemplates:a,loadTemplateFromS3Url:r,redirectToCloudFormation:o,validateTemplate:u,loadS3Templates:i}}),define("services/UploadService",["services/HttpService"],function(e){function t(){return e.getRequest("POST","/cloudformation/designer/service/upload/uploadParameters/v4")}return{getUploadParameters:t}}),define("views/UploadS3View",[],function(){return Backbone.View.extend({id:"uploadS3Modal",template:$("#uploadS3Template").html(),events:{},initialize:function(){_.bindAll(this,"submit"),this.render()},render:function(){return this.$el.html(this.template),this},submit:function(e,t,n,r){var i=$("#s3-upload-target"),s=e.key.replace("${filename}",n),o=function(e){var t="s3.amazonaws.com";if(_.isUndefined(e))return t;var n=e.match("https://([-A-Za-z0-9]+)\\.(.+)");return _.isNull(n)||n.length<3?t:n[2]},u=function(){var t;try{t=i[0].contentWindow.location;if(!_.contains(t.pathname,"uploadSuccess")){window.clientReporting.fault("upload:wrongUploadLocation",{location:t}),r.reject();return}var n=t.search;n.charAt(0)==="?"&&(n=n.substring(1));var s,u,a;_.each(n.split("&"),function(e){_.startsWith(e,"bucket=")?s=decodeURIComponent(e.substring("bucket=".length)):_.startsWith(e,"key=")?u=e.replace(/\+/g,"%20").substring("key=".length):_.startsWith(e,"etag=")&&(a=decodeURIComponent(e.substring("etag=".length)))});if(!s||!u){window.clientReporting.fault("upload:missingBucketKey",{location:t}),r.reject();return}a||window.clientReporting.fault("upload:missingEtag",{location:t});var f=o(e.action);r.resolve({templateUrl:"https://"+f+"/"+s+"/"+u,templateEtag:a})}catch(l){window.clientReporting.fault("upload:caughtException",{location:t,exception:l}),r.reject()}};i.unbind("load",u),i.on("load",u);var a="https://"+window.location.host+"/cloudformation/designer/service/upload/uploadSuccess",f=this.$el.find("#uploadForm");return f.attr("action",e.action),f.find("#policy").val(e.policy),f.find("#key").val(s),f.find("#success_action_redirect").val(a),f.find("#x-amz-signature").val(e.signature),f.find("#x-amz-date").val(e.date),f.find("#x-amz-algorithm").val(e.algorithm),f.find("#x-amz-credential").val(e.credential),f.find("#x-amz-security-token").val(e.securityToken),f.find("#file").val(t),f.appendTo("body"),f.submit(),r.promise()}})}),define("utils/S3File",["Constants","services/LocalizationService","services/ComposerService","services/UploadService","views/UploadS3View"],function(e,t,n,r,i){return{loadCFTfromURL:function(r){n.loadTemplateFromS3Url(r).fail(function(n){$.Topic(e.Topics.Composer.Ready).publish(t.localize("load_cft_error")+": "+r),$.Topic(e.Topics.Composer.Events.Error).publish(t.localize("file_open_error")+": "+n.message)}).done(function(t){$.Topic(e.Topics.Composer.ClearCurrent).publish(),$.Topic(e.Topics.Composer.LoadFileAndVis).publish("file","template1",t),$.Topic(e.Topics.Composer.File.UpdateFileName).publish("template1"),$.Topic(e.Topics.Composer.Editor.ClearAnnotations).publish()})},loadCFTforStack:function(r){n.getTemplateForStack(r).fail(function(n){$.Topic(e.Topics.Composer.Ready).publish(t.localize("load_cft_error")+": "+r),$.Topic(e.Topics.Composer.Events.Error).publish(t.localize("file_open_error")+": "+n.message)}).done(function(t){$.Topic(e.Topics.Composer.ClearEvents).publish(),$.Topic(e.Topics.Composer.LoadFileAndVis).publish("file","template1",t.templateBody),$.Topic(e.Topics.Composer.File.UpdateFileName).publish("template1"),$.Topic(e.Topics.Composer.Editor.ClearAnnotations).publish()})},saveCFT:function(t,n){var s=$.Deferred();return t+=Math.random().toString(36).substring(2),r.getUploadParameters().fail(function(t){$.Topic(e.Topics.Composer.Events.Error).publish(t.message),s.reject(t)}).done(function(e){var r=new i;r.submit(e,n,t,s)}),s.promise()},loadTemplates:function(t){n.loadS3Templates(t).fail(function(t){$.Topic(e.Topics.Composer.Events.Error).publish(t.message)}).done(function(t){$.Topic(e.Topics.Composer.Vis.ShowList).publish(t)})},launchCFT:function(r,i){$.Topic(e.Topics.Composer.Busy).publish(t.localize("launching_cft"));var s,o=this.saveCFT(r,i);o.fail(function(){$.Topic(e.Topics.Composer.Ready).publish(t.localize("cft_upload_error"))}).done(function(r){s=r.templateUrl,n.validateTemplate(s).done(function(){$.Topic(e.Topics.Composer.Ready).publish(t.localize("redirect_to_aws")),n.redirectToCloudFormation(r)}).fail(function(n){alert("Template is not valid: "+n.message),$.Topic(e.Topics.Composer.Ready).publish(t.localize("cft_upload_error"))})})},validateCFT:function(r,i){r="designer/"+r,$.Topic(e.Topics.Composer.Busy).publish(t.localize("validating_cft"));var s,o=this.saveCFT(r,i);o.fail(function(){$.Topic(e.Topics.Composer.Ready).publish(t.localize("cft_upload_error"))}).done(function(r){s=r.templateUrl,n.validateTemplate(s).done(function(){$.Topic(e.Topics.Composer.Ready).publish(t.localize("valid_cft")),$.Topic(e.Topics.Composer.ClearEvents).publish()}).fail(function(n){$.Topic(e.Topics.Composer.Ready).publish(t.localize("invalid_cft")),$.Topic(e.Topics.Composer.Events.Error).publish(t.localize("invalid_cft")+": "+n.message)})})},getSampleTemplates:function(){return n.getSampleTemplates()}}}),define("models/S3TemplateListModel",[],function(){var e=Backbone.Model.extend({defaults:{token:"",position:0,listView:undefined},setToken:function(e){this.set("token",e)},getToken:function(){return this.get("token")},setPosition:function(e){this.set("position",e)},getPosition:function(){return this.get("position")},setListView:function(e){this.set("listView",e)},getListView:function(){return this.get("listView")}});return new e}),define("views/ListView",["Constants","utils/S3File","utils/LocalFile","services/LocalizationService","models/S3TemplateListModel"],function(e,t,n,r,i){return Backbone.View.extend({id:"s3TemplateList",className:"",template:$("#s3ListTemplate").html(),events:{'keyup [id="s3-select-filter"]':"filterTemplateUrl"},initialize:function(){_.bindAll(this,"render"),n.init(),$.Topic(e.Topics.Composer.Vis.ShowList).subscribe(this.showList)},render:function(){return this.$el.html(this.template),i.setListView(this),this},showS3Template:function(){this.$el.find("#div-select").removeClass("hidden"),this.$el.find("#loadingS3TemplateList").removeClass("conceal"),i.setToken(""),t.loadTemplates("")},loadMoreWithFilter:function(){this.$el.find("#s3file-select td:last").hasClass("btn")&&this.$el.find("#s3file-select td:last").addClass("conceal");var e=this.$el.find("#s3file-select");i.setPosition(e.scrollTop()),t.loadTemplates(i.getToken())},filterTemplateUrl:function(){var e=this.$el.find("#s3-select-filter").val();e===""?this.$el.find("#s3file-select td:last").hasClass("btn")&&this.$el.find("#s3file-select td:last").addClass("conceal"):this.$el.find("#s3file-select td:last").removeClass("conceal"),this.$el.find("#s3file-select td").filter(function(){if($(this).html().indexOf(e)!==-1&&!$(this).hasClass("btn"))return this}).removeClass("hidden"),this.$el.find("#s3file-select td").filter(function(){if($(this).html().indexOf(e)===-1&&!$(this).hasClass("btn"))return this}).addClass("hidden")},showList:function(e){var n=i.getListView(),s=e[e.length-1].key,o="",u=document.createElement("tbody"),a=_.escape(e[e.length-1].bucketName);for(var f=0;f<e.length-1;f++){var l=document.createElement("td");l.className="list-group-item td-item",l.title=e[f].templateUrl,l.textContent=_.escape(e[f].key),u.appendChild(l)}e.length>1&&(o=e[e.length-2].key),i.setToken(o);var c=document.createElement("td");c.className="list-group-item search-button btn btn-link conceal",c.textContent=r.localize("search_button"),u.appendChild(c),n.$el.find("#s3file-select").children("td").length===0&&(n.$el.find("#s3ListHeaderBucket").text(a),n.$el.find("#loadingS3TemplateList").addClass("conceal"),n.$el.find("#showS3TemplateList").removeClass("conceal")),n.$el.find("#s3file-select td:last").remove(),n.$el.find("#s3file-select").append(u.children),n.$el.find("#s3file-select").scrollTop(i.getPosition()-1),n.$el.find("#s3file-select").scrollTop(i.getPosition()),i.getListView().filterTemplateUrl(),$(function(){n.$el.find(".list-group-item").on("click",function(){n.$el.find(".td-select").removeClass("td-select"),$(this).addClass("td-select")}),n.$el.find("#s3file-select td:last").on("click",function(){n.$el.find("#s3file-select").off("scroll"),i.getListView().loadMoreWithFilter(o),$(this).off("click")});if(s==="false"){n.$el.find("#s3file-select td:last").hasClass("btn")&&n.$el.find("#s3file-select td:last").remove(),n.$el.find("#s3file-select").off("scroll");return}n.$el.find("#s3file-select").scroll(function(){var e=n.$el.find("#s3file-select");Math.ceil(e.scrollTop()+e.innerHeight())===e[0].scrollHeight&&n.$el.find("#s3-select-filter").val()===""&&(t.loadTemplates(o),i.setPosition(e.scrollTop()),e.off("scroll"))})})}})}),define("views/FileHandler",["Constants","views/Editor","utils/LocalFile","utils/S3File","views/ListView","services/LocalizationService","models/S3TemplateListModel"],function(e,t,n,r,i,s,o){var u="new.template";return Backbone.View.extend({id:"filetime",className:"modal fade",template:$("#fileHandlerTemplate").html(),events:{'click button[data-location="local"][data-action="open"]':"browseLocalFiles",'click button[data-location="local"][data-action="save"]':"showLocalSaveDetails",'click button[data-action="saveToLocalFile"]':"saveToLocal",'click button[data-location="S3"][data-action="open"]':"browseS3Bucket",'click button[data-action="openS3File"]':"openS3File",'click button[data-action="openSampleTemplate"]':"openSampleTemplate",'click button[data-location="S3"][data-action="save"]':"showS3SaveDetails","click .s3Save":"refreshVis",'click button[data-action="saveToS3File"]':"saveToS3","click .sampleBrowser a":"selectTemplate",'change input[type="radio"][name="method"]':"checkedChange"},initialize:function(){_.bindAll(this,"render","showOpenModal","showSaveModal","hideModal","showError","enterEventListenerForSave","enterEventListenerForOpen","removeEnterEventListener","saveToS3","saveToLocal","showSampleTemplatesModal");var n=this;this.setFileName(u),this.listView=new i,$.Topic(e.Topics.Composer.File.New).subscribe(function(){$.Topic(e.Topics.Composer.ClearCurrent).publish(),n.setFileName(u)}),$.Topic(e.Topics.Composer.File.Open).subscribe(this.showOpenModal),$.Topic(e.Topics.Composer.File.Save).subscribe(this.showSaveModal),$.Topic(e.Topics.Composer.File.SampleTemplates).subscribe(this.showSampleTemplatesModal),$.Topic(e.Topics.Composer.LoadFileAndVis).subscribe(this.hideModal),$.Topic(e.Topics.Composer.Events.Error).subscribe(this.showError),$.Topic(e.Topics.Composer.File.UpdateFileName).subscribe(function(e){n.workingFileName=e}),$.Topic(e.Topics.Composer.CFT.Launch).subscribe(function(){r.launchCFT(n.getFileName(),t.getEditorContents()),window.AWSC.Clog.log(e.Metrics.CreateStack,1,document.body.getAttribute("data-aws-account-id"))}),$.Topic(e.Topics.Composer.CFT.Validate).subscribe(function(){r.validateCFT(n.getFileName(),t.getEditorContents())})},render:function(){this.$el.html(this.template),this.$el.modal({show:!1}),this.$el.find("#div-listView").append(this.listView.render().el);var e=this.getUrlParam();return _.isEmpty(e)||(e[0].toLowerCase()==="templateurl"?r.loadCFTfromURL(decodeURIComponent(e[1])):e[0].toLowerCase()==="stackid"&&r.loadCFTforStack(decodeURIComponent(e[1]))),this},getUrlParam:function(){var e=window.location.search.substr(1).split("&"),t,n;for(n=0;n<e.length;n++){var r=e[n],i=r.split("=");if(i[0].toLowerCase()==="templateurl"||i[0].toLowerCase()==="stackid"){t=i;break}}return t},setFileName:function(t){this.workingFileName=t,$.Topic(e.Topics.Composer.File.UpdateFileName).publish(this.workingFileName)},getFileName:function(){return this.workingFileName},hideModal:function(e){var t=this,n=e?e:0;_.delay(function(){t.$el.modal("hide"),t.removeEnterEventListener()},n)},enterEventListenerForSave:function(){var t=this;this.$("#saveName").on("keydown",function(n){n.keyCode===e.ENTER&&(n.preventDefault(),t.$("button[data-location='local']").hasClass("active")?t.saveToLocal():t.$("button[data-location='S3']").hasClass("active")&&t.saveToS3())})},enterEventListenerForOpen:function(){var e=this;this.$("#templateUrl").on("keydown",function(t){t.keyCode===13&&(t.preventDefault(),e.openS3File())})},removeEnterEventListener:function(){this.$("#saveName").off("keydown"),this.$("#templateUrl").off("keydown")},resetModal:function(){var e=this.$el.find("#s3file-select"),t=this.$el.find("#templateUrl"),n=this.$el.find("#modal-submit");this.$el.find(".fileLocation button").removeClass("active"),this.$el.find("#saveName").val(this.getFileName()),this.$el.find(".saveFile,.s3Browser,.userMessage,.sampleBrowser").addClass("conceal"),n.attr("data-action","").addClass("disabled"),this.$el.find(".fileLocation").removeClass("conceal"),n.removeClass("hidden"),this.$el.find("#modal-cancel").removeClass("hidden"),this.$el.find("#modal-ok").addClass("hidden"),this.$el.find("#div-select").addClass("hidden"),e.html(""),e.off("scroll"),this.$el.find("#loadingS3TemplateList").addClass("conceal"),this.$el.find("#showS3TemplateList").addClass("conceal"),t.val(""),this.$el.find("#s3-select-filter").val(""),this.$el.find("#radioUrl").prop("checked",!0),t.prop("disabled",!1),o.setToken(""),o.setPosition(0)},showOpenModal:function(){this.resetModal(),this.$el.find(".modal-title").text(s.localize("open_cloud_formation_template")),this.$el.find(".fileLocation button").attr("data-action","open"),this.$el.find("#modal-submit").text(s.localize("open_file")),this.$("#fileDialogWarning").removeClass("conceal"),this.$el.find('[i18n="local_file"]').text(s.localize("local_file")),this.$el.find('[i18n="s3_bucket"]').text(s.localize("s3_bucket")),this.$el.find('[i18n="open_file_warning"]').text(s.localize("open_file_warning")),this.enterEventListenerForOpen(),this.$el.modal("show")},showSampleTemplatesModal:function(){var e=this.$el.find("#modal-submit");this.resetModal(),this.$el.find(".modal-title").text(s.localize("sample_cloud_formation_template")),this.$el.find(".fileLocation").addClass("conceal"),e.text(s.localize("open_file")),this.$("#fileDialogWarning").removeClass("conceal"),e.attr("data-action","openSampleTemplate"),this.$el.modal("show"),this.loadSampleTemplates()},showSaveModal:function(){this.resetModal(),this.$el.find(".modal-title").text(s.localize("save_cloud_formation_template")),this.$el.find(".fileLocation button").attr("data-action","save"),this.$el.find("#modal-submit").text(s.localize("save_file")).addClass("disabled"),this.$("#fileDialogWarning").addClass("conceal"),this.$el.find('[i18n="local_file"]').text(s.localize("local_file")),this.$el.find('[i18n="s3_bucket"]').text(s.localize("s3_bucket")),this.$el.find('[i18n="name"]').text(s.localize("name")),this.$el.modal("show")},browseLocalFiles:function(t){this.resetModal(),$(t.target).addClass("active"),window.AWSC.Clog.log(e.Metrics.OpenLocalFile,1,document.body.getAttribute("data-aws-account-id")),n.openFile(),this.resetModal()},showLocalSaveDetails:function(e){this.resetModal(),$(e.target).addClass("active"),this.$el.find(".saveFile").removeClass("conceal"),this.$el.find("#modal-submit").attr("data-action","saveToLocalFile").removeClass("disabled"),this.$("#saveName").focus(),this.enterEventListenerForSave()},saveToLocal:function(){var r=this.$el.find("#saveName").val(),i=t.getEditorContents();window.AWSC.Clog.log(e.Metrics.SaveToLocal,1,document.body.getAttribute("data-aws-account-id")),n.exportFile(r,i),this.removeEnterEventListener(),this.hideModal()},browseS3Bucket:function(e){this.resetModal(),$(e.target).addClass("active"),this.loadS3FileList(),this.$el.find("#modal-submit").attr("data-action","openS3File")},checkedChange:function(){this.$el.find('input[type="radio"][name="method"]:checked').val()==="list"?this.$el.find("#s3file-select").children("td").length===0?(this.$el.find("#s3-select-filter").prop("disabled",!1),this.$el.find("#templateUrl").prop("disabled",!0),o.getListView().showS3Template(),this.enableList(!0)):this.enableList(!1):this.enableURL()},enableURL:function(){var e=this.$el.find(".list-group-item");this.$el.find("#s3-select-filter").prop("disabled",!0),this.$el.find("#templateUrl").prop("disabled",!1),e.addClass("td-disabled"),e.off("click"),this.$el.find("#s3file-select").addClass("tbody-disabled"),this.$el.find("#s3file-select td:last").removeClass("btn-link")},enableList:function(e){var t=this.$el.find("#s3file-select td:last");this.$el.find("#templateUrl").prop("disabled",!0),this.$el.find(".list-group-item ").removeClass("td-disabled"),this.$el.find("#s3-select-filter").prop("disabled",!1),this.$el.find("#s3file-select").removeClass("tbody-disabled"),t.hasClass("btn")&&(t.addClass("btn-link"),e||t.on("click",function(){o.getListView().loadMoreWithFilter(),this.off("click")})),this.$el.find(".td-item").on("click",function(){o.getListView().$el.find(".td-select").removeClass("td-select"),$(this).addClass("td-select")})},loadS3FileList:function(){var e=this.$el.find(".s3Browser");this.$el.find("#modal-submit").removeClass("disabled"),e.removeClass("conceal")},openTemplateUrl:function(t){r.loadCFTfromURL(t),$.Topic(e.Topics.Composer.File.Loading).publish();var n=this.$el.find(".userMessage");n.removeClass("conceal").html('<hr /><div class="alert alert-info" role="alert"><i class="fa fa-spinner fa-spin"></i> '+s.localize("opening_file")+": "+_.escape(t)+".</div>")},openS3File:function(){var t="";this.$el.find('input[type="radio"][name="method"]:checked').val()==="list"?t=this.$el.find(".td-select").attr("title"):t=this.$el.find("#templateUrl").val(),t&&t.length>0&&(this.openTemplateUrl(encodeURIComponent(t)),window.AWSC.Clog.log(e.Metrics.OpenS3File,1,document.body.getAttribute("data-aws-account-id")))},showS3SaveDetails:function(e){this.resetModal(),$(e.target).addClass("active"),this.$el.find(".saveFile").removeClass("conceal"),this.$el.find("#modal-submit").attr("data-action","saveToS3File").removeClass("disabled"),this.$("#saveName").focus(),this.enterEventListenerForSave()},saveToS3:function(){var n=this.$el.find("#saveName").val(),i=t.getEditorContents(),o=this,u=this.$el.find(".userMessage");u.removeClass("conceal");if(_.isEmpty(n)===!1){var a=r.saveCFT(n,i);u.html('<hr /><div class="alert alert-info" role="alert"><i class="fa fa-spinner fa-spin"></i> '+s.localize("saving_file")+": "+_.escape(n)+"</div>"),a.done(function(t){u.html('<hr /><div class="alert alert-success" role="alert">'+s.localize("successfully_saved")+"<p>"+_.escape(t.templateUrl)+"</p>"+"</div>"),o.removeEnterEventListener(),o.$el.find("#modal-submit").addClass("hidden"),o.$el.find("#modal-cancel").addClass("hidden"),o.$el.find("#modal-ok").removeClass("hidden"),window.AWSC.Clog.log(e.Metrics.SaveToS3,1,document.body.getAttribute("data-aws-account-id"))})}else u.html('<hr /><div class="alert alert-danger" role="alert">'+s.localize("enter_name")+"</div>")},showError:function(e){if(!_.isEmpty(e)){var t=this.$el.find(".userMessage");t.removeClass("conceal").html('<hr /><div class="alert alert-danger" role="alert">'+_.escape(e)+"</div>")}},selectTemplate:function(e){this.$el.find(".sampleBrowser a").removeClass("active"),$(e.target).addClass("active"),this.$el.find("#modal-submit").removeClass("disabled")},openSampleTemplate:function(){var t=this.$el.find(".sampleBrowser a.active").attr("data-s3FileKey");window.AWSC.Clog.log(e.Metrics.OpenSampleTemplate,1,document.body.getAttribute("data-aws-account-id")),this.openTemplateUrl(t)},loadSampleTemplates:function(){var t=this.$el.find(".sampleBrowser"),n=this.$el.find(".userMessage");n.removeClass("conceal").html('<hr /><div class="alert alert-info" role="alert"><i class="fa fa-spinner fa-spin"></i> '+s.localize("fetching_files")+"</div>");var i=r.getSampleTemplates();i.done(function(e){var r='<hr/><div class="list-group" id="sampleTemplatesList" style="max-height: 420px; overflow-y:scroll; padding-right:3px;">';_.each(e,function(e){_.forEach(e.templates,function(e){r+='<a href="#" class="list-group-item" title="'+e.detailDescription+'" data-s3FileKey="'+e.templateURL+'">'+_.escape(e.name)+"</a>"})}),r+="</div>",t.removeClass("conceal").html(r),n.addClass("conceal")}).fail(function(t){$.Topic(e.Topics.Composer.Events.Error).publish(s.localize("sample_template_error")+": "+t.message)})}})}),define("views/UserMessage",["Constants","services/LocalizationService"],function(e,t){return Backbone.View.extend({id:"usermessage",className:"modal fade",template:$("#userMessageTemplate").html(),events:{"click .modal-footer button":"hideModal"},initialize:function(){_.bindAll(this,"render","showMessageModal","hideModal"),$.Topic(e.Topics.Composer.Message).subscribe(this.showMessageModal)},render:function(){return this.$el.html(this.template),this.$el.modal({show:!1}),this},hideModal:function(e){var t=this,n=e?e:0;_.delay(function(){t.$el.modal("hide")},n)},showMessageModal:function(e,n){this.$el.find(".modal-title").text(e),this.$el.find(".modal-body p").text(n),this.$el.find(".modal-footer button").text(t.localize("ok")),this.$el.modal("show")}})}),define("views/Composer",["views/Splitter","views/Menu","views/FileHandler","views/UserMessage","services/LocalizationService","Constants"],function(e,t,n,r,i,s){return Backbone.View.extend({id:"composer",initialize:function(){_.bindAll(this,"render")},render:function(){return $("#contentSection").prepend(t.$el),this.$el.append(e.$el),t.render(),e.render(),this.fh=new n,this.fh.render(),this.um=new r,this.um.render(),window.ie9Mode&&$.Topic(s.Topics.Composer.Message).publish(i.localize("ie_warning_title"),i.localize("ie_warning_message")),this}})});var getJsFile=function(e){return e.substr(0,e.lastIndexOf("."))},textPath=getJsFile(document.getElementById("textJs-endpoint").href),jsonPath=getJsFile(document.getElementById("jsonJs-endpoint").href),resourceSpecPath=document.getElementById("resourcespec-endpoint").href,relationshipSpecPath=document.getElementById("relationshipspec-endpoint").href,resourceSpecification,relationshipTypesMap;require.config({}),require.config({baseUrl:"js",paths:{text:textPath,json:jsonPath},waitSeconds:0}),fetchResourceSpecification(),define("Main",function(){});